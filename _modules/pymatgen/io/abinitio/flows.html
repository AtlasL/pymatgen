<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>pymatgen.io.abinitio.flows &mdash; pymatgen 3.2.1 documentation</title>
    
    <link rel="stylesheet" href="../../../../_static/proBlue.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../../',
        VERSION:     '3.2.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="shortcut icon" href="../../../../_static/favicon.ico"/>
    <link rel="top" title="pymatgen 3.2.1 documentation" href="../../../../index.html" />
    <link rel="up" title="Module code" href="../../../index.html" />
 
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-33990148-1']);
  _gaq.push(['_trackPageview']);
</script>

  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../index.html">pymatgen 3.2.1 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for pymatgen.io.abinitio.flows</h1><div class="highlight"><pre>
<span class="c"># coding: utf-8</span>
<span class="c"># Copyright (c) Pymatgen Development Team.</span>
<span class="c"># Distributed under the terms of the MIT License.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">A Flow is a container for Works, and works consist of tasks.</span>
<span class="sd">Flows are the final objects that can be dumped directly to a pickle file on disk</span>
<span class="sd">Flows are executed using abirun (abipy).</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">unicode_literals</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">copy</span>

<span class="kn">from</span> <span class="nn">pprint</span> <span class="kn">import</span> <span class="n">pprint</span>
<span class="kn">from</span> <span class="nn">six.moves</span> <span class="kn">import</span> <span class="nb">map</span>
<span class="kn">from</span> <span class="nn">atomicfile</span> <span class="kn">import</span> <span class="n">AtomicFile</span>
<span class="kn">from</span> <span class="nn">prettytable</span> <span class="kn">import</span> <span class="n">PrettyTable</span>
<span class="kn">from</span> <span class="nn">monty.collections</span> <span class="kn">import</span> <span class="n">as_set</span>
<span class="kn">from</span> <span class="nn">monty.io</span> <span class="kn">import</span> <span class="n">FileLock</span>
<span class="kn">from</span> <span class="nn">monty.pprint</span> <span class="kn">import</span> <span class="n">draw_tree</span>
<span class="kn">from</span> <span class="nn">monty.termcolor</span> <span class="kn">import</span> <span class="n">stream_has_colours</span><span class="p">,</span> <span class="n">cprint</span><span class="p">,</span> <span class="n">colored</span><span class="p">,</span> <span class="n">cprint_map</span>
<span class="kn">from</span> <span class="nn">pymatgen.serializers.pickle_coders</span> <span class="kn">import</span> <span class="n">pmg_pickle_load</span><span class="p">,</span> <span class="n">pmg_pickle_dump</span> 
<span class="kn">from</span> <span class="nn">.tasks</span> <span class="kn">import</span> <span class="p">(</span><span class="n">Dependency</span><span class="p">,</span> <span class="n">Status</span><span class="p">,</span> <span class="n">Node</span><span class="p">,</span> <span class="n">NodeResults</span><span class="p">,</span> <span class="n">Task</span><span class="p">,</span> <span class="n">ScfTask</span><span class="p">,</span> <span class="n">PhononTask</span><span class="p">,</span> <span class="n">TaskManager</span><span class="p">,</span> <span class="n">NscfTask</span><span class="p">,</span> <span class="n">DdkTask</span><span class="p">,</span>
                    <span class="n">AnaddbTask</span><span class="p">,</span> <span class="n">DdeTask</span><span class="p">,</span> <span class="n">TaskManager</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">Directory</span><span class="p">,</span> <span class="n">Editor</span>
<span class="kn">from</span> <span class="nn">.abiinspect</span> <span class="kn">import</span> <span class="n">yaml_read_irred_perts</span>
<span class="kn">from</span> <span class="nn">.works</span> <span class="kn">import</span> <span class="n">Work</span><span class="p">,</span> <span class="n">BandStructureWork</span><span class="p">,</span> <span class="n">PhononWork</span><span class="p">,</span> <span class="n">G0W0Work</span><span class="p">,</span> <span class="n">QptdmWork</span>
<span class="kn">from</span> <span class="nn">.events</span> <span class="kn">import</span> <span class="n">EventsParser</span>
<span class="kn">from</span> <span class="nn">pydispatch</span> <span class="kn">import</span> <span class="n">dispatcher</span>
<span class="kn">import</span> <span class="nn">logging</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

<span class="n">__author__</span> <span class="o">=</span> <span class="s">&quot;Matteo Giantomassi&quot;</span>
<span class="n">__copyright__</span> <span class="o">=</span> <span class="s">&quot;Copyright 2013, The Materials Project&quot;</span>
<span class="n">__version__</span> <span class="o">=</span> <span class="s">&quot;0.1&quot;</span>
<span class="n">__maintainer__</span> <span class="o">=</span> <span class="s">&quot;Matteo Giantomassi&quot;</span>


<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s">&quot;Flow&quot;</span><span class="p">,</span>
    <span class="s">&quot;G0W0WithQptdmFlow&quot;</span><span class="p">,</span>
    <span class="s">&quot;bandstructure_flow&quot;</span><span class="p">,</span>
    <span class="s">&quot;g0w0_flow&quot;</span><span class="p">,</span>
    <span class="s">&quot;phonon_flow&quot;</span><span class="p">,</span>
<span class="p">]</span>


<span class="k">class</span> <span class="nc">FlowResults</span><span class="p">(</span><span class="n">NodeResults</span><span class="p">):</span>

    <span class="n">JSON_SCHEMA</span> <span class="o">=</span> <span class="n">NodeResults</span><span class="o">.</span><span class="n">JSON_SCHEMA</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="c">#JSON_SCHEMA[&quot;properties&quot;] = {</span>
    <span class="c">#    &quot;queries&quot;: {&quot;type&quot;: &quot;string&quot;, &quot;required&quot;: True},</span>
    <span class="c">#}</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_node</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">flow</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize an instance from a Work instance.&quot;&quot;&quot;</span>
        <span class="n">new</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">FlowResults</span><span class="p">,</span> <span class="n">cls</span><span class="p">)</span><span class="o">.</span><span class="n">from_node</span><span class="p">(</span><span class="n">flow</span><span class="p">)</span>

        <span class="c">#new.update(</span>
        <span class="c">#    #input=flow.strategy</span>
        <span class="c">#)</span>

        <span class="c"># Will put all files found in outdir in GridFs</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">f</span><span class="p">):</span> <span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">flow</span><span class="o">.</span><span class="n">outdir</span><span class="o">.</span><span class="n">list_filepaths</span><span class="p">()}</span>

        <span class="c"># Add the pickle file.</span>
        <span class="n">pickle_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">flow</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="n">flow</span><span class="o">.</span><span class="n">PICKLE_FNAME</span><span class="p">)</span>
        <span class="n">d</span><span class="p">[</span><span class="s">&quot;pickle&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pickle_path</span> <span class="k">if</span> <span class="n">flow</span><span class="o">.</span><span class="n">pickle_protocol</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="p">(</span><span class="n">pickle_path</span><span class="p">,</span> <span class="s">&quot;t&quot;</span><span class="p">)</span>
        <span class="n">new</span><span class="o">.</span><span class="n">add_gridfs_files</span><span class="p">(</span><span class="o">**</span><span class="n">d</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">new</span>


<div class="viewcode-block" id="Flow"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.flows.Flow">[docs]</a><span class="k">class</span> <span class="nc">Flow</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This object is a container of work. Its main task is managing the</span>
<span class="sd">    possible inter-depedencies among the work and the creation of</span>
<span class="sd">    dynamic workflows that are generated by callbacks registered by the user.</span>

<span class="sd">    .. attributes::</span>

<span class="sd">        creation_date: String with the creation_date</span>
<span class="sd">        pickle_protocol: Protocol for Pickle database (default: -1 i.e. latest protocol)</span>

<span class="sd">    Important methods for constructing flows:</span>

<span class="sd">    .. methods::</span>

<span class="sd">        register_work: register (add) a work to the flow</span>
<span class="sd">        resister_task: register a work that contains only this task returns the work</span>
<span class="sd">        allocate: propagate the workdir and manager of the flow to all the registered tasks</span>
<span class="sd">        build:</span>
<span class="sd">        build_and_pickle_dump:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">VERSION</span> <span class="o">=</span> <span class="s">&quot;0.1&quot;</span>
    <span class="n">PICKLE_FNAME</span> <span class="o">=</span> <span class="s">&quot;__AbinitFlow__.pickle&quot;</span>

    <span class="n">Results</span> <span class="o">=</span> <span class="n">FlowResults</span>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="Flow.from_inputs"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.flows.Flow.from_inputs">[docs]</a>    <span class="k">def</span> <span class="nf">from_inputs</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">workdir</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">pickle_protocol</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">task_class</span><span class="o">=</span><span class="n">ScfTask</span><span class="p">,</span> <span class="n">work_class</span><span class="o">=</span><span class="n">Work</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Construct a simple flow from a list of inputs. The flow contains a single Work with</span>
<span class="sd">        tasks whose class is given by task_class.</span>

<span class="sd">        .. warning::</span>
<span class="sd">            Don&#39;t use this interface if you have a dependencies among the tasks</span>

<span class="sd">        Args:</span>
<span class="sd">            workdir: String specifying the directory where the works will be produced.</span>
<span class="sd">            inputs: List of inputs.</span>
<span class="sd">            manager: :class:`TaskManager` object responsible for the submission of the jobs.</span>
<span class="sd">                If manager is None, the object is initialized from the yaml file</span>
<span class="sd">                located either in the working directory or in the user configuration dir.</span>
<span class="sd">            pickle_procol: Pickle protocol version used for saving the status of the object.</span>
<span class="sd">                -1 denotes the latest version supported by the python interpreter.</span>
<span class="sd">            task_class: The class of the :class:`Task`.</span>
<span class="sd">            work_class: The class of the :class:`Work`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span> <span class="n">inputs</span> <span class="o">=</span> <span class="p">[</span><span class="n">inputs</span><span class="p">]</span>

        <span class="n">flow</span> <span class="o">=</span> <span class="n">cls</span><span class="p">(</span><span class="n">workdir</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="n">manager</span><span class="p">,</span> <span class="n">pickle_protocol</span><span class="o">=</span><span class="n">pickle_protocol</span><span class="p">)</span>
        <span class="n">work</span> <span class="o">=</span> <span class="n">work_class</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">inp</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
            <span class="n">work</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">task_class</span><span class="o">=</span><span class="n">task_class</span><span class="p">)</span>
        <span class="n">flow</span><span class="o">.</span><span class="n">register_work</span><span class="p">(</span><span class="n">work</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">flow</span><span class="o">.</span><span class="n">allocate</span><span class="p">()</span>
</div>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">workdir</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">pickle_protocol</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            workdir: String specifying the directory where the works will be produced.</span>
<span class="sd">            manager: :class:`TaskManager` object responsible for the submission of the jobs.</span>
<span class="sd">                     If manager is None, the object is initialized from the yaml file</span>
<span class="sd">                     located either in the working directory or in the user configuration dir.</span>
<span class="sd">            pickle_procol: Pickle protocol version used for saving the status of the object.</span>
<span class="sd">                          -1 denotes the latest version supported by the python interpreter.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Flow</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_workdir</span><span class="p">(</span><span class="n">workdir</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">creation_date</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">asctime</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">manager</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="n">manager</span> <span class="o">=</span> <span class="n">TaskManager</span><span class="o">.</span><span class="n">from_user_config</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">manager</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">()</span>

        <span class="c"># List of works.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_works</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_waited</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c"># List of callbacks that must be executed when the dependencies reach S_OK</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_callbacks</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pickle_protocol</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">pickle_protocol</span><span class="p">)</span>

        <span class="c"># ID used to access mongodb</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mongo_id</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="c"># TODO</span>
        <span class="c"># Signal slots: a dictionary with the list</span>
        <span class="c"># of callbacks indexed by node_id and SIGNAL_TYPE.</span>
        <span class="c"># When the node changes its status, it broadcast a signal.</span>
        <span class="c"># The flow is listening to all the nodes of the calculation</span>
        <span class="c"># [node_id][SIGNAL] = list_of_signal_handlers</span>
        <span class="c">#self._sig_slots =  slots = {}</span>
        <span class="c">#for work in self:</span>
        <span class="c">#    slots[work] = {s: [] for s in work.S_ALL}</span>

        <span class="c">#for task in self.iflat_tasks():</span>
        <span class="c">#    slots[task] = {s: [] for s in work.S_ALL}</span>

<div class="viewcode-block" id="Flow.as_dict"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.flows.Flow.as_dict">[docs]</a>    <span class="k">def</span> <span class="nf">as_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        JSON serialization, note that we only need to save</span>
<span class="sd">        a string with the working directory since the object will be</span>
<span class="sd">        reconstructed from the pickle file located in workdir</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span><span class="s">&quot;workdir&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">}</span>

    <span class="c"># This is needed for fireworks.</span></div>
    <span class="n">to_dict</span> <span class="o">=</span> <span class="n">as_dict</span>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="Flow.from_dict"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.flows.Flow.from_dict">[docs]</a>    <span class="k">def</span> <span class="nf">from_dict</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reconstruct the flow from the pickle file.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">cls</span><span class="o">.</span><span class="n">pickle_load</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s">&quot;workdir&quot;</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Flow.set_workdir"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.flows.Flow.set_workdir">[docs]</a>    <span class="k">def</span> <span class="nf">set_workdir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">workdir</span><span class="p">,</span> <span class="n">chroot</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the working directory. Cannot be set more than once unless chroot is True</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">chroot</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&quot;workdir&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">workdir</span> <span class="o">!=</span> <span class="n">workdir</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;self.workdir != workdir: </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span>  <span class="n">workdir</span><span class="p">))</span>

        <span class="c"># Directories with (input|output|temporary) data.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">workdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">workdir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indir</span> <span class="o">=</span> <span class="n">Directory</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="s">&quot;indata&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outdir</span> <span class="o">=</span> <span class="n">Directory</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="s">&quot;outdata&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmpdir</span> <span class="o">=</span> <span class="n">Directory</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="s">&quot;tmpdata&quot;</span><span class="p">))</span>
</div>
    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="Flow.pickle_load"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.flows.Flow.pickle_load">[docs]</a>    <span class="k">def</span> <span class="nf">pickle_load</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">filepath</span><span class="p">,</span> <span class="n">disable_signals</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">remove_lock</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Loads the object from a pickle file and performs initial setup.</span>

<span class="sd">        Args:</span>
<span class="sd">            filepath: Filename or directory name. It filepath is a directory, we</span>
<span class="sd">                scan the directory tree starting from filepath and we</span>
<span class="sd">                read the first pickle database. Raise RuntimeError if multiple</span>
<span class="sd">                databases are found.</span>
<span class="sd">            disable_signals: If True, the nodes of the flow are not connected by signals.</span>
<span class="sd">                This option is usually used when we want to read a flow</span>
<span class="sd">                in read-only mode and we want to avoid any possible side effect.</span>
<span class="sd">            remove_lock:</span>
<span class="sd">                True to remove the file lock if any (use it carefully).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
            <span class="c"># Walk through each directory inside path and find the pickle database.</span>
            <span class="k">for</span> <span class="n">dirpath</span><span class="p">,</span> <span class="n">dirnames</span><span class="p">,</span> <span class="n">filenames</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
                <span class="n">fnames</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">filenames</span> <span class="k">if</span> <span class="n">f</span> <span class="o">==</span> <span class="n">cls</span><span class="o">.</span><span class="n">PICKLE_FNAME</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">fnames</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fnames</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirpath</span><span class="p">,</span> <span class="n">fnames</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="k">break</span>  <span class="c"># Exit os.walk</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">err_msg</span> <span class="o">=</span> <span class="s">&quot;Found multiple databases:</span><span class="se">\n</span><span class="s"> </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">fnames</span><span class="p">)</span>
                        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">err_msg</span> <span class="o">=</span> <span class="s">&quot;Cannot find </span><span class="si">%s</span><span class="s"> inside directory </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cls</span><span class="o">.</span><span class="n">PICKLE_FNAME</span><span class="p">,</span> <span class="n">filepath</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">remove_lock</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filepath</span> <span class="o">+</span> <span class="s">&quot;.lock&quot;</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span> 
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">filepath</span> <span class="o">+</span> <span class="s">&quot;.lock&quot;</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="k">with</span> <span class="n">FileLock</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
                <span class="n">flow</span> <span class="o">=</span> <span class="n">pmg_pickle_load</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span>

        <span class="c"># Check if versions match.</span>
        <span class="k">if</span> <span class="n">flow</span><span class="o">.</span><span class="n">VERSION</span> <span class="o">!=</span> <span class="n">cls</span><span class="o">.</span><span class="n">VERSION</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;File flow version </span><span class="si">%s</span><span class="s"> != latest version </span><span class="si">%s</span><span class="se">\n</span><span class="s">.&quot;</span>
                   <span class="s">&quot;Regenerate the flow to solve the problem &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">flow</span><span class="o">.</span><span class="n">VERSION</span><span class="p">,</span> <span class="n">cls</span><span class="o">.</span><span class="n">VERSION</span><span class="p">))</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">disable_signals</span><span class="p">:</span>
            <span class="n">flow</span><span class="o">.</span><span class="n">connect_signals</span><span class="p">()</span>

        <span class="c"># Recompute the status of each task since tasks that</span>
        <span class="c"># have been submitted previously might be completed.</span>
        <span class="n">flow</span><span class="o">.</span><span class="n">check_status</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">flow</span>
</div>
    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">works</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">works</span><span class="o">.</span><span class="n">__iter__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">works</span><span class="p">[</span><span class="nb">slice</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">mongo_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mongo_id</span>

    <span class="nd">@mongo_id.setter</span>
    <span class="k">def</span> <span class="nf">mongo_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mongo_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&quot;Cannot change mongo_id </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">mongo_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mongo_id</span> <span class="o">=</span> <span class="n">value</span>

<div class="viewcode-block" id="Flow.validate_json_schema"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.flows.Flow.validate_json_schema">[docs]</a>    <span class="k">def</span> <span class="nf">validate_json_schema</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Validate the JSON schema. Return list of errors.&quot;&quot;&quot;</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">work</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">work</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">task</span><span class="o">.</span><span class="n">get_results</span><span class="p">()</span><span class="o">.</span><span class="n">validate_json_schema</span><span class="p">():</span>
                    <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">work</span><span class="o">.</span><span class="n">get_results</span><span class="p">()</span><span class="o">.</span><span class="n">validate_json_schema</span><span class="p">():</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">work</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_results</span><span class="p">()</span><span class="o">.</span><span class="n">validate_json_schema</span><span class="p">():</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">errors</span>
</div>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">works</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;List of :class:`Work` objects contained in self..&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_works</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">all_ok</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;True if all the tasks in works have reached `S_OK`.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="n">work</span><span class="o">.</span><span class="n">all_ok</span> <span class="k">for</span> <span class="n">work</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">all_tasks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">iflat_tasks</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">num_tasks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Total number of tasks&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iflat_tasks</span><span class="p">()))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">errored_tasks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;List of errored tasks.&quot;&quot;&quot;</span>
        <span class="n">errtasks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">status</span> <span class="ow">in</span> <span class="p">[</span><span class="n">Task</span><span class="o">.</span><span class="n">S_ERROR</span><span class="p">,</span> <span class="n">Task</span><span class="o">.</span><span class="n">S_QCRITICAL</span><span class="p">,</span> <span class="n">Task</span><span class="o">.</span><span class="n">S_ABICRITICAL</span><span class="p">]:</span>
            <span class="n">errtasks</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iflat_tasks</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="p">)))</span>

        <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="n">errtasks</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">num_errored_tasks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The number of tasks whose status is `S_ERROR`.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">errored_tasks</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">unconverged_tasks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;List of unconverged tasks.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iflat_tasks</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">S_UNCONVERGED</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">num_unconverged_tasks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The number of tasks whose status is `S_UNCONVERGED`.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unconverged_tasks</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">status_counter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a `Counter` object that counts the number of tasks with</span>
<span class="sd">        given status (use the string representation of the status as key).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Count the number of tasks with given status in each work.</span>
        <span class="n">counter</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">status_counter</span>
        <span class="k">for</span> <span class="n">work</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="n">counter</span> <span class="o">+=</span> <span class="n">work</span><span class="o">.</span><span class="n">status_counter</span>

        <span class="k">return</span> <span class="n">counter</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ncores_reserved</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the number of cores reserved in this moment.</span>
<span class="sd">        A core is reserved if the task is not running but</span>
<span class="sd">        we have submitted the task to the queue manager.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">work</span><span class="o">.</span><span class="n">ncores_reserved</span> <span class="k">for</span> <span class="n">work</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ncores_allocated</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the number of cores allocated in this moment.</span>
<span class="sd">        A core is allocated if it&#39;s running a task or if we have</span>
<span class="sd">        submitted a task to the queue manager but the job is still pending.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">work</span><span class="o">.</span><span class="n">ncores_allocated</span> <span class="k">for</span> <span class="n">work</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ncores_inuse</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the number of cores used in this moment.</span>
<span class="sd">        A core is used if there&#39;s a job that is running on it.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">work</span><span class="o">.</span><span class="n">ncores_inuse</span> <span class="k">for</span> <span class="n">work</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">has_chrooted</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a string that evaluates to True if we have changed</span>
<span class="sd">        the workdir for visualization purposes e.g. we are using sshfs.</span>
<span class="sd">        to mount the remote directory where the `Flow` is located.</span>
<span class="sd">        The string gives the previous workdir of the flow.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_chrooted_from</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&quot;&quot;</span>

<div class="viewcode-block" id="Flow.chroot"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.flows.Flow.chroot">[docs]</a>    <span class="k">def</span> <span class="nf">chroot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_workdir</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Change the workir of the :class:`Flow`. Mainly used for</span>
<span class="sd">        allowing the user to open the GUI on the local host</span>
<span class="sd">        and access the flow from remote via sshfs.</span>

<span class="sd">        .. note::</span>
<span class="sd">            Calling this method will make the flow go in read-only mode.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_chrooted_from</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">workdir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_workdir</span><span class="p">(</span><span class="n">new_workdir</span><span class="p">,</span> <span class="n">chroot</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">work</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">new_wdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="s">&quot;w&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
            <span class="n">work</span><span class="o">.</span><span class="n">chroot</span><span class="p">(</span><span class="n">new_wdir</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Flow.groupby_status"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.flows.Flow.groupby_status">[docs]</a>    <span class="k">def</span> <span class="nf">groupby_status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a ordered dictionary mapping the task status to</span>
<span class="sd">        the list of named tuples (task, work_index, task_index).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Entry</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">namedtuple</span><span class="p">(</span><span class="s">&quot;Entry&quot;</span><span class="p">,</span> <span class="s">&quot;task wi ti&quot;</span><span class="p">)</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">task</span><span class="p">,</span> <span class="n">wi</span><span class="p">,</span> <span class="n">ti</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iflat_tasks_wti</span><span class="p">():</span>
            <span class="n">d</span><span class="p">[</span><span class="n">task</span><span class="o">.</span><span class="n">status</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Entry</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">wi</span><span class="p">,</span> <span class="n">ti</span><span class="p">))</span>

        <span class="c"># Sort keys according to their status.</span>
        <span class="k">return</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">([(</span><span class="n">k</span><span class="p">,</span> <span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">keys</span><span class="p">()))])</span>
</div>
<div class="viewcode-block" id="Flow.iflat_tasks_wti"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.flows.Flow.iflat_tasks_wti">[docs]</a>    <span class="k">def</span> <span class="nf">iflat_tasks_wti</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">op</span><span class="o">=</span><span class="s">&quot;==&quot;</span><span class="p">,</span> <span class="n">nids</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generator to iterate over all the tasks of the `Flow`.</span>
<span class="sd">        Yields:</span>

<span class="sd">            (task, work_index, task_index)</span>

<span class="sd">        If status is not None, only the tasks whose status satisfies</span>
<span class="sd">        the condition (task.status op status) are selected</span>
<span class="sd">        status can be either one of the flags defined in the :class:`Task` class</span>
<span class="sd">        (e.g Task.S_OK) or a string e.g &quot;S_OK&quot;</span>
<span class="sd">        nids is an optional list of node identifiers used to filter the tasks.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iflat_tasks_wti</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="p">,</span> <span class="n">op</span><span class="o">=</span><span class="n">op</span><span class="p">,</span> <span class="n">nids</span><span class="o">=</span><span class="n">nids</span><span class="p">,</span> <span class="n">with_wti</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Flow.iflat_tasks"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.flows.Flow.iflat_tasks">[docs]</a>    <span class="k">def</span> <span class="nf">iflat_tasks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">op</span><span class="o">=</span><span class="s">&quot;==&quot;</span><span class="p">,</span> <span class="n">nids</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generator to iterate over all the tasks of the :class:`Flow`.</span>

<span class="sd">        If status is not None, only the tasks whose status satisfies</span>
<span class="sd">        the condition (task.status op status) are selected</span>
<span class="sd">        status can be either one of the flags defined in the :class:`Task` class</span>
<span class="sd">        (e.g Task.S_OK) or a string e.g &quot;S_OK&quot;</span>
<span class="sd">        nids is an optional list of node identifiers used to filter the tasks.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iflat_tasks_wti</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="p">,</span> <span class="n">op</span><span class="o">=</span><span class="n">op</span><span class="p">,</span> <span class="n">nids</span><span class="o">=</span><span class="n">nids</span><span class="p">,</span> <span class="n">with_wti</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_iflat_tasks_wti</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">op</span><span class="o">=</span><span class="s">&quot;==&quot;</span><span class="p">,</span> <span class="n">nids</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">with_wti</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generators that produces a flat sequence of task.</span>
<span class="sd">        if status is not None, only the tasks with the specified status are selected.</span>
<span class="sd">        nids is an optional list of node identifiers used to filter the tasks.</span>

<span class="sd">        Returns:</span>
<span class="sd">            (task, work_index, task_index) if with_wti is True else task</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nids</span> <span class="o">=</span> <span class="n">as_set</span><span class="p">(</span><span class="n">nids</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">status</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">wi</span><span class="p">,</span> <span class="n">work</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">ti</span><span class="p">,</span> <span class="n">task</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">work</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">nids</span> <span class="ow">and</span> <span class="n">task</span><span class="o">.</span><span class="n">node_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">nids</span><span class="p">:</span> <span class="k">continue</span>
                    <span class="k">if</span> <span class="n">with_wti</span><span class="p">:</span>
                        <span class="k">yield</span> <span class="n">task</span><span class="p">,</span> <span class="n">wi</span><span class="p">,</span> <span class="n">ti</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">yield</span> <span class="n">task</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c"># Get the operator from the string.</span>
            <span class="kn">import</span> <span class="nn">operator</span>
            <span class="n">op</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s">&quot;==&quot;</span><span class="p">:</span> <span class="n">operator</span><span class="o">.</span><span class="n">eq</span><span class="p">,</span>
                <span class="s">&quot;!=&quot;</span><span class="p">:</span> <span class="n">operator</span><span class="o">.</span><span class="n">ne</span><span class="p">,</span>
                <span class="s">&quot;&gt;&quot;</span><span class="p">:</span> <span class="n">operator</span><span class="o">.</span><span class="n">gt</span><span class="p">,</span>
                <span class="s">&quot;&gt;=&quot;</span><span class="p">:</span> <span class="n">operator</span><span class="o">.</span><span class="n">ge</span><span class="p">,</span>
                <span class="s">&quot;&lt;&quot;</span><span class="p">:</span> <span class="n">operator</span><span class="o">.</span><span class="n">lt</span><span class="p">,</span>
                <span class="s">&quot;&lt;=&quot;</span><span class="p">:</span> <span class="n">operator</span><span class="o">.</span><span class="n">le</span><span class="p">,</span>
            <span class="p">}[</span><span class="n">op</span><span class="p">]</span>

            <span class="c"># Accept Task.S_FLAG or string.</span>
            <span class="n">status</span> <span class="o">=</span> <span class="n">Status</span><span class="o">.</span><span class="n">as_status</span><span class="p">(</span><span class="n">status</span><span class="p">)</span>
            <span class="c">#print(status)</span>

            <span class="k">for</span> <span class="n">wi</span><span class="p">,</span> <span class="n">work</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">ti</span><span class="p">,</span> <span class="n">task</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">work</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">nids</span> <span class="ow">and</span> <span class="n">task</span><span class="o">.</span><span class="n">node_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">nids</span><span class="p">:</span> <span class="k">continue</span>
                    <span class="k">if</span> <span class="n">op</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="n">status</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">with_wti</span><span class="p">:</span>
                            <span class="k">yield</span> <span class="n">task</span><span class="p">,</span> <span class="n">wi</span><span class="p">,</span> <span class="n">ti</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">yield</span> <span class="n">task</span>

<div class="viewcode-block" id="Flow.check_dependencies"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.flows.Flow.check_dependencies">[docs]</a>    <span class="k">def</span> <span class="nf">check_dependencies</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Test the dependencies of the nodes for possible deadlocks.&quot;&quot;&quot;</span>
        <span class="n">deadlocks</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_tasks</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">task</span><span class="o">.</span><span class="n">deps</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">dep</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">depends_on</span><span class="p">(</span><span class="n">task</span><span class="p">):</span>
                    <span class="n">deadlocks</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">task</span><span class="p">,</span> <span class="n">dep</span><span class="o">.</span><span class="n">node</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">deadlocks</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;Detect wrong list of dependecies that will lead to a deadlock:&quot;</span><span class="p">]</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> &lt;--&gt; </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">nodes</span> <span class="k">for</span> <span class="n">nodes</span> <span class="ow">in</span> <span class="n">deadlocks</span><span class="p">])</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="Flow.deadlocked_runnables_running"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.flows.Flow.deadlocked_runnables_running">[docs]</a>    <span class="k">def</span> <span class="nf">deadlocked_runnables_running</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function detects deadlocks</span>
<span class="sd">        return deadlocks, runnables, running</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">runnables</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">work</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">runnables</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">work</span><span class="o">.</span><span class="n">fetch_alltasks_to_run</span><span class="p">())</span>

        <span class="n">running</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iflat_tasks</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="n">Task</span><span class="o">.</span><span class="n">S_RUN</span><span class="p">))</span>

        <span class="n">err_tasks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">errored_tasks</span>
        <span class="n">deadlocked</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">err_tasks</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_tasks</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">depends_on</span><span class="p">(</span><span class="n">err_task</span><span class="p">)</span> <span class="k">for</span> <span class="n">err_task</span> <span class="ow">in</span> <span class="n">err_tasks</span><span class="p">):</span>
                    <span class="n">deadlocked</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">deadlocked</span><span class="p">,</span> <span class="n">runnables</span><span class="p">,</span> <span class="n">running</span>
</div>
<div class="viewcode-block" id="Flow.check_status"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.flows.Flow.check_status">[docs]</a>    <span class="k">def</span> <span class="nf">check_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check the status of the works in self.</span>

<span class="sd">        Args:</span>
<span class="sd">            show: True to show the status of the flow.</span>
<span class="sd">            kwargs: keyword arguments passed to show_status</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">work</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">work</span><span class="o">.</span><span class="n">check_status</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;show&quot;</span><span class="p">,</span> <span class="bp">False</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">show_status</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="c">#def set_status(self, status):</span>
</div>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The status of the :class:`Flow` i.e. the minimum of the status of its tasks and its works&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">work</span><span class="o">.</span><span class="n">get_all_status</span><span class="p">(</span><span class="n">only_min</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="k">for</span> <span class="n">work</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">)</span>

<div class="viewcode-block" id="Flow.fix_abi_critical"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.flows.Flow.fix_abi_critical">[docs]</a>    <span class="k">def</span> <span class="nf">fix_abi_critical</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function tries to fix critical events originating from ABINIT.</span>
<span class="sd">        Returns the number of tasks that have been fixed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iflat_tasks</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">S_ABICRITICAL</span><span class="p">):</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="n">task</span><span class="o">.</span><span class="n">fix_abi_critical</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">count</span>
</div>
<div class="viewcode-block" id="Flow.fix_queue_critical"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.flows.Flow.fix_queue_critical">[docs]</a>    <span class="k">def</span> <span class="nf">fix_queue_critical</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function tries to fix critical events originating from the queue submission system.</span>

<span class="sd">        Returns the number of tasks that have been fixed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iflat_tasks</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">S_QCRITICAL</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Will try to fix task </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">task</span><span class="p">))</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="n">task</span><span class="o">.</span><span class="n">fix_queue_critical</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">count</span>
</div>
<div class="viewcode-block" id="Flow.show_status"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.flows.Flow.show_status">[docs]</a>    <span class="k">def</span> <span class="nf">show_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Report the status of the works and the status  of the different tasks on the specified stream.</span>

<span class="sd">        Args:</span>
<span class="sd">            stream: File-like object, Default: sys.stdout</span>
<span class="sd">            nids:  List of node identifiers. By defaults all nodes are shown</span>
<span class="sd">            wslice: Slice object used to select works.</span>
<span class="sd">            verbose: Verbosity level (default 0). &gt; 0 if to show only the works that are not finalized.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">stream</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;stream&quot;</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
        <span class="n">nids</span> <span class="o">=</span> <span class="n">as_set</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;nids&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">))</span>
        <span class="n">wslice</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;wslice&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">wlist</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">wslice</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c"># Convert range to list of work indices.</span>
            <span class="n">wlist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">wslice</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">wslice</span><span class="o">.</span><span class="n">step</span><span class="p">,</span> <span class="n">wslice</span><span class="o">.</span><span class="n">stop</span><span class="p">))</span>
        <span class="n">verbose</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;verbose&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="c">#has_colours = stream_has_colours(stream)</span>
        <span class="n">has_colours</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">red</span> <span class="o">=</span> <span class="s">&quot;red&quot;</span> <span class="k">if</span> <span class="n">has_colours</span> <span class="k">else</span> <span class="bp">None</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">work</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">stream</span><span class="p">)</span>
            <span class="n">cprint_map</span><span class="p">(</span><span class="s">&quot;Work #</span><span class="si">%d</span><span class="s">: </span><span class="si">%s</span><span class="s">, Finalized=</span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">work</span><span class="p">,</span> <span class="n">work</span><span class="o">.</span><span class="n">finalized</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="p">{</span><span class="s">&quot;True&quot;</span><span class="p">:</span> <span class="s">&quot;green&quot;</span><span class="p">},</span> <span class="nb">file</span><span class="o">=</span><span class="n">stream</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">verbose</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">work</span><span class="o">.</span><span class="n">finalized</span><span class="p">:</span> <span class="k">continue</span>
            <span class="k">if</span> <span class="n">wlist</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">wlist</span><span class="p">:</span> <span class="k">continue</span>

            <span class="n">table</span> <span class="o">=</span> <span class="n">PrettyTable</span><span class="p">([</span><span class="s">&quot;Task&quot;</span><span class="p">,</span> <span class="s">&quot;Status&quot;</span><span class="p">,</span> <span class="s">&quot;Queue&quot;</span><span class="p">,</span> <span class="s">&quot;MPI|Omp|Memproc[Gb]&quot;</span><span class="p">,</span> 
                                 <span class="s">&quot;Err|Warn|Comm&quot;</span><span class="p">,</span> <span class="s">&quot;Class&quot;</span><span class="p">,</span> <span class="s">&quot;Restart|Launches&quot;</span><span class="p">,</span> <span class="s">&quot;Node_ID&quot;</span><span class="p">])</span>

            <span class="n">tot_num_errors</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">work</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">nids</span> <span class="ow">and</span> <span class="n">task</span><span class="o">.</span><span class="n">node_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">nids</span><span class="p">:</span> <span class="k">continue</span>
                <span class="n">task_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

                <span class="c"># Parse the events in the main output.</span>
                <span class="n">report</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">get_event_report</span><span class="p">()</span>

                <span class="n">events</span> <span class="o">=</span> <span class="s">&quot;|&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="p">[</span><span class="s">&quot;NA&quot;</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">report</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">events</span> <span class="o">=</span> <span class="s">&quot;|&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="p">[</span><span class="n">report</span><span class="o">.</span><span class="n">num_errors</span><span class="p">,</span> <span class="n">report</span><span class="o">.</span><span class="n">num_warnings</span><span class="p">,</span> <span class="n">report</span><span class="o">.</span><span class="n">num_comments</span><span class="p">]))</span>

                <span class="n">para_info</span> <span class="o">=</span> <span class="s">&quot;|&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">mpi_procs</span><span class="p">,</span> <span class="n">task</span><span class="o">.</span><span class="n">omp_threads</span><span class="p">,</span> <span class="s">&quot;</span><span class="si">%.1f</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">task</span><span class="o">.</span><span class="n">mem_per_proc</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s">&quot;Gb&quot;</span><span class="p">))))</span>
                <span class="n">task_info</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="p">[</span><span class="n">task</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">num_restarts</span><span class="p">,</span> <span class="n">task</span><span class="o">.</span><span class="n">num_launches</span><span class="p">),</span> <span class="n">task</span><span class="o">.</span><span class="n">node_id</span><span class="p">]))</span>
                <span class="n">qinfo</span> <span class="o">=</span> <span class="s">&quot;None&quot;</span>
                <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">queue_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">qinfo</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">queue_id</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;@&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">qname</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">is_critical</span><span class="p">:</span>
                    <span class="n">tot_num_errors</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">task_name</span> <span class="o">=</span> <span class="n">colored</span><span class="p">(</span><span class="n">task_name</span><span class="p">,</span> <span class="n">red</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">has_colours</span><span class="p">:</span>
                    <span class="n">table</span><span class="o">.</span><span class="n">add_row</span><span class="p">([</span><span class="n">task_name</span><span class="p">,</span> <span class="n">task</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">colored</span><span class="p">,</span> <span class="n">qinfo</span><span class="p">,</span> <span class="n">para_info</span><span class="p">,</span> <span class="n">events</span><span class="p">]</span> <span class="o">+</span> <span class="n">task_info</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">table</span><span class="o">.</span><span class="n">add_row</span><span class="p">([</span><span class="n">task_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">status</span><span class="p">),</span> <span class="n">qinfo</span><span class="p">,</span> <span class="n">events</span><span class="p">,</span> <span class="n">para_info</span><span class="p">]</span> <span class="o">+</span> <span class="n">task_info</span><span class="p">)</span>

            <span class="c"># Print table and write colorized line with the total number of errors.</span>
            <span class="k">print</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">stream</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">tot_num_errors</span><span class="p">:</span>
                <span class="n">cprint</span><span class="p">(</span><span class="s">&quot;Total number of errors: </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">tot_num_errors</span><span class="p">,</span> <span class="n">red</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">stream</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">stream</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_ok</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;all_ok reached&quot;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">stream</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Flow.show_inputs"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.flows.Flow.show_inputs">[docs]</a>    <span class="k">def</span> <span class="nf">show_inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nids</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">wslice</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Print the input of the tasks to the given stream.</span>

<span class="sd">        Args:</span>
<span class="sd">            stream:</span>
<span class="sd">                File-like object, Default: sys.stdout</span>
<span class="sd">            nids: </span>
<span class="sd">                List of node identifiers. By defaults all nodes are shown</span>
<span class="sd">            wslice: Slice object used to select works.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_tasks</span><span class="p">(</span><span class="n">nids</span><span class="o">=</span><span class="n">nids</span><span class="p">,</span> <span class="n">wslice</span><span class="o">=</span><span class="n">wslice</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">make_input</span><span class="p">(</span><span class="n">with_header</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

            <span class="c"># Add info on dependencies.</span>
            <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">deps</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\n\n</span><span class="s">Dependencies:</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dep</span><span class="p">)</span> <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">task</span><span class="o">.</span><span class="n">deps</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\n\n</span><span class="s">Dependencies: None&quot;</span>

            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">+</span> <span class="mi">80</span> <span class="o">*</span> <span class="s">&quot;=&quot;</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">+</span> <span class="n">s</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>

        <span class="n">stream</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Flow.select_tasks"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.flows.Flow.select_tasks">[docs]</a>    <span class="k">def</span> <span class="nf">select_tasks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nids</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">wslice</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a list with a subset of tasks.</span>

<span class="sd">        Args:</span>
<span class="sd">            nids: List of node identifiers.</span>
<span class="sd">            wslice: Slice object used to select works.</span>

<span class="sd">        .. note::</span>

<span class="sd">            nids and wslice are mutually exclusive.</span>
<span class="sd">            If no argument is provided, the full list of tasks is returned.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">nids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">wslice</span> <span class="ow">is</span> <span class="bp">None</span>
            <span class="n">tasks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks_from_nids</span><span class="p">(</span><span class="n">nids</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">wslice</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">tasks</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">work</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span><span class="n">wslice</span><span class="p">]:</span>
                <span class="n">tasks</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">work</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># All tasks selected if no option is provided.</span>
            <span class="n">tasks</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iflat_tasks</span><span class="p">())</span>

        <span class="k">return</span> <span class="n">tasks</span>
</div>
<div class="viewcode-block" id="Flow.inspect"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.flows.Flow.inspect">[docs]</a>    <span class="k">def</span> <span class="nf">inspect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nids</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">wslice</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Inspect the tasks (SCF iterations, Structural relaxation ...) and </span>
<span class="sd">        produces matplotlib plots.</span>

<span class="sd">        Args:</span>
<span class="sd">            nids: List of node identifiers.</span>
<span class="sd">            wslice: Slice object used to select works.</span>
<span class="sd">            kwargs: keyword arguments passed to `task.inspect` method.</span>

<span class="sd">        .. note::</span>

<span class="sd">            nids and wslice ae mutually exclusive. </span>
<span class="sd">            iIf nids and wslice are both None, all tasks in self are inspected.</span>

<span class="sd">        Returns: </span>
<span class="sd">            list of `matplotlib figures.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">figs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_tasks</span><span class="p">(</span><span class="n">nids</span><span class="o">=</span><span class="n">nids</span><span class="p">,</span> <span class="n">wslice</span><span class="o">=</span><span class="n">wslice</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="s">&quot;inspect&quot;</span><span class="p">):</span>
                <span class="n">fig</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">inspect</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">fig</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> 
                    <span class="n">cprint</span><span class="p">(</span><span class="s">&quot;Cannot inspect Task </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">task</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">&quot;blue&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">figs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cprint</span><span class="p">(</span><span class="s">&quot;Task </span><span class="si">%s</span><span class="s"> does not provide an inspect method&quot;</span> <span class="o">%</span> <span class="n">task</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">&quot;blue&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">figs</span>
</div>
<div class="viewcode-block" id="Flow.get_results"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.flows.Flow.get_results">[docs]</a>    <span class="k">def</span> <span class="nf">get_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">from_node</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">results</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_dict_for_mongodb_queries</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">results</span>
</div>
<div class="viewcode-block" id="Flow.get_dict_for_mongodb_queries"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.flows.Flow.get_dict_for_mongodb_queries">[docs]</a>    <span class="k">def</span> <span class="nf">get_dict_for_mongodb_queries</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function returns a dictionary with the attributes that will be</span>
<span class="sd">        put in the mongodb document to facilitate the query.</span>
<span class="sd">        Subclasses may want to replace or extend the default behaviour.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">return</span> <span class="n">d</span>
        <span class="c"># TODO</span>
        <span class="n">all_structures</span> <span class="o">=</span> <span class="p">[</span><span class="n">task</span><span class="o">.</span><span class="n">strategy</span><span class="o">.</span><span class="n">structure</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iflat_tasks</span><span class="p">()]</span>
        <span class="n">all_pseudos</span> <span class="o">=</span> <span class="p">[</span><span class="n">task</span><span class="o">.</span><span class="n">strategy</span><span class="o">.</span><span class="n">pseudos</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iflat_tasks</span><span class="p">()]</span>
</div>
<div class="viewcode-block" id="Flow.look_before_you_leap"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.flows.Flow.look_before_you_leap">[docs]</a>    <span class="k">def</span> <span class="nf">look_before_you_leap</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method should be called before running the calculation to make</span>
<span class="sd">        sure that the most important requirements are satisfied.</span>

<span class="sd">        Return:</span>
<span class="sd">            List of strings with inconsistencies/errors.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_dependencies</span><span class="p">()</span>
        <span class="k">except</span> <span class="bp">self</span><span class="o">.</span><span class="n">Error</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_db</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">db_connector</span><span class="o">.</span><span class="n">get_collection</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">                    ERROR while trying to connect to the MongoDB database:</span>
<span class="s">                        Exception:</span>
<span class="s">                            </span><span class="si">%s</span><span class="s"></span>
<span class="s">                        Connector:</span>
<span class="s">                            </span><span class="si">%s</span><span class="s"></span>
<span class="s">                    &quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">db_connector</span><span class="p">))</span>

        <span class="k">return</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span>
</div>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">has_db</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;True if flow uses `MongoDB` to store the results.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">has_db</span>

<div class="viewcode-block" id="Flow.db_insert"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.flows.Flow.db_insert">[docs]</a>    <span class="k">def</span> <span class="nf">db_insert</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Insert results in the `MongDB` database.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_db</span>
        <span class="c"># Connect to MongoDb and get the collection.</span>
        <span class="n">coll</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">db_connector</span><span class="o">.</span><span class="n">get_collection</span><span class="p">()</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;Mongodb collection </span><span class="si">%s</span><span class="s"> with count </span><span class="si">%d</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">coll</span><span class="p">,</span> <span class="n">coll</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>

        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">work</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">work</span><span class="p">:</span>
                <span class="n">results</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">get_results</span><span class="p">()</span>
                <span class="n">pprint</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
                <span class="n">results</span><span class="o">.</span><span class="n">update_collection</span><span class="p">(</span><span class="n">coll</span><span class="p">)</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">work</span><span class="o">.</span><span class="n">get_results</span><span class="p">()</span>
            <span class="n">pprint</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
            <span class="n">results</span><span class="o">.</span><span class="n">update_collection</span><span class="p">(</span><span class="n">coll</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;MongoDb update done in </span><span class="si">%s</span><span class="s"> [s]&quot;</span> <span class="o">%</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span>

        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_results</span><span class="p">()</span>
        <span class="n">pprint</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
        <span class="n">results</span><span class="o">.</span><span class="n">update_collection</span><span class="p">(</span><span class="n">coll</span><span class="p">)</span>

        <span class="c"># Update the pickle file to save the mongo ids.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pickle_dump</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">coll</span><span class="o">.</span><span class="n">find</span><span class="p">():</span>
            <span class="n">pprint</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Flow.tasks_from_nids"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.flows.Flow.tasks_from_nids">[docs]</a>    <span class="k">def</span> <span class="nf">tasks_from_nids</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nids</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the list of tasks associated to the given list of node identifiers (nids).</span>

<span class="sd">        .. note::</span>

<span class="sd">            Invalid ids are ignored</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">nids</span><span class="p">,</span> <span class="n">collections</span><span class="o">.</span><span class="n">Iterable</span><span class="p">):</span> <span class="n">nids</span> <span class="o">=</span> <span class="p">[</span><span class="n">nids</span><span class="p">]</span>

        <span class="n">tasks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">nid</span> <span class="ow">in</span> <span class="n">nids</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iflat_tasks</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">node_id</span> <span class="o">==</span> <span class="n">nid</span><span class="p">:</span>
                    <span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
                    <span class="k">break</span>

        <span class="k">return</span> <span class="n">tasks</span>
</div>
<div class="viewcode-block" id="Flow.wti_from_nids"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.flows.Flow.wti_from_nids">[docs]</a>    <span class="k">def</span> <span class="nf">wti_from_nids</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nids</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the list of (w, t) indices from the list of node identifiers nids.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">task</span><span class="o">.</span><span class="n">pos</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks_from_nids</span><span class="p">(</span><span class="n">nids</span><span class="p">)]</span>
</div>
<div class="viewcode-block" id="Flow.open_files"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.flows.Flow.open_files">[docs]</a>    <span class="k">def</span> <span class="nf">open_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">what</span><span class="o">=</span><span class="s">&quot;o&quot;</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">op</span><span class="o">=</span><span class="s">&quot;==&quot;</span><span class="p">,</span> <span class="n">nids</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">editor</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Open the files of the flow inside an editor (command line interface).</span>

<span class="sd">        Args:</span>
<span class="sd">            what: string with the list of characters selecting the file type</span>
<span class="sd">                  Possible choices:</span>
<span class="sd">                    i ==&gt; input_file,</span>
<span class="sd">                    o ==&gt; output_file,</span>
<span class="sd">                    f ==&gt; files_file,</span>
<span class="sd">                    j ==&gt; job_file,</span>
<span class="sd">                    l ==&gt; log_file,</span>
<span class="sd">                    e ==&gt; stderr_file,</span>
<span class="sd">                    q ==&gt; qout_file,</span>
<span class="sd">            status: if not None, only the tasks with this status are select</span>
<span class="sd">            op: status operator. Requires status. A task is selected</span>
<span class="sd">                if task.status op status evaluates to true.</span>
<span class="sd">            nids: optional list of node identifiers used to filter the tasks.</span>
<span class="sd">            editor: Select the editor. None to use the default editor ($EDITOR shell env var)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">get_files</span><span class="p">(</span><span class="n">task</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Helper function used to select the files of a task.&quot;&quot;&quot;</span>
            <span class="n">choices</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s">&quot;i&quot;</span><span class="p">:</span> <span class="n">task</span><span class="o">.</span><span class="n">input_file</span><span class="p">,</span>
                <span class="s">&quot;o&quot;</span><span class="p">:</span> <span class="n">task</span><span class="o">.</span><span class="n">output_file</span><span class="p">,</span>
                <span class="s">&quot;f&quot;</span><span class="p">:</span> <span class="n">task</span><span class="o">.</span><span class="n">files_file</span><span class="p">,</span>
                <span class="s">&quot;j&quot;</span><span class="p">:</span> <span class="n">task</span><span class="o">.</span><span class="n">job_file</span><span class="p">,</span>
                <span class="s">&quot;l&quot;</span><span class="p">:</span> <span class="n">task</span><span class="o">.</span><span class="n">log_file</span><span class="p">,</span>
                <span class="s">&quot;e&quot;</span><span class="p">:</span> <span class="n">task</span><span class="o">.</span><span class="n">stderr_file</span><span class="p">,</span>
                <span class="s">&quot;q&quot;</span><span class="p">:</span> <span class="n">task</span><span class="o">.</span><span class="n">qout_file</span><span class="p">,</span>
            <span class="p">}</span>

            <span class="n">selected</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">what</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">selected</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">choices</span><span class="p">[</span><span class="n">c</span><span class="p">],</span> <span class="s">&quot;path&quot;</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;Wrong keyword </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">c</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">selected</span>

        <span class="c"># Build list of files to analyze.</span>
        <span class="n">files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iflat_tasks</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="p">,</span> <span class="n">op</span><span class="o">=</span><span class="n">op</span><span class="p">,</span> <span class="n">nids</span><span class="o">=</span><span class="n">nids</span><span class="p">):</span>
            <span class="n">lst</span> <span class="o">=</span> <span class="n">get_files</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">lst</span><span class="p">:</span>
                <span class="n">files</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">lst</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">Editor</span><span class="p">(</span><span class="n">editor</span><span class="o">=</span><span class="n">editor</span><span class="p">)</span><span class="o">.</span><span class="n">edit_files</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Flow.show_abierrors"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.flows.Flow.show_abierrors">[docs]</a>    <span class="k">def</span> <span class="nf">show_abierrors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nids</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write to the given stream the list of ABINIT errors for all tasks whose status is S_ABICRITICAL.</span>

<span class="sd">        Args:</span>
<span class="sd">            nids: optional list of node identifiers used to filter the tasks.</span>
<span class="sd">            stream: File-like object. Default: sys.stdout</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">app</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">append</span>

        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iflat_tasks</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">S_ABICRITICAL</span><span class="p">,</span> <span class="n">nids</span><span class="o">=</span><span class="n">nids</span><span class="p">):</span>
            <span class="n">header</span> <span class="o">=</span> <span class="s">&quot;=== &quot;</span> <span class="o">+</span> <span class="n">task</span><span class="o">.</span><span class="n">qout_file</span><span class="o">.</span><span class="n">path</span> <span class="o">+</span> <span class="s">&quot;===&quot;</span>
            <span class="n">app</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
            <span class="n">report</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">get_event_report</span><span class="p">()</span>

            <span class="n">app</span><span class="p">(</span><span class="s">&quot;num_errors: </span><span class="si">%s</span><span class="s">, num_warnings: </span><span class="si">%s</span><span class="s">, num_comments: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">report</span><span class="o">.</span><span class="n">num_errors</span><span class="p">,</span> <span class="n">report</span><span class="o">.</span><span class="n">num_warnings</span><span class="p">,</span> <span class="n">report</span><span class="o">.</span><span class="n">num_comments</span><span class="p">))</span>

            <span class="n">app</span><span class="p">(</span><span class="s">&quot;*** ERRORS ***&quot;</span><span class="p">)</span>
            <span class="n">app</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">report</span><span class="o">.</span><span class="n">errors</span><span class="p">))</span>

            <span class="n">app</span><span class="p">(</span><span class="s">&quot;*** BUGS ***&quot;</span><span class="p">)</span>
            <span class="n">app</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">report</span><span class="o">.</span><span class="n">bugs</span><span class="p">))</span>

            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;=&quot;</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">header</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">stream</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Flow.show_qouts"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.flows.Flow.show_qouts">[docs]</a>    <span class="k">def</span> <span class="nf">show_qouts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nids</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write to the given stream the content of the queue output file for all tasks whose status is S_QCRITICAL.</span>

<span class="sd">        Args:</span>
<span class="sd">            nids: optional list of node identifiers used to filter the tasks.</span>
<span class="sd">            stream: File-like object. Default: sys.stdout</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iflat_tasks</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">S_QCRITICAL</span><span class="p">,</span> <span class="n">nids</span><span class="o">=</span><span class="n">nids</span><span class="p">):</span>
            <span class="n">header</span> <span class="o">=</span> <span class="s">&quot;=== &quot;</span> <span class="o">+</span> <span class="n">task</span><span class="o">.</span><span class="n">qout_file</span><span class="o">.</span><span class="n">path</span> <span class="o">+</span> <span class="s">&quot;===&quot;</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">qout_file</span><span class="o">.</span><span class="n">exists</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">qout_file</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s">&quot;rt&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
                    <span class="n">lines</span> <span class="o">+=</span> <span class="n">fh</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;File does not exist!&quot;</span><span class="p">)</span>

            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;=&quot;</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">header</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">stream</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Flow.cancel"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.flows.Flow.cancel">[docs]</a>    <span class="k">def</span> <span class="nf">cancel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nids</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Cancel all the tasks that are in the queue.</span>
<span class="sd">        nids is an optional list of node identifiers used to filter the tasks.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Number of jobs cancelled, negative value if error</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_chrooted</span><span class="p">:</span>
            <span class="c"># TODO: Use paramiko to kill the job?</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;Cannot cancel the flow via sshfs!&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>

        <span class="c"># If we are running with the scheduler, we must send a SIGKILL signal.</span>
        <span class="n">pid_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="s">&quot;_PyFlowScheduler.pid&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pid_file</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">pid_file</span><span class="p">,</span> <span class="s">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
                <span class="n">pid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">fh</span><span class="o">.</span><span class="n">readline</span><span class="p">())</span>

            <span class="n">retcode</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&quot;kill -9 </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">pid</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Sent SIGKILL to the scheduler, retcode = </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">retcode</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">pid_file</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="n">num_cancelled</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iflat_tasks</span><span class="p">(</span><span class="n">nids</span><span class="o">=</span><span class="n">nids</span><span class="p">):</span>
            <span class="n">num_cancelled</span> <span class="o">+=</span> <span class="n">task</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">num_cancelled</span>
</div>
<div class="viewcode-block" id="Flow.get_njobs_in_queue"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.flows.Flow.get_njobs_in_queue">[docs]</a>    <span class="k">def</span> <span class="nf">get_njobs_in_queue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        returns the number of jobs in the queue, None when the number of jobs cannot be determined.</span>

<span class="sd">        Args:</span>
<span class="sd">            username: (str) the username of the jobs to count (default is to autodetect)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">qadapter</span><span class="o">.</span><span class="n">get_njobs_in_queue</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Flow.rmtree"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.flows.Flow.rmtree">[docs]</a>    <span class="k">def</span> <span class="nf">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">onerror</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove workdir (same API as shutil.rmtree).&quot;&quot;&quot;</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="n">ignore_errors</span><span class="p">,</span> <span class="n">onerror</span><span class="o">=</span><span class="n">onerror</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Flow.rm_and_build"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.flows.Flow.rm_and_build">[docs]</a>    <span class="k">def</span> <span class="nf">rm_and_build</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove the workdir and rebuild the flow.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rmtree</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">build</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Flow.build"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.flows.Flow.build">[docs]</a>    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Make directories and files of the `Flow`.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indir</span><span class="o">.</span><span class="n">makedirs</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="o">.</span><span class="n">makedirs</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmpdir</span><span class="o">.</span><span class="n">makedirs</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">work</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">work</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Flow.build_and_pickle_dump"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.flows.Flow.build_and_pickle_dump">[docs]</a>    <span class="k">def</span> <span class="nf">build_and_pickle_dump</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build dirs and file of the `Flow` and save the object in pickle format.</span>
<span class="sd">        Returns 0 if success</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">build</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pickle_dump</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Flow.pickle_dump"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.flows.Flow.pickle_dump">[docs]</a>    <span class="k">def</span> <span class="nf">pickle_dump</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save the status of the object in pickle format.</span>
<span class="sd">        Returns 0 if success</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_chrooted</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;Cannot pickle_dump since we have chrooted from </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_chrooted</span><span class="p">)</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>

        <span class="n">protocol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pickle_protocol</span>
        <span class="n">filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">PICKLE_FNAME</span><span class="p">)</span>

        <span class="c"># Atomic transaction with FileLock.</span>
        <span class="k">with</span> <span class="n">FileLock</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">AtomicFile</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
                <span class="n">pmg_pickle_dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">protocol</span><span class="o">=</span><span class="n">protocol</span><span class="p">)</span>

        <span class="k">return</span> <span class="mi">0</span>
</div>
<div class="viewcode-block" id="Flow.register_task"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.flows.Flow.register_task">[docs]</a>    <span class="k">def</span> <span class="nf">register_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">,</span> <span class="n">deps</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">task_class</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Utility function that generates a `Work` made of a single task</span>

<span class="sd">        Args:</span>
<span class="sd">            input: :class:`AbinitInput` or :class:`Strategy` object.</span>
<span class="sd">            deps: List of :class:`Dependency` objects specifying the dependency of this node.</span>
<span class="sd">                  An empy list of deps implies that this node has no dependencies.</span>
<span class="sd">            manager: The :class:`TaskManager` responsible for the submission of the task.</span>
<span class="sd">                     If manager is None, we use the :class:`TaskManager` specified during the creation of the work.</span>
<span class="sd">            task_class: Task subclass to instantiate. Default: :class:`AbinitTask`</span>

<span class="sd">        Returns:</span>
<span class="sd">            The generated :class:`Work` for the task, work[0] is the actual task.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">work</span> <span class="o">=</span> <span class="n">Work</span><span class="p">(</span><span class="n">manager</span><span class="o">=</span><span class="n">manager</span><span class="p">)</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">work</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">deps</span><span class="o">=</span><span class="n">deps</span><span class="p">,</span> <span class="n">task_class</span><span class="o">=</span><span class="n">task_class</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register_work</span><span class="p">(</span><span class="n">work</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">work</span>
</div>
<div class="viewcode-block" id="Flow.register_work"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.flows.Flow.register_work">[docs]</a>    <span class="k">def</span> <span class="nf">register_work</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">work</span><span class="p">,</span> <span class="n">deps</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">workdir</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Register a new :class:`Work` and add it to the internal list, taking into account possible dependencies.</span>

<span class="sd">        Args:</span>
<span class="sd">            work: :class:`Work` object.</span>
<span class="sd">            deps: List of :class:`Dependency` objects specifying the dependency of this node.</span>
<span class="sd">                  An empy list of deps implies that this node has no dependencies.</span>
<span class="sd">            manager: The :class:`TaskManager` responsible for the submission of the task.</span>
<span class="sd">                     If manager is None, we use the `TaskManager` specified during the creation of the work.</span>
<span class="sd">            workdir: The name of the directory used for the :class:`Work`.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The registered :class:`Work`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Directory of the work.</span>
        <span class="k">if</span> <span class="n">workdir</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">work_workdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="s">&quot;w&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">work_workdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">workdir</span><span class="p">))</span>

        <span class="n">work</span><span class="o">.</span><span class="n">set_workdir</span><span class="p">(</span><span class="n">work_workdir</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">manager</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">work</span><span class="o">.</span><span class="n">set_manager</span><span class="p">(</span><span class="n">manager</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">works</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">work</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">deps</span><span class="p">:</span>
            <span class="n">deps</span> <span class="o">=</span> <span class="p">[</span><span class="n">Dependency</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">exts</span><span class="p">)</span> <span class="k">for</span> <span class="n">node</span><span class="p">,</span> <span class="n">exts</span> <span class="ow">in</span> <span class="n">deps</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
            <span class="n">work</span><span class="o">.</span><span class="n">add_deps</span><span class="p">(</span><span class="n">deps</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">work</span>
</div>
<div class="viewcode-block" id="Flow.register_work_from_cbk"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.flows.Flow.register_work_from_cbk">[docs]</a>    <span class="k">def</span> <span class="nf">register_work_from_cbk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cbk_name</span><span class="p">,</span> <span class="n">cbk_data</span><span class="p">,</span> <span class="n">deps</span><span class="p">,</span> <span class="n">work_class</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Registers a callback function that will generate the :class:`Task` of the :class:`Work`.</span>

<span class="sd">        Args:</span>
<span class="sd">            cbk_name: Name of the callback function (must be a bound method of self)</span>
<span class="sd">            cbk_data: Additional data passed to the callback function.</span>
<span class="sd">            deps: List of :class:`Dependency` objects specifying the dependency of the work.</span>
<span class="sd">            work_class: :class:`Work` class to instantiate.</span>
<span class="sd">            manager: The :class:`TaskManager` responsible for the submission of the task.</span>
<span class="sd">                    If manager is None, we use the `TaskManager` specified during the creation of the :class:`Flow`.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The :class:`Work` that will be finalized by the callback.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># TODO: pass a Work factory instead of a class</span>
        <span class="c"># Directory of the Work.</span>
        <span class="n">work_workdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="s">&quot;w&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)))</span>

        <span class="c"># Create an empty work and register the callback</span>
        <span class="n">work</span> <span class="o">=</span> <span class="n">work_class</span><span class="p">(</span><span class="n">workdir</span><span class="o">=</span><span class="n">work_workdir</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="n">manager</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_works</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">work</span><span class="p">)</span>

        <span class="n">deps</span> <span class="o">=</span> <span class="p">[</span><span class="n">Dependency</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">exts</span><span class="p">)</span> <span class="k">for</span> <span class="n">node</span><span class="p">,</span> <span class="n">exts</span> <span class="ow">in</span> <span class="n">deps</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">deps</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;A callback must have deps!&quot;</span><span class="p">)</span>

        <span class="n">work</span><span class="o">.</span><span class="n">add_deps</span><span class="p">(</span><span class="n">deps</span><span class="p">)</span>

        <span class="c"># Wrap the callable in a Callback object and save</span>
        <span class="c"># useful info such as the index of the work and the callback data.</span>
        <span class="n">cbk</span> <span class="o">=</span> <span class="n">FlowCallback</span><span class="p">(</span><span class="n">cbk_name</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">deps</span><span class="o">=</span><span class="n">deps</span><span class="p">,</span> <span class="n">cbk_data</span><span class="o">=</span><span class="n">cbk_data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_callbacks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cbk</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">work</span>
</div>
<div class="viewcode-block" id="Flow.allocate"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.flows.Flow.allocate">[docs]</a>    <span class="k">def</span> <span class="nf">allocate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Allocate the `Flow` i.e. assign the `workdir` and (optionally)</span>
<span class="sd">        the :class:`TaskManager` to the different tasks in the Flow.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">work</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="c"># Each work has a reference to its flow.</span>
            <span class="n">work</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="n">manager</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="p">)</span>
            <span class="n">work</span><span class="o">.</span><span class="n">set_flow</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="c"># Each task has a reference to its work.</span>
            <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">work</span><span class="p">:</span>
                <span class="n">task</span><span class="o">.</span><span class="n">set_work</span><span class="p">(</span><span class="n">work</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">check_dependencies</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span>
</div>
<div class="viewcode-block" id="Flow.show_dependencies"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.flows.Flow.show_dependencies">[docs]</a>    <span class="k">def</span> <span class="nf">show_dependencies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Writes to the given stream the ASCII representation of the dependency tree.&quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">child_iter</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">node</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">deps</span><span class="p">]</span>

        <span class="k">def</span> <span class="nf">text_str</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">colored</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">node</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">color_opts</span><span class="p">[</span><span class="s">&quot;color&quot;</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iflat_tasks</span><span class="p">():</span>
            <span class="k">print</span><span class="p">(</span><span class="n">draw_tree</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">child_iter</span><span class="p">,</span> <span class="n">text_str</span><span class="p">),</span> <span class="nb">file</span><span class="o">=</span><span class="n">stream</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Flow.on_dep_ok"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.flows.Flow.on_dep_ok">[docs]</a>    <span class="k">def</span> <span class="nf">on_dep_ok</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signal</span><span class="p">,</span> <span class="n">sender</span><span class="p">):</span>
        <span class="c"># TODO</span>
        <span class="c"># Replace this callback with dynamic dispatch</span>
        <span class="c"># on_all_S_OK for work</span>
        <span class="c"># on_S_OK for task</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;on_dep_ok with sender </span><span class="si">%s</span><span class="s">, signal </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">sender</span><span class="p">),</span> <span class="n">signal</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">cbk</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_callbacks</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">cbk</span><span class="o">.</span><span class="n">handle_sender</span><span class="p">(</span><span class="n">sender</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> does not handle sender </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cbk</span><span class="p">,</span> <span class="n">sender</span><span class="p">))</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">cbk</span><span class="o">.</span><span class="n">can_execute</span><span class="p">():</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Cannot execute </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">cbk</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c"># Execute the callback and disable it</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;about to execute callback </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">cbk</span><span class="p">))</span>
            <span class="n">cbk</span><span class="p">()</span>
            <span class="n">cbk</span><span class="o">.</span><span class="n">disable</span><span class="p">()</span>

            <span class="c"># Update the database.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pickle_dump</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Flow.finalize"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.flows.Flow.finalize">[docs]</a>    <span class="k">def</span> <span class="nf">finalize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This method is called when the flow is completed.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">finalized</span><span class="p">:</span> <span class="k">return</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">finalized</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="o">.</span><span class="n">has_db</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="o">.</span><span class="n">db_insert</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">finalized</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                 <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s">&quot;MongoDb insertion failed.&quot;</span><span class="p">)</span>
                 <span class="k">return</span> <span class="mi">2</span>
</div>
<div class="viewcode-block" id="Flow.set_cleanup_exts"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.flows.Flow.set_cleanup_exts">[docs]</a>    <span class="k">def</span> <span class="nf">set_cleanup_exts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exts</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">work</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="c"># TODO Add support for Works</span>
            <span class="c">#work.set_cleanup_exts(exts)</span>
            <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">work</span><span class="p">:</span>
                <span class="n">task</span><span class="o">.</span><span class="n">set_cleanup_exts</span><span class="p">(</span><span class="n">exts</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Flow.connect_signals"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.flows.Flow.connect_signals">[docs]</a>    <span class="k">def</span> <span class="nf">connect_signals</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Connect the signals within the work.</span>
<span class="sd">        self is responsible for catching the important signals raised from</span>
<span class="sd">        its task and raise new signals when some particular condition occurs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Connect the signals inside each Work.</span>
        <span class="k">for</span> <span class="n">work</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">work</span><span class="o">.</span><span class="n">connect_signals</span><span class="p">()</span>

        <span class="c"># Observe the nodes that must reach S_OK in order to call the callbacks.</span>
        <span class="k">for</span> <span class="n">cbk</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_callbacks</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">cbk</span><span class="o">.</span><span class="n">deps</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;connecting </span><span class="si">%s</span><span class="s"> </span><span class="se">\n</span><span class="s">with sender </span><span class="si">%s</span><span class="s">, signal </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">cbk</span><span class="p">),</span> <span class="n">dep</span><span class="o">.</span><span class="n">node</span><span class="p">,</span> <span class="n">dep</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">S_OK</span><span class="p">))</span>
                <span class="n">dispatcher</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">on_dep_ok</span><span class="p">,</span> <span class="n">signal</span><span class="o">=</span><span class="n">dep</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">S_OK</span><span class="p">,</span> <span class="n">sender</span><span class="o">=</span><span class="n">dep</span><span class="o">.</span><span class="n">node</span><span class="p">,</span> <span class="n">weak</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

        <span class="c"># Associate to each signal the callback _on_signal</span>
        <span class="c"># (bound method of the node that will be called by `Flow`</span>
        <span class="c"># Each node will set its attribute _done_signal to True to tell</span>
        <span class="c"># the flow that this callback should be disabled.</span>

        <span class="c"># Register the callbacks for the Work.</span>
        <span class="c">#for work in self:</span>
        <span class="c">#    slot = self._sig_slots[work]</span>
        <span class="c">#    for signal in S_ALL:</span>
        <span class="c">#        done_signal = getattr(work, &quot;_done_ &quot; + signal, False)</span>
        <span class="c">#        if not done_sig:</span>
        <span class="c">#            cbk_name = &quot;_on_&quot; + str(signal)</span>
        <span class="c">#            cbk = getattr(work, cbk_name, None)</span>
        <span class="c">#            if cbk is None: continue</span>
        <span class="c">#            slot[work][signal].append(cbk)</span>
        <span class="c">#            print(&quot;connecting %s\nwith sender %s, signal %s&quot; % (str(cbk), dep.node, dep.node.S_OK))</span>
        <span class="c">#            dispatcher.connect(self.on_dep_ok, signal=signal, sender=dep.node, weak=False)</span>

        <span class="c"># Register the callbacks for the Tasks.</span>

        <span class="c">#self.show_receivers()</span>
</div>
<div class="viewcode-block" id="Flow.show_receivers"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.flows.Flow.show_receivers">[docs]</a>    <span class="k">def</span> <span class="nf">show_receivers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sender</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">signal</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">sender</span> <span class="o">=</span> <span class="n">sender</span> <span class="k">if</span> <span class="n">sender</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">dispatcher</span><span class="o">.</span><span class="n">Any</span>
        <span class="n">signal</span> <span class="o">=</span> <span class="n">signal</span> <span class="k">if</span> <span class="n">signal</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">dispatcher</span><span class="o">.</span><span class="n">Any</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;*** live receivers ***&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="n">dispatcher</span><span class="o">.</span><span class="n">liveReceivers</span><span class="p">(</span><span class="n">dispatcher</span><span class="o">.</span><span class="n">getReceivers</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">signal</span><span class="p">)):</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;receiver --&gt;&quot;</span><span class="p">,</span> <span class="n">rec</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;*** end live receivers ***&quot;</span><span class="p">)</span>

    <span class="c">#def get_results(self, **kwargs)</span>
</div>
<div class="viewcode-block" id="Flow.rapidfire"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.flows.Flow.rapidfire">[docs]</a>    <span class="k">def</span> <span class="nf">rapidfire</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">check_status</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Use :class:`PyLauncher` to submits tasks in rapidfire mode.</span>
<span class="sd">        kwargs contains the options passed to the launcher.</span>
<span class="sd">        Return the number of tasks submitted.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">check_status</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_status</span><span class="p">()</span>
        <span class="kn">from</span> <span class="nn">.launcher</span> <span class="kn">import</span> <span class="n">PyLauncher</span>
        <span class="k">return</span> <span class="n">PyLauncher</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span><span class="o">.</span><span class="n">rapidfire</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Flow.make_scheduler"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.flows.Flow.make_scheduler">[docs]</a>    <span class="k">def</span> <span class="nf">make_scheduler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build a return a :class:`PyFlowScheduler` to run the flow.</span>

<span class="sd">        kwargs:</span>
<span class="sd">            if empty we use the user configuration file.</span>
<span class="sd">            if filepath in kwargs we init the scheduler from file.</span>
<span class="sd">            else pass **kwargs to :class:`PyFlowScheduler` __init__ method.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Build dirs and files (if not yet done)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">build</span><span class="p">()</span>

        <span class="kn">from</span> <span class="nn">.launcher</span> <span class="kn">import</span> <span class="n">PyFlowScheduler</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="c"># User config if kwargs is empty</span>
            <span class="n">sched</span> <span class="o">=</span> <span class="n">PyFlowScheduler</span><span class="o">.</span><span class="n">from_user_config</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># Use from_file if filepath if present, else call __init__</span>
            <span class="n">filepath</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;filepath&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">filepath</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">assert</span> <span class="ow">not</span> <span class="n">kwargs</span>
                <span class="n">sched</span> <span class="o">=</span> <span class="n">PyFlowScheduler</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sched</span> <span class="o">=</span> <span class="n">PyFlowScheduler</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">sched</span><span class="o">.</span><span class="n">add_flow</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sched</span>

</div></div>
<div class="viewcode-block" id="G0W0WithQptdmFlow"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.flows.G0W0WithQptdmFlow">[docs]</a><span class="k">class</span> <span class="nc">G0W0WithQptdmFlow</span><span class="p">(</span><span class="n">Flow</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">workdir</span><span class="p">,</span> <span class="n">scf_input</span><span class="p">,</span> <span class="n">nscf_input</span><span class="p">,</span> <span class="n">scr_input</span><span class="p">,</span> <span class="n">sigma_inputs</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build a `Flow` for one-shot G0W0 calculations.</span>
<span class="sd">        The computation of the q-points for the screening is parallelized with qptdm</span>
<span class="sd">        i.e. we run independent calculations for each q-point and then we merge the final results.</span>

<span class="sd">        Args:</span>
<span class="sd">            workdir: Working directory.</span>
<span class="sd">            scf_input: Input for the GS SCF run.</span>
<span class="sd">            nscf_input: Input for the NSCF run (band structure run).</span>
<span class="sd">            scr_input: Input for the SCR run.</span>
<span class="sd">            sigma_inputs: Input(s) for the SIGMA run(s).</span>
<span class="sd">            manager: :class:`TaskManager` object used to submit the jobs</span>
<span class="sd">                     Initialized from manager.yml if manager is None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">G0W0WithQptdmFlow</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">workdir</span><span class="p">,</span> <span class="n">manager</span><span class="p">)</span>

        <span class="c"># Register the first work (GS + NSCF calculation)</span>
        <span class="n">bands_work</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register_work</span><span class="p">(</span><span class="n">BandStructureWork</span><span class="p">(</span><span class="n">scf_input</span><span class="p">,</span> <span class="n">nscf_input</span><span class="p">))</span>

        <span class="c"># Register the callback that will be executed the work for the SCR with qptdm.</span>
        <span class="n">scr_work</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register_work_from_cbk</span><span class="p">(</span><span class="n">cbk_name</span><span class="o">=</span><span class="s">&quot;cbk_qptdm_workflow&quot;</span><span class="p">,</span> <span class="n">cbk_data</span><span class="o">=</span><span class="p">{</span><span class="s">&quot;input&quot;</span><span class="p">:</span> <span class="n">scr_input</span><span class="p">},</span>
                                               <span class="n">deps</span><span class="o">=</span><span class="p">{</span><span class="n">bands_work</span><span class="o">.</span><span class="n">nscf_task</span><span class="p">:</span> <span class="s">&quot;WFK&quot;</span><span class="p">},</span> <span class="n">work_class</span><span class="o">=</span><span class="n">QptdmWork</span><span class="p">)</span>

        <span class="c"># The last work contains a list of SIGMA tasks</span>
        <span class="c"># that will use the data produced in the previous two works.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sigma_inputs</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="n">sigma_inputs</span> <span class="o">=</span> <span class="p">[</span><span class="n">sigma_inputs</span><span class="p">]</span>

        <span class="n">sigma_work</span> <span class="o">=</span> <span class="n">Work</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">sigma_input</span> <span class="ow">in</span> <span class="n">sigma_inputs</span><span class="p">:</span>
            <span class="n">sigma_work</span><span class="o">.</span><span class="n">register_sigma_task</span><span class="p">(</span><span class="n">sigma_input</span><span class="p">,</span> <span class="n">deps</span><span class="o">=</span><span class="p">{</span><span class="n">bands_work</span><span class="o">.</span><span class="n">nscf_task</span><span class="p">:</span> <span class="s">&quot;WFK&quot;</span><span class="p">,</span> <span class="n">scr_work</span><span class="p">:</span> <span class="s">&quot;SCR&quot;</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register_work</span><span class="p">(</span><span class="n">sigma_work</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">allocate</span><span class="p">()</span>

<div class="viewcode-block" id="G0W0WithQptdmFlow.cbk_qptdm_workflow"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.flows.G0W0WithQptdmFlow.cbk_qptdm_workflow">[docs]</a>    <span class="k">def</span> <span class="nf">cbk_qptdm_workflow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cbk</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This callback is executed by the flow when bands_work.nscf_task reaches S_OK.</span>

<span class="sd">        It computes the list of q-points for the W(q,G,G&#39;), creates nqpt tasks</span>
<span class="sd">        in the second work (QptdmWork), and connect the signals.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">scr_input</span> <span class="o">=</span> <span class="n">cbk</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s">&quot;input&quot;</span><span class="p">]</span>
        <span class="c"># Use the WFK file produced by the second</span>
        <span class="c"># Task in the first Work (NSCF step).</span>
        <span class="n">nscf_task</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">wfk_file</span> <span class="o">=</span> <span class="n">nscf_task</span><span class="o">.</span><span class="n">outdir</span><span class="o">.</span><span class="n">has_abiext</span><span class="p">(</span><span class="s">&quot;WFK&quot;</span><span class="p">)</span>

        <span class="n">work</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">work</span><span class="o">.</span><span class="n">set_manager</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="p">)</span>
        <span class="n">work</span><span class="o">.</span><span class="n">create_tasks</span><span class="p">(</span><span class="n">wfk_file</span><span class="p">,</span> <span class="n">scr_input</span><span class="p">)</span>
        <span class="n">work</span><span class="o">.</span><span class="n">add_deps</span><span class="p">(</span><span class="n">cbk</span><span class="o">.</span><span class="n">deps</span><span class="p">)</span>

        <span class="n">work</span><span class="o">.</span><span class="n">connect_signals</span><span class="p">()</span>
        <span class="n">work</span><span class="o">.</span><span class="n">build</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">work</span>

</div></div>
<span class="k">class</span> <span class="nc">FlowCallbackError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Exceptions raised by FlowCallback.&quot;&quot;&quot;</span>


<span class="k">class</span> <span class="nc">FlowCallback</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This object implements the callbacks executed by the :class:`flow` when</span>
<span class="sd">    particular conditions are fulfilled. See on_dep_ok method of :class:`Flow`.</span>

<span class="sd">    .. note::</span>

<span class="sd">        I decided to implement callbacks via this object instead of a standard</span>
<span class="sd">        approach based on bound methods because:</span>

<span class="sd">            1) pickle (v&lt;=3) does not support the pickling/unplickling of bound methods</span>

<span class="sd">            2) There&#39;s some extra logic and extra data needed for the proper functioning</span>
<span class="sd">               of a callback at the flow level and this object provides an easy-to-use interface.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">Error</span> <span class="o">=</span> <span class="n">FlowCallbackError</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func_name</span><span class="p">,</span> <span class="n">flow</span><span class="p">,</span> <span class="n">deps</span><span class="p">,</span> <span class="n">cbk_data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            func_name: String with the name of the callback to execute.</span>
<span class="sd">                       func_name must be a bound method of flow with signature:</span>

<span class="sd">                            func_name(self, cbk)</span>

<span class="sd">                       where self is the Flow instance and cbk is the callback</span>
<span class="sd">            flow: Reference to the :class:`Flow`</span>
<span class="sd">            deps: List of dependencies associated to the callback</span>
<span class="sd">                  The callback is executed when all dependencies reach S_OK.</span>
<span class="sd">            cbk_data: Dictionary with additional data that will be passed to the callback via self.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">func_name</span> <span class="o">=</span> <span class="n">func_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flow</span> <span class="o">=</span> <span class="n">flow</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deps</span> <span class="o">=</span> <span class="n">deps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">cbk_data</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_disabled</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s"> bound to </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">func_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Execute the callback.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">can_execute</span><span class="p">():</span>
            <span class="c"># Get the bound method of the flow from func_name.</span>
            <span class="c"># We use this trick because pickle (format &lt;=3) does not support bound methods.</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">func</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">func_name</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">AttributeError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">))</span>

            <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="s">&quot;You tried to __call_ a callback that cannot be executed!&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">can_execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;True if we can execute the callback.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_disabled</span> <span class="ow">and</span> <span class="p">[</span><span class="n">dep</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">dep</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">S_OK</span> <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">deps</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">disable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        True if the callback has been disabled.</span>
<span class="sd">        This usually happens when the callback has been executed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_disabled</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">handle_sender</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sender</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        True if the callback is associated to the sender</span>
<span class="sd">        i.e. if the node who sent the signal appears in the</span>
<span class="sd">        dependencies of the callback.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">sender</span> <span class="ow">in</span> <span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">node</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">deps</span><span class="p">]</span>


<span class="c"># Factory functions.</span>
<div class="viewcode-block" id="bandstructure_flow"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.flows.bandstructure_flow">[docs]</a><span class="k">def</span> <span class="nf">bandstructure_flow</span><span class="p">(</span><span class="n">workdir</span><span class="p">,</span> <span class="n">scf_input</span><span class="p">,</span> <span class="n">nscf_input</span><span class="p">,</span> <span class="n">dos_inputs</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">flow_class</span><span class="o">=</span><span class="n">Flow</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build a :class:`Flow` for band structure calculations.</span>

<span class="sd">    Args:</span>
<span class="sd">        workdir: Working directory.</span>
<span class="sd">        scf_input: Input for the GS SCF run.</span>
<span class="sd">        nscf_input: Input for the NSCF run (band structure run).</span>
<span class="sd">        dos_inputs: Input(s) for the NSCF run (dos run).</span>
<span class="sd">        manager: :class:`TaskManager` object used to submit the jobs</span>
<span class="sd">                 Initialized from manager.yml if manager is None.</span>
<span class="sd">        flow_class: Flow subclass</span>

<span class="sd">    Returns:</span>
<span class="sd">        :class:`Flow` object</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">flow</span> <span class="o">=</span> <span class="n">flow_class</span><span class="p">(</span><span class="n">workdir</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="n">manager</span><span class="p">)</span>
    <span class="n">work</span> <span class="o">=</span> <span class="n">BandStructureWork</span><span class="p">(</span><span class="n">scf_input</span><span class="p">,</span> <span class="n">nscf_input</span><span class="p">,</span> <span class="n">dos_inputs</span><span class="o">=</span><span class="n">dos_inputs</span><span class="p">)</span>
    <span class="n">flow</span><span class="o">.</span><span class="n">register_work</span><span class="p">(</span><span class="n">work</span><span class="p">)</span>

    <span class="c"># Handy aliases</span>
    <span class="n">flow</span><span class="o">.</span><span class="n">scf_task</span><span class="p">,</span> <span class="n">flow</span><span class="o">.</span><span class="n">nscf_task</span><span class="p">,</span> <span class="n">flow</span><span class="o">.</span><span class="n">dos_tasks</span> <span class="o">=</span> <span class="n">work</span><span class="o">.</span><span class="n">scf_task</span><span class="p">,</span> <span class="n">work</span><span class="o">.</span><span class="n">nscf_task</span><span class="p">,</span> <span class="n">work</span><span class="o">.</span><span class="n">dos_tasks</span>

    <span class="k">return</span> <span class="n">flow</span><span class="o">.</span><span class="n">allocate</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="g0w0_flow"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.flows.g0w0_flow">[docs]</a><span class="k">def</span> <span class="nf">g0w0_flow</span><span class="p">(</span><span class="n">workdir</span><span class="p">,</span> <span class="n">scf_input</span><span class="p">,</span> <span class="n">nscf_input</span><span class="p">,</span> <span class="n">scr_input</span><span class="p">,</span> <span class="n">sigma_inputs</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">flow_class</span><span class="o">=</span><span class="n">Flow</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build an :class:`Flow` for one-shot $G_0W_0$ calculations.</span>

<span class="sd">    Args:</span>
<span class="sd">        workdir: Working directory.</span>
<span class="sd">        scf_input: Input for the GS SCF run.</span>
<span class="sd">        nscf_input: Input for the NSCF run (band structure run).</span>
<span class="sd">        scr_input: Input for the SCR run.</span>
<span class="sd">        sigma_inputs: List of inputs for the SIGMA run.</span>
<span class="sd">        flow_class: Flow class</span>
<span class="sd">        manager: :class:`TaskManager` object used to submit the jobs.</span>
<span class="sd">                 Initialized from manager.yml if manager is None.</span>

<span class="sd">    Returns:</span>
<span class="sd">        :class:`Flow` object</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">flow</span> <span class="o">=</span> <span class="n">flow_class</span><span class="p">(</span><span class="n">workdir</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="n">manager</span><span class="p">)</span>
    <span class="n">work</span> <span class="o">=</span> <span class="n">G0W0Work</span><span class="p">(</span><span class="n">scf_input</span><span class="p">,</span> <span class="n">nscf_input</span><span class="p">,</span> <span class="n">scr_input</span><span class="p">,</span> <span class="n">sigma_inputs</span><span class="p">)</span>
    <span class="n">flow</span><span class="o">.</span><span class="n">register_work</span><span class="p">(</span><span class="n">work</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">flow</span><span class="o">.</span><span class="n">allocate</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="phonon_flow"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.flows.phonon_flow">[docs]</a><span class="k">def</span> <span class="nf">phonon_flow</span><span class="p">(</span><span class="n">workdir</span><span class="p">,</span> <span class="n">scf_input</span><span class="p">,</span> <span class="n">ph_inputs</span><span class="p">,</span> <span class="n">with_nscf</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">with_ddk</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">with_dde</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">flow_class</span><span class="o">=</span><span class="n">Flow</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build an :class:`Flow` for phonon calculations.</span>

<span class="sd">    Args:</span>
<span class="sd">        workdir: Working directory.</span>
<span class="sd">        scf_input: Input for the GS SCF run.</span>
<span class="sd">        ph_inputs: List of Inputs for the phonon runs.</span>
<span class="sd">        with_nscf: add an nscf task in front of al phonon tasks to make sure the q point is covered</span>
<span class="sd">        with_ddk: add the ddk step</span>
<span class="sd">        with_dde: add the dde step it the dde is set ddk is switched on automatically</span>
<span class="sd">        manager: :class:`TaskManager` used to submit the jobs</span>
<span class="sd">                 Initialized from manager.yml if manager is None.</span>
<span class="sd">        flow_class: Flow class</span>

<span class="sd">    Returns:</span>
<span class="sd">        :class:`Flow` object</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">with_dde</span><span class="p">:</span>
        <span class="n">with_ddk</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="n">natom</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">scf_input</span><span class="o">.</span><span class="n">structure</span><span class="p">)</span>

    <span class="c"># Create the container that will manage the different works.</span>
    <span class="n">flow</span> <span class="o">=</span> <span class="n">flow_class</span><span class="p">(</span><span class="n">workdir</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="n">manager</span><span class="p">)</span>

    <span class="c"># Register the first work (GS calculation)</span>
    <span class="c"># register_task creates a work for the task, registers it to the flow and returns the work</span>
    <span class="c"># the 0the element of the work is the task</span>
    <span class="n">scf_task</span> <span class="o">=</span> <span class="n">flow</span><span class="o">.</span><span class="n">register_task</span><span class="p">(</span><span class="n">scf_input</span><span class="p">,</span> <span class="n">task_class</span><span class="o">=</span><span class="n">ScfTask</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c"># Build a temporary work with a shell manager just to run</span>
    <span class="c"># ABINIT to get the list of irreducible pertubations for this q-point.</span>
    <span class="n">shell_manager</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">to_shell_manager</span><span class="p">(</span><span class="n">mpi_procs</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">with_ddk</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;add ddk&#39;</span><span class="p">)</span>
        <span class="n">ddk_input</span> <span class="o">=</span> <span class="n">ph_inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">()</span>
        <span class="n">ddk_input</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">qpt</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">rfddk</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">rfelfd</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">rfdir</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">ddk_task</span> <span class="o">=</span> <span class="n">flow</span><span class="o">.</span><span class="n">register_task</span><span class="p">(</span><span class="n">ddk_input</span><span class="p">,</span> <span class="n">deps</span><span class="o">=</span><span class="p">{</span><span class="n">scf_task</span><span class="p">:</span> <span class="s">&#39;WFK&#39;</span><span class="p">},</span> <span class="n">task_class</span><span class="o">=</span><span class="n">DdkTask</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">with_dde</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;add dde&#39;</span><span class="p">)</span>
        <span class="n">dde_input</span> <span class="o">=</span> <span class="n">ph_inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">()</span>
        <span class="n">dde_input</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">qpt</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">rfddk</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">rfelfd</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">dde_input_idir</span> <span class="o">=</span> <span class="n">dde_input</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">()</span>
        <span class="n">dde_input_idir</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">rfdir</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">dde_task</span> <span class="o">=</span> <span class="n">flow</span><span class="o">.</span><span class="n">register_task</span><span class="p">(</span><span class="n">dde_input</span><span class="p">,</span> <span class="n">deps</span><span class="o">=</span><span class="p">{</span><span class="n">scf_task</span><span class="p">:</span> <span class="s">&#39;WFK&#39;</span><span class="p">,</span> <span class="n">ddk_task</span><span class="p">:</span> <span class="s">&#39;DDK&#39;</span><span class="p">},</span> <span class="n">task_class</span><span class="o">=</span><span class="n">DdeTask</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ph_inputs</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
        <span class="n">ph_inputs</span> <span class="o">=</span> <span class="p">[</span><span class="n">ph_inputs</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ph_input</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ph_inputs</span><span class="p">):</span>

        <span class="n">fake_input</span> <span class="o">=</span> <span class="n">ph_input</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">()</span>

        <span class="c"># Run abinit on the front-end to get the list of irreducible pertubations.</span>
        <span class="n">tmp_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">workdir</span><span class="p">,</span> <span class="s">&quot;__ph_run&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;__&quot;</span><span class="p">)</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">PhononWork</span><span class="p">(</span><span class="n">workdir</span><span class="o">=</span><span class="n">tmp_dir</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="n">shell_manager</span><span class="p">)</span>
        <span class="n">fake_task</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">fake_input</span><span class="p">)</span>

        <span class="c"># Use the magic value paral_rf = -1 to get the list of irreducible perturbations for this q-point.</span>
        <span class="n">abivars</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">paral_rf</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">rfatpol</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">natom</span><span class="p">],</span>  <span class="c"># Set of atoms to displace.</span>
            <span class="n">rfdir</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>     <span class="c"># Along this set of reduced coordinate axis.</span>
            <span class="p">)</span>

        <span class="n">fake_task</span><span class="o">.</span><span class="n">strategy</span><span class="o">.</span><span class="n">add_extra_abivars</span><span class="p">(</span><span class="n">abivars</span><span class="p">)</span>
        <span class="n">w</span><span class="o">.</span><span class="n">allocate</span><span class="p">()</span>
        <span class="n">w</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">wait</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="c"># Parse the file to get the perturbations.</span>
        <span class="n">irred_perts</span> <span class="o">=</span> <span class="n">yaml_read_irred_perts</span><span class="p">(</span><span class="n">fake_task</span><span class="o">.</span><span class="n">log_file</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">irred_perts</span><span class="p">)</span>

        <span class="n">w</span><span class="o">.</span><span class="n">rmtree</span><span class="p">()</span>

        <span class="c"># Now we can build the final list of works:</span>
        <span class="c"># One work per q-point, each work computes all </span>
        <span class="c"># the irreducible perturbations for a singe q-point.</span>

        <span class="n">work_qpt</span> <span class="o">=</span> <span class="n">PhononWork</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">with_nscf</span><span class="p">:</span>
            <span class="n">nscf_input</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">scf_input</span><span class="p">)</span>
            <span class="n">nscf_input</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">kptopt</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">iscf</span><span class="o">=-</span><span class="mi">3</span><span class="p">,</span> <span class="n">qpt</span><span class="o">=</span><span class="n">irred_perts</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;qpt&#39;</span><span class="p">],</span> <span class="n">nqpt</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">nscf_task</span> <span class="o">=</span> <span class="n">work_qpt</span><span class="o">.</span><span class="n">register_nscf_task</span><span class="p">(</span><span class="n">nscf_input</span><span class="p">,</span> <span class="n">deps</span><span class="o">=</span><span class="p">{</span><span class="n">scf_task</span><span class="p">:</span> <span class="s">&quot;DEN&quot;</span><span class="p">})</span>
            <span class="n">deps</span> <span class="o">=</span> <span class="p">{</span><span class="n">nscf_task</span><span class="p">:</span> <span class="s">&quot;WFQ&quot;</span><span class="p">,</span> <span class="n">scf_task</span><span class="p">:</span> <span class="s">&quot;WFK&quot;</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">deps</span> <span class="o">=</span> <span class="p">{</span><span class="n">scf_task</span><span class="p">:</span> <span class="s">&quot;WFK&quot;</span><span class="p">}</span>

        <span class="k">if</span> <span class="n">with_ddk</span><span class="p">:</span>
            <span class="n">deps</span><span class="p">[</span><span class="n">ddk_task</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;DDK&#39;</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">irred_perts</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;qpt&#39;</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">irred_pert</span> <span class="ow">in</span> <span class="n">irred_perts</span><span class="p">:</span>
            <span class="c">#print(irred_pert)</span>
            <span class="n">new_input</span> <span class="o">=</span> <span class="n">ph_input</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">()</span>

            <span class="c">#rfatpol   1 1   # Only the first atom is displaced</span>
            <span class="c">#rfdir   1 0 0   # Along the first reduced coordinate axis</span>
            <span class="n">qpt</span> <span class="o">=</span> <span class="n">irred_pert</span><span class="p">[</span><span class="s">&quot;qpt&quot;</span><span class="p">]</span>
            <span class="n">idir</span> <span class="o">=</span> <span class="n">irred_pert</span><span class="p">[</span><span class="s">&quot;idir&quot;</span><span class="p">]</span>
            <span class="n">ipert</span> <span class="o">=</span> <span class="n">irred_pert</span><span class="p">[</span><span class="s">&quot;ipert&quot;</span><span class="p">]</span>

            <span class="c"># TODO this will work for phonons, but not for the other types of perturbations.</span>
            <span class="n">rfdir</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">rfdir</span><span class="p">[</span><span class="n">idir</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">rfatpol</span> <span class="o">=</span> <span class="p">[</span><span class="n">ipert</span><span class="p">,</span> <span class="n">ipert</span><span class="p">]</span>

            <span class="n">new_input</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span>
                <span class="c">#rfpert=1,</span>
                <span class="n">qpt</span><span class="o">=</span><span class="n">qpt</span><span class="p">,</span>
                <span class="n">rfdir</span><span class="o">=</span><span class="n">rfdir</span><span class="p">,</span>
                <span class="n">rfatpol</span><span class="o">=</span><span class="n">rfatpol</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">with_ddk</span><span class="p">:</span>
                <span class="n">new_input</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">rfelfd</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

            <span class="n">work_qpt</span><span class="o">.</span><span class="n">register_phonon_task</span><span class="p">(</span><span class="n">new_input</span><span class="p">,</span> <span class="n">deps</span><span class="o">=</span><span class="n">deps</span><span class="p">)</span>

        <span class="n">flow</span><span class="o">.</span><span class="n">register_work</span><span class="p">(</span><span class="n">work_qpt</span><span class="p">)</span>

        <span class="c">#if ana_input is not None:</span>
        <span class="c">#    merge_input = {}</span>
        <span class="c">#    qp_merge_task = flow.register_task(merge_input, deps={work_qpt: &quot;DDB&quot;}, task_class=QpMergeTask)</span>
        <span class="c">#    flow.register_task(ana_input, deps={qp_merge_task: &quot;DDB&quot;}, task_class=AnaddbTask)</span>
                                            
    <span class="k">return</span> <span class="n">flow</span><span class="o">.</span><span class="n">allocate</span><span class="p">()</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../index.html">pymatgen 3.2.1 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>

    <div class="footer" role="contentinfo">
        &copy; Copyright 2011, Shyue Ping Ong, Anubhav Jain, Geoffroy Hautier, William Davidson Richard, Stephen Dacek, Sai Jayaraman, Michael Kocher, Dan Gunter, Shreyas Cholia, Vincent L Chevrier, Rickard Armiento.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.1.
    </div>
<div class="footer">This page uses <a href="http://analytics.google.com/">
Google Analytics</a> to collect statistics. You can disable it by blocking
the JavaScript coming from www.google-analytics.com.
<script type="text/javascript">
  (function() {
    var ga = document.createElement('script');
    ga.src = ('https:' == document.location.protocol ?
              'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    ga.setAttribute('async', 'true');
    document.documentElement.firstChild.appendChild(ga);
  })();
</script>
</div>

  </body>
</html>