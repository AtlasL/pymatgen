<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>pymatgen.io.abinitio.qadapters &mdash; pymatgen 3.1.3 documentation</title>
    
    <link rel="stylesheet" href="../../../../_static/proBlue.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../../',
        VERSION:     '3.1.3',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="shortcut icon" href="../../../../_static/favicon.ico"/>
    <link rel="top" title="pymatgen 3.1.3 documentation" href="../../../../index.html" />
    <link rel="up" title="Module code" href="../../../index.html" />
 
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-33990148-1']);
  _gaq.push(['_trackPageview']);
</script>

  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../index.html">pymatgen 3.1.3 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for pymatgen.io.abinitio.qadapters</h1><div class="highlight"><pre>
<span class="c"># coding: utf-8</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Part of this code is based on a similar implementation present in FireWorks (https://pypi.python.org/pypi/FireWorks).</span>
<span class="sd">Work done by D. Waroquiers, A. Jain, and M. Kocher.</span>

<span class="sd">The main difference wrt the Fireworks implementation is that the QueueAdapter</span>
<span class="sd">objects provide a programmatic interface for setting important attributes </span>
<span class="sd">such as the number of MPI nodes, the number of OMP threads and the memory requirements.</span>
<span class="sd">This programmatic interface is used by the `TaskManager` for optimizing the parameters</span>
<span class="sd">of the run before submitting the job (Abinit provides the autoparal option that </span>
<span class="sd">allows one to get a list of parallel configuration and their expected efficiency).</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">unicode_literals</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">abc</span>
<span class="kn">import</span> <span class="nn">string</span>
<span class="kn">import</span> <span class="nn">shlex</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">getpass</span>
<span class="kn">import</span> <span class="nn">six</span>
<span class="kn">import</span> <span class="nn">json</span>

<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span><span class="p">,</span> <span class="n">OrderedDict</span><span class="p">,</span> <span class="n">defaultdict</span>
<span class="kn">from</span> <span class="nn">subprocess</span> <span class="kn">import</span> <span class="n">Popen</span><span class="p">,</span> <span class="n">PIPE</span>
<span class="kn">from</span> <span class="nn">atomicfile</span> <span class="kn">import</span> <span class="n">AtomicFile</span>
<span class="kn">from</span> <span class="nn">monty.string</span> <span class="kn">import</span> <span class="n">is_string</span>
<span class="kn">from</span> <span class="nn">monty.collections</span> <span class="kn">import</span> <span class="n">AttrDict</span>
<span class="kn">from</span> <span class="nn">monty.functools</span> <span class="kn">import</span> <span class="n">lazy_property</span>
<span class="kn">from</span> <span class="nn">monty.io</span> <span class="kn">import</span> <span class="n">FileLock</span>
<span class="kn">from</span> <span class="nn">pymatgen.core.units</span> <span class="kn">import</span> <span class="n">Time</span><span class="p">,</span> <span class="n">Memory</span>
<span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">Condition</span>
<span class="kn">from</span> <span class="nn">.launcher</span> <span class="kn">import</span> <span class="n">ScriptEditor</span>

<span class="kn">import</span> <span class="nn">logging</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s">&quot;MpiRunner&quot;</span><span class="p">,</span>
    <span class="s">&quot;make_qadapter&quot;</span><span class="p">,</span>
<span class="p">]</span>


<div class="viewcode-block" id="slurm_parse_timestr"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.qadapters.slurm_parse_timestr">[docs]</a><span class="k">def</span> <span class="nf">slurm_parse_timestr</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A slurm time parser. Accepts a string in one the following forms:</span>

<span class="sd">        # &quot;days-hours&quot;,</span>
<span class="sd">        # &quot;days-hours:minutes&quot;,</span>
<span class="sd">        # &quot;days-hours:minutes:seconds&quot;.</span>
<span class="sd">        # &quot;minutes&quot;,</span>
<span class="sd">        # &quot;minutes:seconds&quot;,</span>
<span class="sd">        # &quot;hours:minutes:seconds&quot;,</span>

<span class="sd">    Returns:</span>
<span class="sd">        Time in seconds.</span>

<span class="sd">    Raises:</span>
<span class="sd">        `ValueError` if string is not valid.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">days</span><span class="p">,</span> <span class="n">hours</span><span class="p">,</span> <span class="n">minutes</span><span class="p">,</span> <span class="n">seconds</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="s">&#39;-&#39;</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
        <span class="c"># &quot;days-hours&quot;,</span>
        <span class="c"># &quot;days-hours:minutes&quot;,                                        </span>
        <span class="c"># &quot;days-hours:minutes:seconds&quot;.                                </span>
        <span class="n">days</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;-&quot;</span><span class="p">)</span>
        <span class="n">days</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">days</span><span class="p">)</span>

        <span class="k">if</span> <span class="s">&#39;:&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
            <span class="n">hours</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">s</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">hours</span><span class="p">,</span> <span class="n">minutes</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">s</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">hours</span><span class="p">,</span> <span class="n">minutes</span><span class="p">,</span> <span class="n">seconds</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;More that 2 &#39;:&#39; in string!&quot;</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c"># &quot;minutes&quot;,</span>
        <span class="c"># &quot;minutes:seconds&quot;,</span>
        <span class="c"># &quot;hours:minutes:seconds&quot;,</span>
        <span class="k">if</span> <span class="s">&#39;:&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
            <span class="n">minutes</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">s</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">minutes</span><span class="p">,</span> <span class="n">seconds</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">s</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">hours</span><span class="p">,</span> <span class="n">minutes</span><span class="p">,</span> <span class="n">seconds</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;More than 2 &#39;:&#39; in string!&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">Time</span><span class="p">((</span><span class="n">days</span><span class="o">*</span><span class="mi">24</span> <span class="o">+</span> <span class="n">hours</span><span class="p">)</span><span class="o">*</span><span class="mi">3600</span> <span class="o">+</span> <span class="n">minutes</span><span class="o">*</span><span class="mi">60</span> <span class="o">+</span> <span class="n">seconds</span><span class="p">,</span> <span class="s">&quot;s&quot;</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="time2slurm"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.qadapters.time2slurm">[docs]</a><span class="k">def</span> <span class="nf">time2slurm</span><span class="p">(</span><span class="n">timeval</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s">&quot;s&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert a number representing a time value in the given unit (Default: seconds)</span>
<span class="sd">    to a string following the slurm convention: &quot;days-hours:minutes:seconds&quot;.</span>

<span class="sd">    &gt;&gt;&gt; assert time2slurm(61) == &#39;0-0:1:1&#39; and time2slurm(60*60+1) == &#39;0-1:0:1&#39;</span>
<span class="sd">    &gt;&gt;&gt; assert time2slurm(0.5, unit=&quot;h&quot;) == &#39;0-0:30:0&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">d</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="mi">24</span><span class="o">*</span><span class="mi">3600</span><span class="p">,</span> <span class="mi">3600</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">1</span>

    <span class="n">timeval</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="n">timeval</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s">&quot;s&quot;</span><span class="p">)</span>
    <span class="n">days</span><span class="p">,</span> <span class="n">hours</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">timeval</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
    <span class="n">hours</span><span class="p">,</span> <span class="n">minutes</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">hours</span><span class="p">,</span> <span class="n">h</span><span class="p">)</span>
    <span class="n">minutes</span><span class="p">,</span> <span class="n">secs</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">minutes</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span>

    <span class="k">return</span> <span class="s">&quot;</span><span class="si">%d</span><span class="s">-</span><span class="si">%d</span><span class="s">:</span><span class="si">%d</span><span class="s">:</span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">days</span><span class="p">,</span> <span class="n">hours</span><span class="p">,</span> <span class="n">minutes</span><span class="p">,</span> <span class="n">secs</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="time2pbspro"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.qadapters.time2pbspro">[docs]</a><span class="k">def</span> <span class="nf">time2pbspro</span><span class="p">(</span><span class="n">timeval</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s">&quot;s&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert a number representing a time value in the given unit (Default: seconds)</span>
<span class="sd">    to a string following the PbsPro convention: &quot;hours:minutes:seconds&quot;.</span>

<span class="sd">    &gt;&gt;&gt; assert time2pbspro(2, unit=&quot;d&quot;) == &#39;48:0:0&#39; </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">h</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="mi">3600</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">1</span>

    <span class="n">timeval</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="n">timeval</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s">&quot;s&quot;</span><span class="p">)</span>
    <span class="n">hours</span><span class="p">,</span> <span class="n">minutes</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">timeval</span><span class="p">,</span> <span class="n">h</span><span class="p">)</span>
    <span class="n">minutes</span><span class="p">,</span> <span class="n">secs</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">minutes</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span>

    <span class="k">return</span> <span class="s">&quot;</span><span class="si">%d</span><span class="s">:</span><span class="si">%d</span><span class="s">:</span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">hours</span><span class="p">,</span> <span class="n">minutes</span><span class="p">,</span> <span class="n">secs</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="timelimit_parser"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.qadapters.timelimit_parser">[docs]</a><span class="k">def</span> <span class="nf">timelimit_parser</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert a float or a string into time in seconds.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Time</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="s">&quot;s&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">slurm_parse_timestr</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="any2mb"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.qadapters.any2mb">[docs]</a><span class="k">def</span> <span class="nf">any2mb</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert string or number to memory in megabytes.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">is_string</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">Memory</span><span class="o">.</span><span class="n">from_string</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s">&quot;Mb&quot;</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="MpiRunner"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.qadapters.MpiRunner">[docs]</a><span class="k">class</span> <span class="nc">MpiRunner</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This object provides an abstraction for the mpirunner provided </span>
<span class="sd">    by the different MPI libraries. It&#39;s main task is handling the</span>
<span class="sd">    different syntax and options supported by the different mpirunners.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="n">options</span>

<div class="viewcode-block" id="MpiRunner.string_to_run"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.qadapters.MpiRunner.string_to_run">[docs]</a>    <span class="k">def</span> <span class="nf">string_to_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">executable</span><span class="p">,</span> <span class="n">mpi_procs</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">stdin</span> <span class="o">=</span> <span class="s">&quot;&lt; &quot;</span> <span class="o">+</span> <span class="n">stdin</span> <span class="k">if</span> <span class="n">stdin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="s">&quot;&quot;</span>
        <span class="n">stdout</span> <span class="o">=</span> <span class="s">&quot;&gt; &quot;</span> <span class="o">+</span> <span class="n">stdout</span> <span class="k">if</span> <span class="n">stdout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="s">&quot;&quot;</span>
        <span class="n">stderr</span> <span class="o">=</span> <span class="s">&quot;2&gt; &quot;</span> <span class="o">+</span> <span class="n">stderr</span> <span class="k">if</span> <span class="n">stderr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="s">&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_mpirun</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="c"># TODO: better treatment of mpirun syntax.</span>
                <span class="c">#se.add_line(&#39;$MPIRUN -n $MPI_PROCS $EXECUTABLE &lt; $STDIN &gt; $STDOUT 2&gt; $STDERR&#39;)</span>
                <span class="n">num_opt</span> <span class="o">=</span> <span class="s">&quot;-n &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">mpi_procs</span><span class="p">)</span>
                <span class="n">cmd</span> <span class="o">=</span> <span class="s">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">num_opt</span><span class="p">,</span> <span class="n">executable</span><span class="p">,</span> <span class="n">stdin</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">&quot;type </span><span class="si">%s</span><span class="s"> is not supported!&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c">#assert mpi_procs == 1</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="s">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">executable</span><span class="p">,</span> <span class="n">stdin</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">cmd</span>
</div>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">has_mpirun</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;True if we are running via mpirun, mpiexec ...&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>

</div>
<div class="viewcode-block" id="OmpEnv"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.qadapters.OmpEnv">[docs]</a><span class="k">class</span> <span class="nc">OmpEnv</span><span class="p">(</span><span class="n">AttrDict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Dictionary with the OpenMP environment variables</span>
<span class="sd">    see https://computing.llnl.gov/tutorials/openMP/#EnvironmentVariables</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_KEYS</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s">&quot;OMP_SCHEDULE&quot;</span><span class="p">,</span>
        <span class="s">&quot;OMP_NUM_THREADS&quot;</span><span class="p">,</span>
        <span class="s">&quot;OMP_DYNAMIC&quot;</span><span class="p">,</span>
        <span class="s">&quot;OMP_PROC_BIND&quot;</span><span class="p">,</span>
        <span class="s">&quot;OMP_NESTED&quot;</span><span class="p">,</span>
        <span class="s">&quot;OMP_STACKSIZE&quot;</span><span class="p">,</span>
        <span class="s">&quot;OMP_WAIT_POLICY&quot;</span><span class="p">,</span>
        <span class="s">&quot;OMP_MAX_ACTIVE_LEVELS&quot;</span><span class="p">,</span>
        <span class="s">&quot;OMP_THREAD_LIMIT&quot;</span><span class="p">,</span>
        <span class="s">&quot;OMP_STACKSIZE&quot;</span><span class="p">,</span>
        <span class="s">&quot;OMP_PROC_BIND&quot;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="OmpEnv.as_ompenv"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.qadapters.OmpEnv.as_ompenv">[docs]</a>    <span class="k">def</span> <span class="nf">as_ompenv</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert an object into a OmpEnv&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">cls</span><span class="p">):</span> <span class="k">return</span> <span class="n">obj</span>
        <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="k">return</span> <span class="n">cls</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">cls</span><span class="p">(</span><span class="o">**</span><span class="n">obj</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Constructor method inherited from dictionary:</span>

<span class="sd">        &gt;&gt;&gt; assert OmpEnv(OMP_NUM_THREADS=1).OMP_NUM_THREADS == 1</span>

<span class="sd">        To create an instance from an INI file, use:</span>
<span class="sd">           OmpEnv.from_file(filename)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">OmpEnv</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">err_msg</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_KEYS</span><span class="p">:</span>
                <span class="n">err_msg</span> <span class="o">+=</span> <span class="s">&quot;unknown option </span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">key</span>

        <span class="k">if</span> <span class="n">err_msg</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>

<div class="viewcode-block" id="OmpEnv.export_str"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.qadapters.OmpEnv.export_str">[docs]</a>    <span class="k">def</span> <span class="nf">export_str</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a string with the bash statements needed to setup the OMP env.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s">&quot;export </span><span class="si">%s</span><span class="s">=</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>

</div></div>
<div class="viewcode-block" id="Hardware"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.qadapters.Hardware">[docs]</a><span class="k">class</span> <span class="nc">Hardware</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This object collects information on the hardware available in a given queue.</span>

<span class="sd">    Basic definitions:</span>

<span class="sd">        - A node refers to the physical box, i.e. cpu sockets with north/south switches connecting memory systems</span>
<span class="sd">          and extension cards, e.g. disks, nics, and accelerators</span>

<span class="sd">        - A cpu socket is the connector to these systems and the cpu cores</span>

<span class="sd">        - A cpu core is an independent computing with its own computing pipeline, logical units, and memory controller.</span>
<span class="sd">          Each cpu core will be able to service a number of cpu threads, each having an independent instruction stream </span>
<span class="sd">          but sharing the cores memory controller and other logical units.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_nodes</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;num_nodes&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sockets_per_node</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;sockets_per_node&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cores_per_socket</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;cores_per_socket&quot;</span><span class="p">))</span>

        <span class="c"># Convert memory to megabytes.</span>
        <span class="n">m</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;mem_per_node&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mem_per_node</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">Memory</span><span class="o">.</span><span class="n">from_string</span><span class="p">(</span><span class="n">m</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s">&quot;Mb&quot;</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mem_per_node</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">sockets_per_node</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">cores_per_socket</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;invalid parameters: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Found invalid keywords in the partition section:</span><span class="se">\n</span><span class="s"> </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

<div class="viewcode-block" id="Hardware.__str__"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.qadapters.Hardware.__str__">[docs]</a>    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;String representation.&quot;&quot;&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">app</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">append</span>
        <span class="n">app</span><span class="p">(</span><span class="s">&quot;   num_nodes: </span><span class="si">%d</span><span class="s">, sockets_per_node: </span><span class="si">%d</span><span class="s">, cores_per_socket: </span><span class="si">%d</span><span class="s">, mem_per_node </span><span class="si">%s</span><span class="s">,&quot;</span> <span class="o">%</span> 
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_nodes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sockets_per_node</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cores_per_socket</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mem_per_node</span><span class="p">))</span>
        <span class="k">return</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
</div>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">num_cores</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Total number of cores available&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cores_per_socket</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">sockets_per_node</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_nodes</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">cores_per_node</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Number of cores per node.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cores_per_socket</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">sockets_per_node</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">mem_per_core</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Memory available on a single node.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mem_per_node</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">cores_per_node</span>

<div class="viewcode-block" id="Hardware.can_use_omp_threads"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.qadapters.Hardware.can_use_omp_threads">[docs]</a>    <span class="k">def</span> <span class="nf">can_use_omp_threads</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">omp_threads</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;True if omp_threads fit in a node.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cores_per_node</span> <span class="o">&gt;=</span> <span class="n">omp_threads</span>
</div>
<div class="viewcode-block" id="Hardware.divmod_node"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.qadapters.Hardware.divmod_node">[docs]</a>    <span class="k">def</span> <span class="nf">divmod_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mpi_procs</span><span class="p">,</span> <span class="n">omp_threads</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Use divmod to compute (num_nodes, rest_cores)&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">mpi_procs</span> <span class="o">*</span> <span class="n">omp_threads</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cores_per_node</span><span class="p">)</span>

</div></div>
<span class="k">class</span> <span class="nc">_ExcludeNodesFile</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This file contains the list of nodes to be excluded. </span>
<span class="sd">    Nodes are indexed by queue name.</span>
<span class="sd">    &quot;&quot;&quot;</span> 
    <span class="n">DIRPATH</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s">&quot;HOME&quot;</span><span class="p">),</span> <span class="s">&quot;.abinit&quot;</span><span class="p">,</span> <span class="s">&quot;abipy&quot;</span><span class="p">)</span>
    <span class="n">FILEPATH</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DIRPATH</span><span class="p">,</span> <span class="s">&quot;exclude_nodes.json&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">FILEPATH</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DIRPATH</span><span class="p">):</span> <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DIRPATH</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">FileLock</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">FILEPATH</span><span class="p">):</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">FILEPATH</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
                    <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">({},</span> <span class="n">fh</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">read_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qname</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">FILEPATH</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">qname</span><span class="p">,</span> <span class="p">[])</span>

    <span class="k">def</span> <span class="nf">add_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qname</span><span class="p">,</span> <span class="n">nodes</span><span class="p">):</span>
        <span class="n">nodes</span> <span class="o">=</span> <span class="p">(</span><span class="n">nodes</span><span class="p">,)</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">nodes</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">))</span> <span class="k">else</span> <span class="n">nodes</span>
        <span class="k">with</span> <span class="n">FileLock</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">FILEPATH</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">AtomicFile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">FILEPATH</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&quot;w+&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
                <span class="n">d</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">qname</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
                    <span class="n">d</span><span class="p">[</span><span class="s">&quot;qname&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span>
                    <span class="n">d</span><span class="p">[</span><span class="s">&quot;qname&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s">&quot;qname&quot;</span><span class="p">]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">d</span><span class="p">[</span><span class="s">&quot;qname&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nodes</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">fh</span><span class="p">)</span>

<span class="n">_EXCL_NODES_FILE</span> <span class="o">=</span> <span class="n">_ExcludeNodesFile</span><span class="p">()</span>


<div class="viewcode-block" id="JobStatus"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.qadapters.JobStatus">[docs]</a><span class="k">class</span> <span class="nc">JobStatus</span><span class="p">(</span><span class="nb">int</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This object is an integer representing the status of a :class:`QueueJob`.</span>

<span class="sd">    Slurm API, see `man squeue`.</span>

<span class="sd">    JOB STATE CODES</span>
<span class="sd">       Jobs typically pass through several states in the course of their execution.  The typical  states  are</span>
<span class="sd">       PENDING, RUNNING, SUSPENDED, COMPLETING, and COMPLETED.  An explanation of each state follows.</span>

<span class="sd">    BF  BOOT_FAIL       Job  terminated  due  to launch failure, typically due to a hardware failure (e.g.</span>
<span class="sd">                        unable to boot the node or block and the job can not be requeued).</span>
<span class="sd">    CA  CANCELLED       Job was explicitly cancelled by the user or system administrator.</span>
<span class="sd">                        The job may or may not have been initiated.</span>
<span class="sd">    CD  COMPLETED       Job has terminated all processes on all nodes.</span>
<span class="sd">    CF  CONFIGURING     Job has been allocated resources, but are waiting for them to become ready for use (e.g. booting).</span>
<span class="sd">    CG  COMPLETING      Job is in the process of completing. Some processes on some  nodes may still be active.</span>
<span class="sd">    F   FAILED          Job terminated with non-zero exit code or other failure condition.</span>
<span class="sd">    NF  NODE_FAIL       Job terminated due to failure of one or more allocated nodes.</span>
<span class="sd">    PD  PENDING         Job is awaiting resource allocation.</span>
<span class="sd">    PR  PREEMPTED       Job terminated due to preemption.</span>
<span class="sd">    R   RUNNING         Job currently has an allocation.</span>
<span class="sd">    S   SUSPENDED       Job has an allocation, but execution has been suspended.</span>
<span class="sd">    TO  TIMEOUT         Job terminated upon reaching its time limit.</span>
<span class="sd">    SE SPECIAL_EXIT     The job was requeued in a special state. This state can be set by users, typically</span>
<span class="sd">                        in EpilogSlurmctld, if the job has terminated with a particular exit value.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_STATUS_TABLE</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">([</span>
        <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;UNKNOWN&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;PENDING&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;RUNNING&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;RESIZING&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;SUSPENDED&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;COMPLETED&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="s">&quot;CANCELLED&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="s">&quot;FAILED&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="s">&quot;TIMEOUT&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">&quot;PREEMPTED&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="s">&quot;NODEFAIL&quot;</span><span class="p">),</span>
    <span class="p">])</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;&lt;</span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s">, at </span><span class="si">%s</span><span class="s">&gt;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

<div class="viewcode-block" id="JobStatus.__str__"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.qadapters.JobStatus.__str__">[docs]</a>    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;String representation.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_STATUS_TABLE</span><span class="p">[</span><span class="bp">self</span><span class="p">]</span>
</div>
    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="JobStatus.from_string"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.qadapters.JobStatus.from_string">[docs]</a>    <span class="k">def</span> <span class="nf">from_string</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a :class`JobStatus` instance from its string representation.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">num</span><span class="p">,</span> <span class="n">text</span> <span class="ow">in</span> <span class="n">cls</span><span class="o">.</span><span class="n">_STATUS_TABLE</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">text</span> <span class="o">==</span> <span class="n">s</span><span class="p">:</span> <span class="k">return</span> <span class="n">cls</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c">#raise ValueError(&quot;Wrong string %s&quot; % s)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&quot;Got unknown status: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">s</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">cls</span><span class="o">.</span><span class="n">from_string</span><span class="p">(</span><span class="s">&quot;UNKNOWN&quot;</span><span class="p">)</span>

</div></div>
<div class="viewcode-block" id="QueueJob"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.qadapters.QueueJob">[docs]</a><span class="k">class</span> <span class="nc">QueueJob</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This object provides methods to contact the resource manager to get info on the status</span>
<span class="sd">    of the job and useful statistics. This is an abstract class.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># Used to handle other resource managers.</span>
    <span class="n">S_UNKNOWN</span>   <span class="o">=</span> <span class="n">JobStatus</span><span class="o">.</span><span class="n">from_string</span><span class="p">(</span><span class="s">&quot;UNKNOWN&quot;</span><span class="p">)</span>
    <span class="c"># Slurm status</span>
    <span class="n">S_PENDING</span>   <span class="o">=</span> <span class="n">JobStatus</span><span class="o">.</span><span class="n">from_string</span><span class="p">(</span><span class="s">&quot;PENDING&quot;</span><span class="p">)</span>
    <span class="n">S_RUNNING</span>   <span class="o">=</span> <span class="n">JobStatus</span><span class="o">.</span><span class="n">from_string</span><span class="p">(</span><span class="s">&quot;RUNNING&quot;</span><span class="p">)</span>
    <span class="n">S_RESIZING</span>  <span class="o">=</span> <span class="n">JobStatus</span><span class="o">.</span><span class="n">from_string</span><span class="p">(</span><span class="s">&quot;RESIZING&quot;</span><span class="p">)</span>
    <span class="n">S_SUSPENDED</span> <span class="o">=</span> <span class="n">JobStatus</span><span class="o">.</span><span class="n">from_string</span><span class="p">(</span><span class="s">&quot;SUSPENDED&quot;</span><span class="p">)</span>
    <span class="n">S_COMPLETED</span> <span class="o">=</span> <span class="n">JobStatus</span><span class="o">.</span><span class="n">from_string</span><span class="p">(</span><span class="s">&quot;COMPLETED&quot;</span><span class="p">)</span>
    <span class="n">S_CANCELLED</span> <span class="o">=</span> <span class="n">JobStatus</span><span class="o">.</span><span class="n">from_string</span><span class="p">(</span><span class="s">&quot;CANCELLED&quot;</span><span class="p">)</span>
    <span class="n">S_FAILED</span>    <span class="o">=</span> <span class="n">JobStatus</span><span class="o">.</span><span class="n">from_string</span><span class="p">(</span><span class="s">&quot;FAILED&quot;</span><span class="p">)</span>
    <span class="n">S_TIMEOUT</span>   <span class="o">=</span> <span class="n">JobStatus</span><span class="o">.</span><span class="n">from_string</span><span class="p">(</span><span class="s">&quot;TIMEOUT&quot;</span><span class="p">)</span>
    <span class="n">S_PREEMPTED</span> <span class="o">=</span> <span class="n">JobStatus</span><span class="o">.</span><span class="n">from_string</span><span class="p">(</span><span class="s">&quot;PREEMPTED&quot;</span><span class="p">)</span>
    <span class="n">S_NODEFAIL</span>  <span class="o">=</span> <span class="n">JobStatus</span><span class="o">.</span><span class="n">from_string</span><span class="p">(</span><span class="s">&quot;NODEFAIL&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">queue_id</span><span class="p">,</span> <span class="n">qname</span><span class="p">,</span> <span class="n">qout_path</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">qerr_path</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">qname</span> <span class="o">=</span> <span class="n">queue_id</span><span class="p">,</span> <span class="n">qname</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qout_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">qerr_path</span> <span class="o">=</span> <span class="n">qout_path</span><span class="p">,</span> <span class="n">qerr_path</span>

        <span class="c"># Initialize properties.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">exitcode</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">signal</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span>

    <span class="c">#def __str__(self):</span>

    <span class="k">def</span> <span class="nf">__bool__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">qid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>

    <span class="n">__nonzero__</span> <span class="o">=</span> <span class="n">__bool__</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_completed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">S_COMPLETED</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_running</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">S_RUNNING</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_failed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">S_FAILED</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">timeout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">S_TIMEOUT</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">has_node_failures</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">S_NODEFAIL</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">unknown_status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">S_UNKNOWN</span>

<div class="viewcode-block" id="QueueJob.set_status_exitcode_signal"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.qadapters.QueueJob.set_status_exitcode_signal">[docs]</a>    <span class="k">def</span> <span class="nf">set_status_exitcode_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">exitcode</span><span class="p">,</span> <span class="n">signal</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">exitcode</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">signal</span> <span class="o">=</span> <span class="n">status</span><span class="p">,</span> <span class="n">exitcode</span><span class="p">,</span> <span class="n">signal</span>
</div>
<div class="viewcode-block" id="QueueJob.likely_code_error"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.qadapters.QueueJob.likely_code_error">[docs]</a>    <span class="k">def</span> <span class="nf">likely_code_error</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        See http://man7.org/linux/man-pages/man7/signal.7.html</span>

<span class="sd">        SIGHUP        1       Term    Hangup detected on controlling terminal or death of controlling process</span>
<span class="sd">        SIGINT        2       Term    Interrupt from keyboard</span>
<span class="sd">        SIGQUIT       3       Core    Quit from keyboard</span>
<span class="sd">        SIGILL        4       Core    Illegal Instruction</span>
<span class="sd">        SIGABRT       6       Core    Abort signal from abort(3)</span>
<span class="sd">        SIGFPE        8       Core    Floating point exception</span>
<span class="sd">        SIGKILL       9       Term    Kill signal</span>
<span class="sd">        SIGSEGV      11       Core    Invalid memory reference</span>
<span class="sd">        SIGPIPE      13       Term    Broken pipe: write to pipe with no readers</span>
<span class="sd">        SIGALRM      14       Term    Timer signal from alarm(2)</span>
<span class="sd">        SIGTERM      15       Term    Termination signal</span>
<span class="sd">        SIGUSR1   30,10,16    Term    User-defined signal 1</span>
<span class="sd">        SIGUSR2   31,12,17    Term    User-defined signal 2</span>
<span class="sd">        SIGCHLD   20,17,18    Ign     Child stopped or terminated</span>
<span class="sd">        SIGCONT   19,18,25    Cont    Continue if stopped</span>
<span class="sd">        SIGSTOP   17,19,23    Stop    Stop process</span>
<span class="sd">        SIGTSTP   18,20,24    Stop    Stop typed at terminal</span>
<span class="sd">        SIGTTIN   21,21,26    Stop    Terminal input for background process</span>
<span class="sd">        SIGTTOU   22,22,27    Stop    Terminal output for background process</span>

<span class="sd">        The signals SIGKILL and SIGSTOP cannot be caught, blocked, or ignored.</span>

<span class="sd">        Next the signals not in the POSIX.1-1990 standard but described in</span>
<span class="sd">        SUSv2 and POSIX.1-2001.</span>

<span class="sd">        Signal       Value     Action   Comment</span>
<span class="sd">        ────────────────────────────────────────────────────────────────────</span>
<span class="sd">        SIGBUS      10,7,10     Core    Bus error (bad memory access)</span>
<span class="sd">        SIGPOLL                 Term    Pollable event (Sys V).</span>
<span class="sd">                                        Synonym for SIGIO</span>
<span class="sd">        SIGPROF     27,27,29    Term    Profiling timer expired</span>
<span class="sd">        SIGSYS      12,31,12    Core    Bad argument to routine (SVr4)</span>
<span class="sd">        SIGTRAP        5        Core    Trace/breakpoint trap</span>
<span class="sd">        SIGURG      16,23,21    Ign     Urgent condition on socket (4.2BSD)</span>
<span class="sd">        SIGVTALRM   26,26,28    Term    Virtual alarm clock (4.2BSD)</span>
<span class="sd">        SIGXCPU     24,24,30    Core    CPU time limit exceeded (4.2BSD)</span>
<span class="sd">        SIGXFSZ     25,25,31    Core    File size limit exceeded (4.2BSD)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">sig_name</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&quot;SIGFPE&quot;</span><span class="p">,):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">received_signal</span><span class="p">(</span><span class="n">sig_name</span><span class="p">):</span> <span class="k">return</span> <span class="n">sig_name</span>
        <span class="k">return</span> <span class="bp">False</span>
</div>
<div class="viewcode-block" id="QueueJob.received_signal"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.qadapters.QueueJob.received_signal">[docs]</a>    <span class="k">def</span> <span class="nf">received_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sig_name</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">signal</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="k">return</span> <span class="bp">False</span>
        <span class="c"># Get the numeric value from signal and compare it with self.signal</span>
        <span class="kn">import</span> <span class="nn">signal</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="n">sig_name</span><span class="p">)</span> 
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="c"># invalid sig_name or sig_name not available on this OS.</span>
            <span class="k">return</span> <span class="bp">False</span>
</div>
<div class="viewcode-block" id="QueueJob.estimated_start_time"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.qadapters.QueueJob.estimated_start_time">[docs]</a>    <span class="k">def</span> <span class="nf">estimated_start_time</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return date with estimated start time. None if it cannot be detected&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">None</span>
</div>
<div class="viewcode-block" id="QueueJob.get_info"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.qadapters.QueueJob.get_info">[docs]</a>    <span class="k">def</span> <span class="nf">get_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">None</span>
</div>
<div class="viewcode-block" id="QueueJob.get_nodes"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.qadapters.QueueJob.get_nodes">[docs]</a>    <span class="k">def</span> <span class="nf">get_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">None</span>
</div>
<div class="viewcode-block" id="QueueJob.get_stats"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.qadapters.QueueJob.get_stats">[docs]</a>    <span class="k">def</span> <span class="nf">get_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">None</span>

</div></div>
<div class="viewcode-block" id="SlurmJob"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.qadapters.SlurmJob">[docs]</a><span class="k">class</span> <span class="nc">SlurmJob</span><span class="p">(</span><span class="n">QueueJob</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Handler for Slurm jobs.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="SlurmJob.estimated_start_time"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.qadapters.SlurmJob.estimated_start_time">[docs]</a>    <span class="k">def</span> <span class="nf">estimated_start_time</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c">#squeue  --start -j  116791</span>
        <span class="c">#  JOBID PARTITION     NAME     USER  ST           START_TIME  NODES NODELIST(REASON)</span>
        <span class="c"># 116791      defq gs6q2wop cyildiri  PD  2014-11-04T09:27:15     16 (QOSResourceLimit)</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="s">&quot;squeue&quot;</span> <span class="s">&quot;--start&quot;</span><span class="p">,</span> <span class="s">&quot;--job </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">qid</span>
        <span class="n">process</span> <span class="o">=</span> <span class="n">Popen</span><span class="p">(</span><span class="n">shlex</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span> <span class="n">stdout</span><span class="o">=</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">PIPE</span><span class="p">)</span>
        <span class="n">process</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">process</span><span class="o">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="bp">None</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">:</span> <span class="k">return</span> <span class="bp">None</span>

        <span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="n">tokens</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">qid</span><span class="p">:</span>
                <span class="n">date_string</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">date_string</span> <span class="o">==</span> <span class="s">&quot;N/A&quot;</span><span class="p">:</span> <span class="k">return</span> <span class="bp">None</span>
                <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">date_string</span><span class="p">,</span> <span class="s">&quot;%Y-%m-</span><span class="si">%d</span><span class="s">T%H:%M:%S&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">None</span>
</div>
<div class="viewcode-block" id="SlurmJob.get_info"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.qadapters.SlurmJob.get_info">[docs]</a>    <span class="k">def</span> <span class="nf">get_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c"># See https://computing.llnl.gov/linux/slurm/sacct.html</span>
        <span class="c">#If SLURM job ids are reset, some job numbers will</span>
        <span class="c">#probably appear more than once refering to different jobs.</span>
        <span class="c">#Without this option only the most recent jobs will be displayed.</span>

        <span class="c">#state Displays the job status, or state.</span>
        <span class="c">#Output can be RUNNING, RESIZING, SUSPENDED, COMPLETED, CANCELLED, FAILED, TIMEOUT, </span>
        <span class="c">#PREEMPTED or NODE_FAIL. If more information is available on the job state than will fit </span>
        <span class="c">#into the current field width (for example, the uid that CANCELLED a job) the state will be followed by a &quot;+&quot;. </span>

        <span class="c">#gmatteo@master2:~</span>
        <span class="c">#sacct --job 112367 --format=jobid,exitcode,state --allocations --parsable2</span>
        <span class="c">#JobID|ExitCode|State</span>
        <span class="c">#112367|0:0|RUNNING</span>
        <span class="c">#scontrol show job 800197 --oneliner</span>

        <span class="c"># For more info</span>
        <span class="c">#login1$ scontrol show job 1676354</span>

        <span class="c">#cmd = &quot;sacct --job %i --format=jobid,exitcode,state --allocations --parsable2&quot; % self.qid</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="s">&quot;scontrol show job </span><span class="si">%i</span><span class="s"> --oneliner&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">qid</span>
        <span class="n">process</span> <span class="o">=</span> <span class="n">Popen</span><span class="p">(</span><span class="n">shlex</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span> <span class="n">stdout</span><span class="o">=</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">PIPE</span><span class="p">)</span>
        <span class="n">process</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">process</span><span class="o">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c">#print(process.stderr.readlines())</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="c">#print(&quot;line&quot;, line)</span>

        <span class="n">tokens</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="n">info</span> <span class="o">=</span> <span class="n">AttrDict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">:</span>
            <span class="c">#print(line)</span>
            <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;=&quot;</span><span class="p">)</span>
            <span class="n">info</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
            <span class="c">#print(info)</span>

        <span class="n">qid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">JobId</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">qid</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">qid</span>
        <span class="n">exitcode</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">ExitCode</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">JobState</span>

        <span class="k">if</span> <span class="s">&quot;:&quot;</span> <span class="ow">in</span> <span class="n">exitcode</span><span class="p">:</span>
            <span class="n">exitcode</span><span class="p">,</span> <span class="n">signal</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">exitcode</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;:&quot;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">exitcode</span><span class="p">,</span> <span class="n">signal</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">exitcode</span><span class="p">),</span> <span class="bp">None</span>

        <span class="n">i</span> <span class="o">=</span> <span class="n">status</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;+&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="n">status</span> <span class="o">=</span> <span class="n">status</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_status_exitcode_signal</span><span class="p">(</span><span class="n">JobStatus</span><span class="o">.</span><span class="n">from_string</span><span class="p">(</span><span class="n">status</span><span class="p">),</span> <span class="n">exitcode</span><span class="p">,</span> <span class="n">signal</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">AttrDict</span><span class="p">(</span><span class="n">exitcode</span><span class="o">=</span><span class="n">exitcode</span><span class="p">,</span> <span class="n">signal</span><span class="o">=</span><span class="n">signal</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="SlurmJob.get_stats"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.qadapters.SlurmJob.get_stats">[docs]</a>    <span class="k">def</span> <span class="nf">get_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="s">&quot;sacct --long --job </span><span class="si">%s</span><span class="s"> --parsable2&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">qid</span>
        <span class="n">process</span> <span class="o">=</span> <span class="n">Popen</span><span class="p">(</span><span class="n">shlex</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span> <span class="n">stdout</span><span class="o">=</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">PIPE</span><span class="p">)</span>
        <span class="n">process</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>

        <span class="n">lines</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;|&quot;</span><span class="p">)</span>
        <span class="n">values</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;|&quot;</span><span class="p">)</span>
        <span class="c">#print(&quot;lines0&quot;, lines[0])</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="n">values</span><span class="p">))</span>

</div></div>
<div class="viewcode-block" id="PbsProJob"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.qadapters.PbsProJob">[docs]</a><span class="k">class</span> <span class="nc">PbsProJob</span><span class="p">(</span><span class="n">QueueJob</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Handler for PbsPro Jobs&quot;&quot;&quot;</span>
    <span class="c"># Mapping PrbPro --&gt; Slurm. From `man qstat`</span>
    <span class="c">#</span>
    <span class="c"># S  The job’s state:</span>
    <span class="c">#      B  Array job has at least one subjob running.</span>
    <span class="c">#      E  Job is exiting after having run.</span>
    <span class="c">#      F  Job is finished.</span>
    <span class="c">#      H  Job is held.</span>
    <span class="c">#      M  Job was moved to another server.</span>
    <span class="c">#      Q  Job is queued.</span>
    <span class="c">#      R  Job is running.</span>
    <span class="c">#      S  Job is suspended.</span>
    <span class="c">#      T  Job is being moved to new location.</span>
    <span class="c">#      U  Cycle-harvesting job is suspended due to keyboard activity.</span>
    <span class="c">#      W  Job is waiting for its submitter-assigned start time to be reached.</span>
    <span class="c">#      X  Subjob has completed execution or has been deleted.</span>

    <span class="n">PBSSTAT_TO_SLURM</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">QueueJob</span><span class="o">.</span><span class="n">S_UNKNOWN</span><span class="p">,</span> <span class="p">[</span>
        <span class="p">(</span><span class="s">&quot;E&quot;</span><span class="p">,</span> <span class="n">QueueJob</span><span class="o">.</span><span class="n">S_FAILED</span><span class="p">),</span>
        <span class="p">(</span><span class="s">&quot;F&quot;</span><span class="p">,</span> <span class="n">QueueJob</span><span class="o">.</span><span class="n">S_COMPLETED</span><span class="p">),</span>
        <span class="p">(</span><span class="s">&quot;Q&quot;</span><span class="p">,</span> <span class="n">QueueJob</span><span class="o">.</span><span class="n">S_PENDING</span><span class="p">),</span>
        <span class="p">(</span><span class="s">&quot;R&quot;</span><span class="p">,</span> <span class="n">QueueJob</span><span class="o">.</span><span class="n">S_RUNNING</span><span class="p">),</span>
        <span class="p">(</span><span class="s">&quot;S&quot;</span><span class="p">,</span> <span class="n">QueueJob</span><span class="o">.</span><span class="n">S_SUSPENDED</span><span class="p">),</span>
    <span class="p">])</span>

<div class="viewcode-block" id="PbsProJob.estimated_start_time"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.qadapters.PbsProJob.estimated_start_time">[docs]</a>    <span class="k">def</span> <span class="nf">estimated_start_time</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># qstat -T - Shows the estimated start time for all jobs in the queue. </span>
        <span class="c">#                                                                           Est</span>
        <span class="c">#                                                            Req&#39;d  Req&#39;d   Start</span>
        <span class="c">#Job ID          Username Queue    Jobname    SessID NDS TSK Memory Time  S Time</span>
        <span class="c">#--------------- -------- -------- ---------- ------ --- --- ------ ----- - -----</span>
        <span class="c">#5669001.frontal username large    gs.Pt         --   96  96    --  03:00 Q    --</span>
        <span class="n">process</span> <span class="o">=</span> <span class="n">Popen</span><span class="p">([</span><span class="s">&quot;qstat&quot;</span> <span class="s">&quot;-T&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qid</span><span class="p">)],</span> <span class="n">stdout</span><span class="o">=</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">PIPE</span><span class="p">)</span>
        <span class="n">process</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">process</span><span class="o">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="bp">None</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">readlines</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">sdate</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">sdate</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&quot;--&quot;</span><span class="p">,</span> <span class="s">&quot;?&quot;</span><span class="p">):</span> <span class="k">return</span> <span class="bp">None</span>
        <span class="c"># TODO One should convert to datetime</span>
        <span class="k">return</span> <span class="n">sdate</span>
</div>
<div class="viewcode-block" id="PbsProJob.get_info"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.qadapters.PbsProJob.get_info">[docs]</a>    <span class="k">def</span> <span class="nf">get_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c">#$&gt; qstat 5666289</span>
        <span class="c">#frontal1:</span>
        <span class="c">#                                                            Req&#39;d  Req&#39;d   Elap</span>
        <span class="c">#Job ID          Username Queue    Jobname    SessID NDS TSK Memory Time  S Time</span>
        <span class="c">#--------------- -------- -------- ---------- ------ --- --- ------ ----- - -----</span>
        <span class="c">#5666289.frontal username main_ivy MorfeoTChk  57546   1   4    --  08:00 R 00:17</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="s">&quot;qstat </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">qid</span>
        <span class="n">process</span> <span class="o">=</span> <span class="n">Popen</span><span class="p">(</span><span class="n">shlex</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span> <span class="n">stdout</span><span class="o">=</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">PIPE</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">process</span><span class="o">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c">#print(process.stderr.readlines())</span>
            <span class="k">return</span> <span class="bp">None</span>

        <span class="n">out</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">readlines</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PBSSTAT_TO_SLURM</span><span class="p">[</span><span class="n">out</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">9</span><span class="p">]]</span>

        <span class="c"># Exit code and signal are not available.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_status_exitcode_signal</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
</div></div>
<div class="viewcode-block" id="SgeJob"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.qadapters.SgeJob">[docs]</a><span class="k">class</span> <span class="nc">SgeJob</span><span class="p">(</span><span class="n">QueueJob</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Not supported&quot;&quot;&quot;</span>

</div>
<div class="viewcode-block" id="all_subclasses"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.qadapters.all_subclasses">[docs]</a><span class="k">def</span> <span class="nf">all_subclasses</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a class `cls`, this recursive function returns a list with</span>
<span class="sd">    all subclasses, subclasses of subclasses, and so on.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">subclasses</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">__subclasses__</span><span class="p">()</span> 
    <span class="k">return</span> <span class="n">subclasses</span> <span class="o">+</span> <span class="p">[</span><span class="n">g</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">subclasses</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">all_subclasses</span><span class="p">(</span><span class="n">s</span><span class="p">)]</span>

</div>
<div class="viewcode-block" id="show_qparams"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.qadapters.show_qparams">[docs]</a><span class="k">def</span> <span class="nf">show_qparams</span><span class="p">(</span><span class="n">qtype</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Print to the given stream the template of the :class:`QueueAdapter` of type `qtype`.&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">cls</span> <span class="ow">in</span> <span class="n">all_subclasses</span><span class="p">(</span><span class="n">QueueAdapter</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">cls</span><span class="o">.</span><span class="n">QTYPE</span> <span class="o">==</span> <span class="n">qtype</span><span class="p">:</span> <span class="k">return</span> <span class="n">stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">cls</span><span class="o">.</span><span class="n">QTEMPLATE</span><span class="p">)</span>

    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Cannot find class associated to qtype </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">qtype</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="all_qtypes"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.qadapters.all_qtypes">[docs]</a><span class="k">def</span> <span class="nf">all_qtypes</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;List of all qtypes supported.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">cls</span><span class="o">.</span><span class="n">QTYPE</span> <span class="k">for</span> <span class="n">cls</span> <span class="ow">in</span> <span class="n">all_subclasses</span><span class="p">(</span><span class="n">QueueAdapter</span><span class="p">)]</span>

</div>
<div class="viewcode-block" id="make_qadapter"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.qadapters.make_qadapter">[docs]</a><span class="k">def</span> <span class="nf">make_qadapter</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the concrete :class:`QueueAdapter` class from a string.</span>
<span class="sd">    Note that one can register a customized version with:</span>

<span class="sd">    .. example::</span>

<span class="sd">        from qadapters import SlurmAdapter </span>

<span class="sd">        class MyAdapter(SlurmAdapter):</span>
<span class="sd">            QTYPE = &quot;myslurm&quot;</span>
<span class="sd">            # Add your customized code here</span>

<span class="sd">        # Register your class.</span>
<span class="sd">        SlurmAdapter.register(MyAdapter)</span>

<span class="sd">        make_qadapter(qtype=&quot;myslurm&quot;, **kwargs)</span>

<span class="sd">    .. warning::</span>

<span class="sd">        MyAdapter should be pickleable, hence one should declare it </span>
<span class="sd">        at the module level so that pickle can import it at run-time.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># Get all known subclasses of QueueAdapter.</span>
    <span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span><span class="o">.</span><span class="n">QTYPE</span><span class="p">:</span> <span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">all_subclasses</span><span class="p">(</span><span class="n">QueueAdapter</span><span class="p">)}</span>
    <span class="n">qtype</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&quot;queue&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;qtype&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">d</span><span class="p">[</span><span class="n">qtype</span><span class="p">](</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="QueueAdapterError"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.qadapters.QueueAdapterError">[docs]</a><span class="k">class</span> <span class="nc">QueueAdapterError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base Error class for exceptions raise by QueueAdapter.&quot;&quot;&quot;</span>
</div>
<div class="viewcode-block" id="MaxNumLaunchesError"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.qadapters.MaxNumLaunchesError">[docs]</a><span class="k">class</span> <span class="nc">MaxNumLaunchesError</span><span class="p">(</span><span class="n">QueueAdapterError</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Raised by `submit_to_queue` if we try to submit more than `max_num_launches` times.&quot;&quot;&quot;</span>

</div>
<div class="viewcode-block" id="QueueAdapter"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.qadapters.QueueAdapter">[docs]</a><span class="k">class</span> <span class="nc">QueueAdapter</span><span class="p">(</span><span class="n">six</span><span class="o">.</span><span class="n">with_metaclass</span><span class="p">(</span><span class="n">abc</span><span class="o">.</span><span class="n">ABCMeta</span><span class="p">,</span> <span class="nb">object</span><span class="p">)):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The `QueueAdapter` is responsible for all interactions with a specific queue management system.</span>
<span class="sd">    This includes handling all details of queue script format as well as queue submission and management.</span>

<span class="sd">    This is the **abstract** base class defining the methods that must be implemented by the concrete classes.</span>
<span class="sd">    Concrete classes should extend this class with implementations that work on specific queue systems.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">Error</span> <span class="o">=</span> <span class="n">QueueAdapterError</span>

    <span class="n">MaxNumLaunchesError</span> <span class="o">=</span> <span class="n">MaxNumLaunchesError</span>

    <span class="n">Job</span> <span class="o">=</span> <span class="n">QueueJob</span>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="QueueAdapter.autodoc"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.qadapters.QueueAdapter.autodoc">[docs]</a>    <span class="k">def</span> <span class="nf">autodoc</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;&quot;&quot;</span>
<span class="s"># dictionary with info on the hardware available on this particular queue.</span>
<span class="s">hardware:  </span>
<span class="s">    num_nodes:        # Number of nodes available on this queue. Mandatory</span>
<span class="s">    sockets_per_node: # Mandatory.</span>
<span class="s">    cores_per_socket: # Mandatory.</span>

<span class="s"># dictionary with the options used to prepare the enviroment before submitting the job</span>
<span class="s">job:</span>
<span class="s">    setup:       # List of commands (str) executed before running (default empty)</span>
<span class="s">    omp_env:     # Dictionary with OpenMP env variables (default empty i.e. no OpenMP)</span>
<span class="s">    modules:     # List of modules to be imported (default empty)</span>
<span class="s">    shell_env:   # Dictionary with shell env variables.</span>
<span class="s">    mpi_runner:  # MPI runner i.e. mpirun, mpiexec, Default is None i.e. no mpirunner</span>
<span class="s">    pre_run:     # List of commands executed before the run (default: empty)</span>
<span class="s">    post_run:    # List of commands executed after the run (default: empty)</span>

<span class="s"># dictionary with the name of the queue and optional parameters </span>
<span class="s"># used to build/customize the header of the submission script.</span>
<span class="s">queue:</span>
<span class="s">    qname:   # Name of the queue (mandatory)</span>
<span class="s">    qparams: # Dictionary with values used to generate the header of the job script</span>
<span class="s">             # See pymatgen.io.abinitio.qadapters.py for the list of supported values.</span>

<span class="s"># dictionary with the constraints that must be fulfilled in order to run on this queue.</span>
<span class="s">limits:</span>
<span class="s">    min_cores:         # Minimum number of cores (default 1)</span>
<span class="s">    max_cores:         # Maximum number of cores (mandatory)</span>
<span class="s">    min_mem_per_proc:  # Minimum memory per MPI process in Mb, units can be specified e.g. 1.4 Gb</span>
<span class="s">                       # (default hardware.mem_per_core)</span>
<span class="s">    max_mem_per_proc:  # Maximum memory per MPI process in Mb, units can be specified e.g. `1.4Gb`</span>
<span class="s">                       # (default hardware.mem_per_node)</span>
<span class="s">    condition:         # MongoDB-like condition (default empty, i.e. not used)</span>
<span class="s">&quot;&quot;&quot;</span>
</div>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            qname: Name of the queue.</span>
<span class="sd">            qparams: Dictionary with the parameters used in the template.</span>
<span class="sd">            setup: String or list of commands to execute during the initial setup.</span>
<span class="sd">            modules: String or list of modules to load before running the application.</span>
<span class="sd">            shell_env: Dictionary with the environment variables to export before running the application.</span>
<span class="sd">            omp_env: Dictionary with the OpenMP variables.</span>
<span class="sd">            pre_run: String or list of commands to execute before launching the calculation.</span>
<span class="sd">            post_run: String or list of commands to execute once the calculation is completed.</span>
<span class="sd">            mpi_runner: Path to the MPI runner or :class:`MpiRunner` instance. None if not used</span>
<span class="sd">            max_num_launches: Maximum number of submissions that can be done. Defaults to 10</span>
<span class="sd">            qverbatim:</span>
<span class="sd">            min_cores, max_cores: Minimum and maximum number of cores that can be used</span>
<span class="sd">            min_mem_per_proc=Minimun memory per process in megabytes.</span>
<span class="sd">            max_mem_per_proc=Maximum memory per process in megabytes.</span>
<span class="sd">            timelimit: Time limit in seconds</span>
<span class="sd">            priority: Priority level, integer number &gt; 0</span>
<span class="sd">            allocate_nodes: True if we must allocate entire nodes&quot;</span>
<span class="sd">            condition: Condition object (dictionary)</span>

<span class="sd">        .. note::</span>

<span class="sd">            priority is a non-negative integer used to order the qadapters. The :class:`TaskManager` will</span>
<span class="sd">                try to run jobs on the qadapter with the highest priority if possible</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># TODO</span>
        <span class="c">#task_classes</span>

        <span class="c"># Make defensive copies so that we can change the values at runtime.</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">priority</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;priority&quot;</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">hw</span> <span class="o">=</span> <span class="n">Hardware</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;hardware&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parse_queue</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;queue&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parse_limits</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;limits&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parse_job</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;job&quot;</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Found unknown keywords:</span><span class="se">\n</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">validate_qparams</span><span class="p">()</span>

        <span class="c"># List of dictionaries with the parameters used to submit jobs</span>
        <span class="c"># The launcher will use this information to increase the resources</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">launches</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_num_launches</span> <span class="o">=</span> <span class="p">[],</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;max_num_launches&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

        <span class="c"># Initialize some values from the info reported in the partition.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_mpi_procs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">min_cores</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_mem_per_proc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">min_mem_per_proc</span><span class="p">)</span>

        <span class="c"># Final consistency check.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validate_qparams</span><span class="p">()</span>

<div class="viewcode-block" id="QueueAdapter.validate_qparams"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.qadapters.QueueAdapter.validate_qparams">[docs]</a>    <span class="k">def</span> <span class="nf">validate_qparams</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if the keys specified by the user in qparams are supported.</span>

<span class="sd">        Raise:</span>
<span class="sd">            `ValueError` if errors.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># No validation for ShellAdapter.</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ShellAdapter</span><span class="p">):</span> <span class="k">return</span>

        <span class="c"># Parse the template so that we know the list of supported options.</span>
        <span class="n">err_msg</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">qparams</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">param</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">supported_qparams</span><span class="p">:</span>
                <span class="n">err_msg</span> <span class="o">+=</span> <span class="s">&quot;Unsupported QUEUE parameter name </span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">param</span>
                <span class="n">err_msg</span> <span class="o">+=</span> <span class="s">&quot;Supported are: </span><span class="se">\n</span><span class="s">&quot;</span>
                <span class="k">for</span> <span class="n">param_sup</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">supported_qparams</span><span class="p">:</span>
                    <span class="n">err_msg</span> <span class="o">+=</span> <span class="s">&quot;    </span><span class="si">%s</span><span class="s"> </span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">param_sup</span>

        <span class="k">if</span> <span class="n">err_msg</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_parse_limits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_timelimit</span><span class="p">(</span><span class="n">timelimit_parser</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;timelimit&quot;</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_cores</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;min_cores&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_cores</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;max_cores&quot;</span><span class="p">))</span>
        <span class="c"># FIXME: Neeed because autoparal 1 with paral_kgb 1 is not able to estimate memory </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_mem_per_proc</span> <span class="o">=</span> <span class="n">any2mb</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;min_mem_per_proc&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hw</span><span class="o">.</span><span class="n">mem_per_core</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_mem_per_proc</span> <span class="o">=</span> <span class="n">any2mb</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;max_mem_per_proc&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hw</span><span class="o">.</span><span class="n">mem_per_node</span><span class="p">))</span>
        <span class="c">#self.allocate_nodes = bool(d.pop(&quot;allocate_nodes&quot;, False))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">condition</span> <span class="o">=</span> <span class="n">Condition</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;condition&quot;</span><span class="p">,</span> <span class="p">{}))</span>

        <span class="k">if</span> <span class="n">d</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Found unknown keyword(s) in limits section:</span><span class="se">\n</span><span class="s"> </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">d</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">_parse_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
        <span class="n">setup</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;setup&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">is_string</span><span class="p">(</span><span class="n">setup</span><span class="p">):</span> <span class="n">setup</span> <span class="o">=</span> <span class="p">[</span><span class="n">setup</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup</span> <span class="o">=</span> <span class="n">setup</span><span class="p">[:]</span> <span class="k">if</span> <span class="n">setup</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="p">[]</span>

        <span class="n">omp_env</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;omp_env&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">omp_env</span> <span class="o">=</span> <span class="n">omp_env</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="k">if</span> <span class="n">omp_env</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="p">{}</span>

        <span class="n">modules</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;modules&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">is_string</span><span class="p">(</span><span class="n">modules</span><span class="p">):</span> <span class="n">modules</span> <span class="o">=</span> <span class="p">[</span><span class="n">modules</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">modules</span> <span class="o">=</span> <span class="n">modules</span><span class="p">[:]</span> <span class="k">if</span> <span class="n">modules</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="p">[]</span>

        <span class="n">shell_env</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;shell_env&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shell_env</span> <span class="o">=</span> <span class="n">shell_env</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="k">if</span> <span class="n">shell_env</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mpi_runner</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;mpi_runner&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mpi_runner</span><span class="p">,</span> <span class="n">MpiRunner</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mpi_runner</span> <span class="o">=</span> <span class="n">MpiRunner</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mpi_runner</span><span class="p">)</span>

        <span class="n">pre_run</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;pre_run&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">is_string</span><span class="p">(</span><span class="n">pre_run</span><span class="p">):</span> <span class="n">pre_run</span> <span class="o">=</span> <span class="p">[</span><span class="n">pre_run</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pre_run</span> <span class="o">=</span> <span class="n">pre_run</span><span class="p">[:]</span> <span class="k">if</span> <span class="n">pre_run</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="p">[]</span>

        <span class="n">post_run</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;post_run&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">is_string</span><span class="p">(</span><span class="n">post_run</span><span class="p">):</span> <span class="n">post_run</span> <span class="o">=</span> <span class="p">[</span><span class="n">post_run</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">post_run</span> <span class="o">=</span> <span class="n">post_run</span><span class="p">[:]</span> <span class="k">if</span> <span class="n">post_run</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">d</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Found unknown keyword(s) in job section:</span><span class="se">\n</span><span class="s"> </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">d</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">_parse_queue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
        <span class="c"># Init params</span>
        <span class="n">qparams</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;qparams&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_qparams</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">qparams</span><span class="p">)</span> <span class="k">if</span> <span class="n">qparams</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_qname</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;qname&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">d</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Found unknown keyword(s) in queue section:</span><span class="se">\n</span><span class="s"> </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">d</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">qname</span><span class="p">)]</span>
        <span class="n">app</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">append</span>
        <span class="n">app</span><span class="p">(</span><span class="s">&quot;Hardware:</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hw</span><span class="p">))</span>
        <span class="c">#lines.extend([&quot;qparams:\n&quot;, str(self.qparams)])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_omp</span><span class="p">:</span> <span class="n">app</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">omp_env</span><span class="p">))</span>

        <span class="k">return</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">qparams</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dictionary with the parameters used to construct the header.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_qparams</span>

    <span class="nd">@lazy_property</span>
<div class="viewcode-block" id="QueueAdapter.supported_qparams"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.qadapters.QueueAdapter.supported_qparams">[docs]</a>    <span class="k">def</span> <span class="nf">supported_qparams</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Dictionary with the supported parameters that can be passed to the </span>
<span class="sd">        queue manager (obtained by parsing QTEMPLATE).</span>
<span class="sd">        &quot;&quot;&quot;</span> 
        <span class="kn">import</span> <span class="nn">re</span>
        <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s">&quot;\$\$\{(\w+)\}&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">QTEMPLATE</span><span class="p">)</span>
</div>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">has_mpi</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;True if we are using MPI&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mpi_runner</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">has_omp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;True if we are using OpenMP threads&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&quot;omp_env&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">bool</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&quot;omp_env&quot;</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">num_cores</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Total number of cores employed&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mpi_procs</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">omp_threads</span> 

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">omp_threads</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Number of OpenMP threads.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_omp</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">omp_env</span><span class="p">[</span><span class="s">&quot;OMP_NUM_THREADS&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pure_mpi</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;True if only MPI is used.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_mpi</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_omp</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pure_omp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;True if only OpenMP is used.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_omp</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_mpi</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">hybrid_mpi_omp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;True if we are running in MPI+Openmp mode.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_omp</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_mpi</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">run_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;String with info on the run.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s">&quot;MPI: </span><span class="si">%d</span><span class="s">, OMP: </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mpi_procs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">omp_threads</span><span class="p">)</span>

<div class="viewcode-block" id="QueueAdapter.deepcopy"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.qadapters.QueueAdapter.deepcopy">[docs]</a>    <span class="k">def</span> <span class="nf">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Deep copy of the object.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="QueueAdapter.record_launch"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.qadapters.QueueAdapter.record_launch">[docs]</a>    <span class="k">def</span> <span class="nf">record_launch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">queue_id</span><span class="p">):</span> <span class="c"># retcode):</span>
        <span class="sd">&quot;&quot;&quot;Save submission&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">launches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">AttrDict</span><span class="p">(</span><span class="n">queue_id</span><span class="o">=</span><span class="n">queue_id</span><span class="p">,</span> <span class="n">mpi_procs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mpi_procs</span><span class="p">,</span> <span class="n">omp_threads</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">omp_threads</span><span class="p">,</span>
                     <span class="n">mem_per_proc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mem_per_proc</span><span class="p">,</span> <span class="n">timelimit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timelimit</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">launches</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="QueueAdapter.remove_launch"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.qadapters.QueueAdapter.remove_launch">[docs]</a>    <span class="k">def</span> <span class="nf">remove_launch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove launch with the given index.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">launches</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
</div>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">num_launches</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Number of submission tried with this adapter so far.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">launches</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">last_launch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the last launch.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">launches</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">launches</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>

<div class="viewcode-block" id="QueueAdapter.validate"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.qadapters.QueueAdapter.validate">[docs]</a>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Validate the parameters of the run. Raises self.Error if invalid parameters.&quot;&quot;&quot;</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">app</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">append</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_cores</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mpi_procs</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">omp_threads</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_cores</span><span class="p">:</span>
            <span class="n">app</span><span class="p">(</span><span class="s">&quot;self.max_cores &gt;= mpi_procs * omp_threads &gt;= self.min_cores not satisfied&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">omp_threads</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">hw</span><span class="o">.</span><span class="n">cores_per_node</span><span class="p">:</span>
            <span class="n">app</span><span class="p">(</span><span class="s">&quot;omp_threads &gt; hw.cores_per_node&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mem_per_proc</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">hw</span><span class="o">.</span><span class="n">mem_per_node</span><span class="p">:</span>
            <span class="n">app</span><span class="p">(</span><span class="s">&quot;mem_mb &gt;= self.hw.mem_per_node&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_mem_per_proc</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mem_per_proc</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_mem_per_proc</span><span class="p">:</span>
            <span class="n">app</span><span class="p">(</span><span class="s">&quot;self.max_mem_per_proc &gt;= mem_mb &gt;= self.min_mem_per_proc not satisfied&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">priority</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span> 
            <span class="n">app</span><span class="p">(</span><span class="s">&quot;priority must be &gt; 0&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_cores</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hw</span><span class="o">.</span><span class="n">num_cores</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_cores</span><span class="p">):</span>
            <span class="n">app</span><span class="p">(</span><span class="s">&quot;1 &lt;= min_cores &lt;= hardware num_cores &gt;= max_cores not satisfied&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">errors</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">errors</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="QueueAdapter.set_omp_threads"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.qadapters.QueueAdapter.set_omp_threads">[docs]</a>    <span class="k">def</span> <span class="nf">set_omp_threads</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">omp_threads</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the number of OpenMP threads.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">omp_env</span><span class="p">[</span><span class="s">&quot;OMP_NUM_THREADS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">omp_threads</span>
</div>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">mpi_procs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Number of CPUs used for MPI.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mpi_procs</span>

<div class="viewcode-block" id="QueueAdapter.set_mpi_procs"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.qadapters.QueueAdapter.set_mpi_procs">[docs]</a>    <span class="k">def</span> <span class="nf">set_mpi_procs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mpi_procs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the number of MPI processes to mpi_procs&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mpi_procs</span> <span class="o">=</span> <span class="n">mpi_procs</span>
</div>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">qname</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The name of the queue.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_qname</span>

<div class="viewcode-block" id="QueueAdapter.set_qname"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.qadapters.QueueAdapter.set_qname">[docs]</a>    <span class="k">def</span> <span class="nf">set_qname</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the name of the queue.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_qname</span> <span class="o">=</span> <span class="n">qname</span>
</div>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">timelimit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the walltime in seconds.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_timelimit</span>

<div class="viewcode-block" id="QueueAdapter.set_timelimit"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.qadapters.QueueAdapter.set_timelimit">[docs]</a>    <span class="k">def</span> <span class="nf">set_timelimit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timelimit</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the walltime in seconds.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_timelimit</span> <span class="o">=</span> <span class="n">timelimit</span>
</div>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">mem_per_proc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The memory per process in megabytes.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mem_per_proc</span>
                                                
<div class="viewcode-block" id="QueueAdapter.set_mem_per_proc"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.qadapters.QueueAdapter.set_mem_per_proc">[docs]</a>    <span class="k">def</span> <span class="nf">set_mem_per_proc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mem_mb</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the memory per process in megabytes&quot;&quot;&quot;</span>
        <span class="c"># Hack needed because abinit is still not able to estimate memory.</span>
        <span class="k">if</span> <span class="n">mem_mb</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">mem_mb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_mem_per_proc</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_mem_per_proc</span> <span class="o">=</span> <span class="n">mem_mb</span>
</div>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">total_mem</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Total memory required by the job in megabytes.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Memory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mem_per_proc</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">mpi_procs</span><span class="p">,</span> <span class="s">&quot;Mb&quot;</span><span class="p">)</span>

    <span class="nd">@abc.abstractmethod</span>
<div class="viewcode-block" id="QueueAdapter.cancel"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.qadapters.QueueAdapter.cancel">[docs]</a>    <span class="k">def</span> <span class="nf">cancel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Cancel the job. </span>

<span class="sd">        Args:</span>
<span class="sd">            job_id: Job identifier.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Exit status.</span>
<span class="sd">        &quot;&quot;&quot;</span>
</div>
<div class="viewcode-block" id="QueueAdapter.can_run_pconf"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.qadapters.QueueAdapter.can_run_pconf">[docs]</a>    <span class="k">def</span> <span class="nf">can_run_pconf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pconf</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;True if the qadapter in principle is able to run the :class:`ParalConf` pconf&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_cores</span> <span class="o">&gt;=</span> <span class="n">pconf</span><span class="o">.</span><span class="n">num_cores</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_cores</span><span class="p">:</span> <span class="k">return</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">hw</span><span class="o">.</span><span class="n">can_use_omp_threads</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">omp_threads</span><span class="p">):</span> <span class="k">return</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="n">pconf</span><span class="o">.</span><span class="n">mem_per_proc</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">hw</span><span class="o">.</span><span class="n">mem_per_node</span><span class="p">:</span> <span class="k">return</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">condition</span><span class="p">(</span><span class="n">pconf</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="QueueAdapter.distribute"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.qadapters.QueueAdapter.distribute">[docs]</a>    <span class="k">def</span> <span class="nf">distribute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mpi_procs</span><span class="p">,</span> <span class="n">omp_threads</span><span class="p">,</span> <span class="n">mem_per_proc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns (num_nodes, mpi_per_node)</span>

<span class="sd">        Aggressive: When Open MPI thinks that it is in an exactly- or under-subscribed mode</span>
<span class="sd">        (i.e., the number of running processes is equal to or less than the number of available processors),</span>
<span class="sd">        MPI processes will automatically run in aggressive mode, meaning that they will never voluntarily give</span>
<span class="sd">        up the processor to other processes. With some network transports, this means that Open MPI will spin</span>
<span class="sd">        in tight loops attempting to make message passing progress, effectively causing other processes to not get</span>
<span class="sd">        any CPU cycles (and therefore never make any progress)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">class</span> <span class="nc">Distrib</span><span class="p">(</span><span class="n">namedtuple</span><span class="p">(</span><span class="s">&quot;Distrib&quot;</span><span class="p">,</span> <span class="s">&quot;num_nodes mpi_per_node exact&quot;</span><span class="p">)):</span>
            <span class="k">pass</span>
            <span class="c">#@property</span>
            <span class="c">#def mem_per_node</span>
            <span class="c">#    return self.mpi_per_node * mem_per_proc</span>
            <span class="c">#def set_nodes(self, nodes):</span>

        <span class="n">hw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hw</span>

        <span class="c"># TODO: Add check on user-memory</span>
        <span class="k">if</span> <span class="n">mem_per_proc</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&quot;mem_per_proc &lt;= 0&quot;</span><span class="p">)</span>
            <span class="n">mem_per_proc</span> <span class="o">=</span> <span class="n">hw</span><span class="o">.</span><span class="n">mem_per_core</span>

        <span class="k">if</span> <span class="n">mem_per_proc</span> <span class="o">&gt;</span> <span class="n">hw</span><span class="o">.</span><span class="n">mem_per_node</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span>
                <span class="s">&quot;mem_per_proc &gt; mem_per_node.</span><span class="se">\n</span><span class="s"> Cannot distribute mpi_procs </span><span class="si">%d</span><span class="s">, omp_threads </span><span class="si">%d</span><span class="s">, mem_per_proc </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span>
                             <span class="p">(</span><span class="n">mpi_procs</span><span class="p">,</span> <span class="n">omp_threads</span><span class="p">,</span> <span class="n">mem_per_proc</span><span class="p">))</span>

        <span class="c"># Try to use all then cores in the node.</span>
        <span class="n">num_nodes</span><span class="p">,</span> <span class="n">rest_cores</span> <span class="o">=</span> <span class="n">hw</span><span class="o">.</span><span class="n">divmod_node</span><span class="p">(</span><span class="n">mpi_procs</span><span class="p">,</span> <span class="n">omp_threads</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">num_nodes</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">mpi_procs</span> <span class="o">*</span> <span class="n">mem_per_proc</span> <span class="o">&lt;=</span> <span class="n">hw</span><span class="o">.</span><span class="n">mem_per_node</span><span class="p">:</span>
            <span class="c"># One node is enough</span>
            <span class="k">return</span> <span class="n">Distrib</span><span class="p">(</span><span class="n">num_nodes</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">mpi_per_node</span><span class="o">=</span><span class="n">mpi_procs</span><span class="p">,</span> <span class="n">exact</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">num_nodes</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="n">num_nodes</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">mpi_per_node</span> <span class="o">=</span> <span class="n">mpi_procs</span> <span class="o">//</span> <span class="n">num_nodes</span>
        <span class="k">if</span> <span class="n">mpi_per_node</span> <span class="o">*</span> <span class="n">mem_per_proc</span> <span class="o">&lt;=</span> <span class="n">hw</span><span class="o">.</span><span class="n">mem_per_node</span> <span class="ow">and</span> <span class="n">rest_cores</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c"># Commensurate with nodes.</span>
            <span class="k">return</span> <span class="n">Distrib</span><span class="p">(</span><span class="n">num_nodes</span><span class="o">=</span><span class="n">num_nodes</span><span class="p">,</span> <span class="n">mpi_per_node</span><span class="o">=</span><span class="n">mpi_per_node</span><span class="p">,</span> <span class="n">exact</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="c">#if mode == &quot;block&quot;, &quot;cyclic&quot;</span>

        <span class="c"># Try first to pack MPI processors in a node as much as possible</span>
        <span class="n">mpi_per_node</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">hw</span><span class="o">.</span><span class="n">mem_per_node</span> <span class="o">/</span> <span class="n">mem_per_proc</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">mpi_per_node</span> <span class="o">!=</span> <span class="mi">0</span>
        <span class="n">num_nodes</span> <span class="o">=</span> <span class="p">(</span><span class="n">mpi_procs</span> <span class="o">*</span> <span class="n">omp_threads</span><span class="p">)</span> <span class="o">//</span> <span class="n">mpi_per_node</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;exact --&gt; false&quot;</span><span class="p">,</span> <span class="n">num_nodes</span><span class="p">,</span> <span class="n">mpi_per_node</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">mpi_per_node</span> <span class="o">*</span> <span class="n">omp_threads</span> <span class="o">&lt;=</span> <span class="n">hw</span><span class="o">.</span><span class="n">cores_per_node</span> <span class="ow">and</span> <span class="n">mem_per_proc</span> <span class="o">&lt;=</span> <span class="n">hw</span><span class="o">.</span><span class="n">mem_per_node</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Distrib</span><span class="p">(</span><span class="n">num_nodes</span><span class="o">=</span><span class="n">num_nodes</span><span class="p">,</span> <span class="n">mpi_per_node</span><span class="o">=</span><span class="n">mpi_per_node</span><span class="p">,</span> <span class="n">exact</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">mpi_procs</span> <span class="o">*</span> <span class="n">omp_threads</span><span class="p">)</span> <span class="o">%</span> <span class="n">mpi_per_node</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c"># Have to reduce the number of MPI procs per node</span>
            <span class="k">for</span> <span class="n">mpi_per_node</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">mpi_per_node</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">mpi_per_node</span> <span class="o">&gt;</span> <span class="n">hw</span><span class="o">.</span><span class="n">cores_per_node</span><span class="p">:</span> <span class="k">continue</span>
                <span class="n">num_nodes</span> <span class="o">=</span> <span class="p">(</span><span class="n">mpi_procs</span> <span class="o">*</span> <span class="n">omp_threads</span><span class="p">)</span> <span class="o">//</span> <span class="n">mpi_per_node</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">mpi_procs</span> <span class="o">*</span> <span class="n">omp_threads</span><span class="p">)</span> <span class="o">%</span> <span class="n">mpi_per_node</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">mpi_per_node</span> <span class="o">*</span> <span class="n">mem_per_proc</span> <span class="o">&lt;=</span> <span class="n">hw</span><span class="o">.</span><span class="n">mem_per_node</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">Distrib</span><span class="p">(</span><span class="n">num_nodes</span><span class="o">=</span><span class="n">num_nodes</span><span class="p">,</span> <span class="n">mpi_per_node</span><span class="o">=</span><span class="n">mpi_per_node</span><span class="p">,</span> <span class="n">exact</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="s">&quot;Cannot distribute mpi_procs </span><span class="si">%d</span><span class="s">, omp_threads </span><span class="si">%d</span><span class="s">, mem_per_proc </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span>
                            <span class="p">(</span><span class="n">mpi_procs</span><span class="p">,</span> <span class="n">omp_threads</span><span class="p">,</span> <span class="n">mem_per_proc</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="QueueAdapter.optimize_params"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.qadapters.QueueAdapter.optimize_params">[docs]</a>    <span class="k">def</span> <span class="nf">optimize_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method is called in get_subs_dict. Return a dict with parameters to be added to qparams</span>
<span class="sd">        Subclasses may provide a specialized version.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;optimize_params of baseclass --&gt; no optimization available!!!&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{}</span>
</div>
<div class="viewcode-block" id="QueueAdapter.get_subs_dict"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.qadapters.QueueAdapter.get_subs_dict">[docs]</a>    <span class="k">def</span> <span class="nf">get_subs_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return substitution dict for replacements into the template</span>
<span class="sd">        Subclasses may want to customize this method.</span>
<span class="sd">        &quot;&quot;&quot;</span> 
        <span class="c">#d = self.qparams.copy()</span>
        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qparams</span>
        <span class="n">d</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">optimize_params</span><span class="p">())</span>
        <span class="c"># clean null values</span>
        <span class="n">subs_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">}</span>
        <span class="c">#print(&quot;subs_dict:&quot;, subs_dict)</span>
        <span class="k">return</span> <span class="n">subs_dict</span>
</div>
    <span class="k">def</span> <span class="nf">_make_qheader</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_name</span><span class="p">,</span> <span class="n">qout_path</span><span class="p">,</span> <span class="n">qerr_path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a string with the options that are passed to the resource manager.&quot;&quot;&quot;</span>
        <span class="c"># get substitution dict for replacements into the template </span>
        <span class="n">subs_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_subs_dict</span><span class="p">()</span>

        <span class="c"># Set job_name and the names for the stderr and stdout of the </span>
        <span class="c"># queue manager (note the use of the extensions .qout and .qerr</span>
        <span class="c"># so that we can easily locate this file.</span>
        <span class="n">subs_dict</span><span class="p">[</span><span class="s">&#39;job_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">job_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">,</span> <span class="s">&#39;_&#39;</span><span class="p">)</span>
        <span class="n">subs_dict</span><span class="p">[</span><span class="s">&#39;_qout_path&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">qout_path</span>
        <span class="n">subs_dict</span><span class="p">[</span><span class="s">&#39;_qerr_path&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">qerr_path</span>

        <span class="n">qtemplate</span> <span class="o">=</span> <span class="n">QScriptTemplate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">QTEMPLATE</span><span class="p">)</span>
        <span class="c"># might contain unused parameters as leftover $$.</span>
        <span class="n">unclean_template</span> <span class="o">=</span> <span class="n">qtemplate</span><span class="o">.</span><span class="n">safe_substitute</span><span class="p">(</span><span class="n">subs_dict</span><span class="p">)</span>  

        <span class="c"># Remove lines with leftover $$.</span>
        <span class="n">clean_template</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">unclean_template</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="s">&#39;$$&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="n">clean_template</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="k">return</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">clean_template</span><span class="p">)</span>

<div class="viewcode-block" id="QueueAdapter.get_script_str"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.qadapters.QueueAdapter.get_script_str">[docs]</a>    <span class="k">def</span> <span class="nf">get_script_str</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_name</span><span class="p">,</span> <span class="n">launch_dir</span><span class="p">,</span> <span class="n">executable</span><span class="p">,</span> <span class="n">qout_path</span><span class="p">,</span> <span class="n">qerr_path</span><span class="p">,</span>
                       <span class="n">stdin</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a (multi-line) String representing the queue script, e.g. PBS script.</span>
<span class="sd">        Uses the template_file along with internal parameters to create the script.</span>

<span class="sd">        Args:</span>
<span class="sd">            job_name: Name of the job.</span>
<span class="sd">            launch_dir: (str) The directory the job will be launched in.</span>
<span class="sd">            executable: String with the name of the executable to be executed.</span>
<span class="sd">            qout_path Path of the Queue manager output file.</span>
<span class="sd">            qerr_path: Path of the Queue manager error file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># PbsPro does not accept job_names longer than 15 chars.</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">job_name</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">14</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">PbsProAdapter</span><span class="p">):</span>
            <span class="n">job_name</span> <span class="o">=</span> <span class="n">job_name</span><span class="p">[:</span><span class="mi">14</span><span class="p">]</span>

        <span class="c"># Construct the header for the Queue Manager.</span>
        <span class="n">qheader</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_qheader</span><span class="p">(</span><span class="n">job_name</span><span class="p">,</span> <span class="n">qout_path</span><span class="p">,</span> <span class="n">qerr_path</span><span class="p">)</span>

        <span class="c"># Add the bash section.</span>
        <span class="n">se</span> <span class="o">=</span> <span class="n">ScriptEditor</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="p">:</span>
            <span class="n">se</span><span class="o">.</span><span class="n">add_comment</span><span class="p">(</span><span class="s">&quot;Setup section&quot;</span><span class="p">)</span>
            <span class="n">se</span><span class="o">.</span><span class="n">add_lines</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="p">)</span>
            <span class="n">se</span><span class="o">.</span><span class="n">add_emptyline</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">modules</span><span class="p">:</span>
            <span class="n">se</span><span class="o">.</span><span class="n">add_comment</span><span class="p">(</span><span class="s">&quot;Load Modules&quot;</span><span class="p">)</span>
            <span class="n">se</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span><span class="s">&quot;module purge&quot;</span><span class="p">)</span>
            <span class="n">se</span><span class="o">.</span><span class="n">load_modules</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modules</span><span class="p">)</span>
            <span class="n">se</span><span class="o">.</span><span class="n">add_emptyline</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_omp</span><span class="p">:</span>
            <span class="n">se</span><span class="o">.</span><span class="n">add_comment</span><span class="p">(</span><span class="s">&quot;OpenMp Environment&quot;</span><span class="p">)</span>
            <span class="n">se</span><span class="o">.</span><span class="n">declare_vars</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">omp_env</span><span class="p">)</span>
            <span class="n">se</span><span class="o">.</span><span class="n">add_emptyline</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shell_env</span><span class="p">:</span>
            <span class="n">se</span><span class="o">.</span><span class="n">add_comment</span><span class="p">(</span><span class="s">&quot;Shell Environment&quot;</span><span class="p">)</span>
            <span class="n">se</span><span class="o">.</span><span class="n">declare_vars</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shell_env</span><span class="p">)</span>
            <span class="n">se</span><span class="o">.</span><span class="n">add_emptyline</span><span class="p">()</span>

        <span class="c"># Cd to launch_dir</span>
        <span class="n">se</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span><span class="s">&quot;cd &quot;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">launch_dir</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_run</span><span class="p">:</span>
            <span class="n">se</span><span class="o">.</span><span class="n">add_comment</span><span class="p">(</span><span class="s">&quot;Commands before execution&quot;</span><span class="p">)</span>
            <span class="n">se</span><span class="o">.</span><span class="n">add_lines</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pre_run</span><span class="p">)</span>
            <span class="n">se</span><span class="o">.</span><span class="n">add_emptyline</span><span class="p">()</span>

        <span class="c"># Construct the string to run the executable with MPI and mpi_procs.</span>
        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mpi_runner</span><span class="o">.</span><span class="n">string_to_run</span><span class="p">(</span><span class="n">executable</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mpi_procs</span><span class="p">,</span> 
                                             <span class="n">stdin</span><span class="o">=</span><span class="n">stdin</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">stderr</span><span class="p">)</span>
        <span class="n">se</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">post_run</span><span class="p">:</span>
            <span class="n">se</span><span class="o">.</span><span class="n">add_emptyline</span><span class="p">()</span>
            <span class="n">se</span><span class="o">.</span><span class="n">add_comment</span><span class="p">(</span><span class="s">&quot;Commands after execution&quot;</span><span class="p">)</span>
            <span class="n">se</span><span class="o">.</span><span class="n">add_lines</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">post_run</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">qheader</span> <span class="o">+</span> <span class="n">se</span><span class="o">.</span><span class="n">get_script_str</span><span class="p">()</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
</div>
<div class="viewcode-block" id="QueueAdapter.submit_to_queue"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.qadapters.QueueAdapter.submit_to_queue">[docs]</a>    <span class="k">def</span> <span class="nf">submit_to_queue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">script_file</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Public API: wraps the concrete implementation _submit_to_queue</span>

<span class="sd">        Raises:</span>
<span class="sd">            `self.MaxNumLaunchesError` if we have already tried to submit the job max_num_launches</span>
<span class="sd">            `self.Error` if generic error</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">script_file</span><span class="p">):</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="s">&#39;Cannot find script file located at: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">script_file</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_launches</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_num_launches</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">MaxNumLaunchesError</span><span class="p">(</span><span class="s">&quot;num_launches </span><span class="si">%s</span><span class="s"> == max_num_launches </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_launches</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_num_launches</span><span class="p">))</span>

        <span class="c"># Call the concrete implementation.</span>
        <span class="n">queue_id</span><span class="p">,</span> <span class="n">process</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_submit_to_queue</span><span class="p">(</span><span class="n">script_file</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">record_launch</span><span class="p">(</span><span class="n">queue_id</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">queue_id</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">submit_err_file</span> <span class="o">=</span> <span class="n">script_file</span> <span class="o">+</span> <span class="s">&quot;.err&quot;</span>
            <span class="n">err</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
            <span class="c"># Dump the error and raise</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">submit_err_file</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;sbatch submit process stderr:</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">+</span> <span class="n">err</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;qparams:</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qparams</span><span class="p">))</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">args</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">args</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;Unknown&quot;</span><span class="p">,]</span>

            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="s">&quot;Error in job submission with </span><span class="si">%s</span><span class="s">. file </span><span class="si">%s</span><span class="s"> and args </span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> 
                             <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="n">script_file</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span> <span class="o">+</span> 
                             <span class="s">&quot;The error response reads:</span><span class="se">\n</span><span class="s"> </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>

        <span class="c"># Here we create a concrete instance of QueueJob</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">Job</span><span class="p">(</span><span class="n">queue_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">qname</span><span class="p">),</span> <span class="n">process</span>
</div>
    <span class="nd">@abc.abstractmethod</span>
    <span class="k">def</span> <span class="nf">_submit_to_queue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">script_file</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Submits the job to the queue, probably using subprocess or shutil</span>
<span class="sd">        This method must be provided by the concrete classes and will be called by submit_to_queue</span>

<span class="sd">        Args:</span>
<span class="sd">            script_file:  (str) name of the script file to use (String)</span>

<span class="sd">        Returns:</span>
<span class="sd">            queue_id, process</span>
<span class="sd">        &quot;&quot;&quot;</span>

<div class="viewcode-block" id="QueueAdapter.get_njobs_in_queue"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.qadapters.QueueAdapter.get_njobs_in_queue">[docs]</a>    <span class="k">def</span> <span class="nf">get_njobs_in_queue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        returns the number of jobs in the queue, probably using subprocess or shutil to</span>
<span class="sd">        call a command like &#39;qstat&#39;. returns None when the number of jobs cannot be determined.</span>

<span class="sd">        Args:</span>
<span class="sd">            username: (str) the username of the jobs to count (default is to autodetect)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">username</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="n">username</span> <span class="o">=</span> <span class="n">getpass</span><span class="o">.</span><span class="n">getuser</span><span class="p">()</span>
        <span class="n">njobs</span><span class="p">,</span> <span class="n">process</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_njobs_in_queue</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">process</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">process</span><span class="o">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c"># there&#39;s a problem talking to squeue server?</span>
            <span class="n">err_msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;Error trying to get the number of jobs in the queue&#39;</span> <span class="o">+</span>
                       <span class="s">&#39;The error response reads:</span><span class="se">\n</span><span class="s"> {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">read</span><span class="p">()))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ShellAdapter</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;The number of jobs currently in the queue is: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">njobs</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">njobs</span>
</div>
    <span class="nd">@abc.abstractmethod</span>
    <span class="k">def</span> <span class="nf">_get_njobs_in_queue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Concrete Subclasses must implement this method. Return (njobs, process)</span>
<span class="sd">        &quot;&quot;&quot;</span>

    <span class="c"># Methods to fix problems</span>
<div class="viewcode-block" id="QueueAdapter.add_exclude_nodes"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.qadapters.QueueAdapter.add_exclude_nodes">[docs]</a>    <span class="k">def</span> <span class="nf">add_exclude_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nodes</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_EXCL_NODES_FILE</span><span class="o">.</span><span class="n">add_nodes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qname</span><span class="p">,</span> <span class="n">nodes</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="QueueAdapter.get_exclude_nodes"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.qadapters.QueueAdapter.get_exclude_nodes">[docs]</a>    <span class="k">def</span> <span class="nf">get_exclude_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_EXCL_NODES_FILE</span><span class="o">.</span><span class="n">read_nodes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qname</span><span class="p">)</span>
</div>
    <span class="nd">@abc.abstractmethod</span>
<div class="viewcode-block" id="QueueAdapter.exclude_nodes"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.qadapters.QueueAdapter.exclude_nodes">[docs]</a>    <span class="k">def</span> <span class="nf">exclude_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nodes</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method to exclude nodes in the calculation</span>
<span class="sd">        &quot;&quot;&quot;</span>
</div>
<div class="viewcode-block" id="QueueAdapter.more_mem_per_proc"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.qadapters.QueueAdapter.more_mem_per_proc">[docs]</a>    <span class="k">def</span> <span class="nf">more_mem_per_proc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">factor</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method to increase the amount of memory asked for, by factor.</span>
<span class="sd">        Return: new memory if success, 0 if memory cannot be increased.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">base_increase</span> <span class="o">=</span> <span class="mi">2000</span>
        <span class="n">old_mem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mem_per_proc</span>
        <span class="n">new_mem</span> <span class="o">=</span> <span class="n">old_mem</span> <span class="o">+</span> <span class="n">factor</span><span class="o">*</span><span class="n">base_increase</span>

        <span class="k">if</span> <span class="n">new_mem</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">hw</span><span class="o">.</span><span class="n">mem_per_node</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_mem_per_proc</span><span class="p">(</span><span class="n">new_mem</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">new_mem</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;could not increase mem_per_proc further&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">0</span>
</div>
<div class="viewcode-block" id="QueueAdapter.more_mpi_procs"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.qadapters.QueueAdapter.more_mpi_procs">[docs]</a>    <span class="k">def</span> <span class="nf">more_mpi_procs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">factor</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method to increase the number of MPI procs.</span>
<span class="sd">        Return: new number of processors if success, 0 if processors cannot be increased.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">base_increase</span> <span class="o">=</span> <span class="mi">12</span>
        <span class="n">new_cpus</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mpi_procs</span> <span class="o">+</span> <span class="n">factor</span> <span class="o">*</span> <span class="n">base_increase</span>

        <span class="k">if</span> <span class="n">new_cpus</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">omp_threads</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_cores</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_mpi_procs</span><span class="p">(</span><span class="n">new_cpus</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">new_cpus</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;more_mpi_procs reached the limit&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">0</span>


<span class="c">####################</span>
<span class="c"># Concrete classes #</span>
<span class="c">####################</span>

</div></div>
<div class="viewcode-block" id="ShellAdapter"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.qadapters.ShellAdapter">[docs]</a><span class="k">class</span> <span class="nc">ShellAdapter</span><span class="p">(</span><span class="n">QueueAdapter</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Simple Adapter used to submit runs through the shell.&quot;&quot;&quot;</span>
    <span class="n">QTYPE</span> <span class="o">=</span> <span class="s">&quot;shell&quot;</span>

    <span class="n">QTEMPLATE</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s">#!/bin/bash</span>
<span class="s">$${qverbatim}</span>
<span class="s">&quot;&quot;&quot;</span>

<div class="viewcode-block" id="ShellAdapter.cancel"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.qadapters.ShellAdapter.cancel">[docs]</a>    <span class="k">def</span> <span class="nf">cancel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_id</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&quot;kill -9 </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">job_id</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_submit_to_queue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">script_file</span><span class="p">):</span>
        <span class="c"># submit the job, return process and pid.</span>
        <span class="n">process</span> <span class="o">=</span> <span class="n">Popen</span><span class="p">((</span><span class="s">&quot;/bin/bash&quot;</span><span class="p">,</span> <span class="n">script_file</span><span class="p">),</span> <span class="n">stderr</span><span class="o">=</span><span class="n">PIPE</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">process</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span> <span class="n">process</span>

    <span class="k">def</span> <span class="nf">_get_njobs_in_queue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span>

<div class="viewcode-block" id="ShellAdapter.exclude_nodes"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.qadapters.ShellAdapter.exclude_nodes">[docs]</a>    <span class="k">def</span> <span class="nf">exclude_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nodes</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">False</span>

</div></div>
<div class="viewcode-block" id="SlurmAdapter"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.qadapters.SlurmAdapter">[docs]</a><span class="k">class</span> <span class="nc">SlurmAdapter</span><span class="p">(</span><span class="n">QueueAdapter</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Adapter for SLURM.&quot;&quot;&quot;</span>
    <span class="n">QTYPE</span> <span class="o">=</span> <span class="s">&quot;slurm&quot;</span>

    <span class="n">Job</span> <span class="o">=</span> <span class="n">SlurmJob</span>

    <span class="n">QTEMPLATE</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s">#!/bin/bash</span>

<span class="s">#SBATCH --partition=$${partition}</span>
<span class="s">#SBATCH --job-name=$${job_name}</span>
<span class="s">#SBATCH --nodes=$${nodes}</span>
<span class="s">#SBATCH --total_tasks=$${total_tasks}</span>
<span class="s">#SBATCH --ntasks=$${ntasks}</span>
<span class="s">#SBATCH --ntasks-per-node=$${ntasks_per_node}</span>
<span class="s">#SBATCH --cpus-per-task=$${cpus_per_task}</span>
<span class="s">#SBATCH --mem=$${mem}</span>
<span class="s">#SBATCH --mem-per-cpu=$${mem_per_cpu}</span>
<span class="s">#SBATCH --hint=$${hint}</span>
<span class="s">#SBATCH --time=$${time}</span>
<span class="s">#SBATCH	--exclude=$${exclude_nodes}</span>
<span class="s">#SBATCH --account=$${account}</span>
<span class="s">#SBATCH --mail-user=$${mail_user}</span>
<span class="s">#SBATCH --mail-type=$${mail_type}</span>
<span class="s">#SBATCH --constraint=$${constraint}</span>
<span class="s">#SBATCH --gres=$${gres}</span>
<span class="s">#SBATCH --requeue=$${requeue}</span>
<span class="s">#SBATCH --nodelist=$${nodelist}</span>
<span class="s">#SBATCH --propagate=$${propagate}</span>
<span class="s">#SBATCH --licenses=$${licenses}</span>
<span class="s">#SBATCH --output=$${_qout_path}</span>
<span class="s">#SBATCH --error=$${_qerr_path}</span>
<span class="s">$${qverbatim}</span>
<span class="s">&quot;&quot;&quot;</span>

<div class="viewcode-block" id="SlurmAdapter.set_qname"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.qadapters.SlurmAdapter.set_qname">[docs]</a>    <span class="k">def</span> <span class="nf">set_qname</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qname</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SlurmAdapter</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">set_qname</span><span class="p">(</span><span class="n">qname</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qparams</span><span class="p">[</span><span class="s">&quot;partition&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">qname</span>
</div>
<div class="viewcode-block" id="SlurmAdapter.set_mpi_procs"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.qadapters.SlurmAdapter.set_mpi_procs">[docs]</a>    <span class="k">def</span> <span class="nf">set_mpi_procs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mpi_procs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the number of CPUs used for MPI.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SlurmAdapter</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">set_mpi_procs</span><span class="p">(</span><span class="n">mpi_procs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qparams</span><span class="p">[</span><span class="s">&quot;ntasks&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mpi_procs</span>
</div>
<div class="viewcode-block" id="SlurmAdapter.set_omp_threads"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.qadapters.SlurmAdapter.set_omp_threads">[docs]</a>    <span class="k">def</span> <span class="nf">set_omp_threads</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">omp_threads</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SlurmAdapter</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">set_omp_threads</span><span class="p">(</span><span class="n">omp_threads</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qparams</span><span class="p">[</span><span class="s">&quot;cpus_per_task&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">omp_threads</span>
</div>
<div class="viewcode-block" id="SlurmAdapter.set_mem_per_proc"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.qadapters.SlurmAdapter.set_mem_per_proc">[docs]</a>    <span class="k">def</span> <span class="nf">set_mem_per_proc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mem_mb</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the memory per process in megabytes&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SlurmAdapter</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">set_mem_per_proc</span><span class="p">(</span><span class="n">mem_mb</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qparams</span><span class="p">[</span><span class="s">&quot;mem_per_cpu&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">mem_mb</span><span class="p">)</span>
        <span class="c"># Remove mem if it&#39;s defined.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qparams</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;mem&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="SlurmAdapter.set_timelimit"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.qadapters.SlurmAdapter.set_timelimit">[docs]</a>    <span class="k">def</span> <span class="nf">set_timelimit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timelimit</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SlurmAdapter</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">set_timelimit</span><span class="p">(</span><span class="n">timelimit</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qparams</span><span class="p">[</span><span class="s">&quot;time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time2slurm</span><span class="p">(</span><span class="n">timelimit</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="SlurmAdapter.cancel"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.qadapters.SlurmAdapter.cancel">[docs]</a>    <span class="k">def</span> <span class="nf">cancel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_id</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&quot;scancel </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">job_id</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="SlurmAdapter.optimize_params"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.qadapters.SlurmAdapter.optimize_params">[docs]</a>    <span class="k">def</span> <span class="nf">optimize_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{}</span>
        <span class="c">#dist = self.distribute(self.mpi_procs, self.omp_threads, self.mem_per_proc)</span>
        <span class="c">##print(dist)</span>

        <span class="c">#if False and dist.exact:</span>
        <span class="c">#    # Can optimize parameters</span>
        <span class="c">#    self.qparams[&quot;nodes&quot;] = dist.num_nodes</span>
        <span class="c">#    self.qparams.pop(&quot;ntasks&quot;, None)</span>
        <span class="c">#    self.qparams[&quot;ntasks_per_node&quot;] = dist.mpi_per_node</span>
        <span class="c">#    self.qparams[&quot;cpus_per_task&quot;] = self.omp_threads</span>
        <span class="c">#    self.qparams[&quot;mem&quot;] = dist.mpi_per_node * self.mem_per_proc</span>
        <span class="c">#    self.qparams.pop(&quot;mem_per_cpu&quot;, None)</span>
        <span class="c">#else:</span>
        <span class="c">#    # Delegate to slurm.</span>
        <span class="c">#    self.qparams[&quot;ntasks&quot;] = self.mpi_procs</span>
        <span class="c">#    self.qparams.pop(&quot;nodes&quot;, None)</span>
        <span class="c">#    self.qparams.pop(&quot;ntasks_per_node&quot;, None)</span>
        <span class="c">#    self.qparams[&quot;cpus_per_task&quot;] = self.omp_threads</span>
        <span class="c">#    self.qparams[&quot;mem_per_cpu&quot;] = self.mem_per_proc</span>
        <span class="c">#    self.qparams.pop(&quot;mem&quot;, None)</span>
        <span class="c">#return {}</span>
</div>
    <span class="k">def</span> <span class="nf">_submit_to_queue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">script_file</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Submit a job script to the queue.&quot;&quot;&quot;</span>
        <span class="n">process</span> <span class="o">=</span> <span class="n">Popen</span><span class="p">([</span><span class="s">&#39;sbatch&#39;</span><span class="p">,</span> <span class="n">script_file</span><span class="p">],</span> <span class="n">stdout</span><span class="o">=</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">PIPE</span><span class="p">)</span>
        <span class="n">process</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>

        <span class="c"># grab the returncode. SLURM returns 0 if the job was successful</span>
        <span class="n">queue_id</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">process</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c"># output should of the form &#39;2561553.sdb&#39; or &#39;352353.jessup&#39; - just grab the first part for job id</span>
                <span class="n">queue_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">3</span><span class="p">])</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Job submission was successful and queue_id is {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">queue_id</span><span class="p">))</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="c"># probably error parsing job code</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s">&#39;Could not parse job id following slurm...&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">queue_id</span><span class="p">,</span> <span class="n">process</span>

<div class="viewcode-block" id="SlurmAdapter.exclude_nodes"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.qadapters.SlurmAdapter.exclude_nodes">[docs]</a>    <span class="k">def</span> <span class="nf">exclude_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nodes</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="s">&#39;exclude_nodes&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">qparams</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">qparams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s">&#39;exclude_nodes&#39;</span><span class="p">:</span> <span class="s">&#39;node&#39;</span> <span class="o">+</span> <span class="n">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]})</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;excluded node </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">qparams</span><span class="p">[</span><span class="s">&#39;exclude_nodes&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s">&#39;,node&#39;</span> <span class="o">+</span> <span class="n">node</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;excluded node </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">node</span><span class="p">)</span>

            <span class="k">return</span> <span class="bp">True</span>

        <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">False</span>
</div>
    <span class="k">def</span> <span class="nf">_get_njobs_in_queue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">):</span>
        <span class="n">process</span> <span class="o">=</span> <span class="n">Popen</span><span class="p">([</span><span class="s">&#39;squeue&#39;</span><span class="p">,</span> <span class="s">&#39;-o &quot;</span><span class="si">%u</span><span class="s">&quot;&#39;</span><span class="p">,</span> <span class="s">&#39;-u&#39;</span><span class="p">,</span> <span class="n">username</span><span class="p">],</span> <span class="n">stdout</span><span class="o">=</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">PIPE</span><span class="p">)</span>
        <span class="n">process</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>

        <span class="n">njobs</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">process</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c"># parse the result. lines should have this form:</span>
            <span class="c"># username</span>
            <span class="c"># count lines that include the username in it</span>
            <span class="n">outs</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
            <span class="n">njobs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">outs</span> <span class="k">if</span> <span class="n">username</span> <span class="ow">in</span> <span class="n">line</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">njobs</span><span class="p">,</span> <span class="n">process</span>

</div>
<div class="viewcode-block" id="PbsProAdapter"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.qadapters.PbsProAdapter">[docs]</a><span class="k">class</span> <span class="nc">PbsProAdapter</span><span class="p">(</span><span class="n">QueueAdapter</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Adapter for PbsPro&quot;&quot;&quot;</span>
    <span class="n">QTYPE</span> <span class="o">=</span> <span class="s">&quot;pbspro&quot;</span>

<span class="c">#PBS -l select=$${select}:ncpus=$${ncpus}:vmem=$${vmem}mb:mpiprocs=$${mpiprocs}:ompthreads=$${ompthreads}</span>
<span class="c">#PBS -l select=$${select}:ncpus=1:vmem=$${vmem}mb:mpiprocs=1:ompthreads=$${ompthreads}</span>
<span class="c">####PBS -l select=$${select}:ncpus=$${ncpus}:vmem=$${vmem}mb:mpiprocs=$${mpiprocs}:ompthreads=$${ompthreads}</span>
<span class="c">####PBS -l pvmem=$${pvmem}mb</span>

    <span class="n">Job</span> <span class="o">=</span> <span class="n">PbsProJob</span>

    <span class="n">QTEMPLATE</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s">#!/bin/bash</span>

<span class="s">#PBS -q $${queue}</span>
<span class="s">#PBS -N $${job_name}</span>
<span class="s">#PBS -A $${account}</span>
<span class="s">#PBS -l select=$${select}</span>
<span class="s">#PBS -l walltime=$${walltime}</span>
<span class="s">#PBS -l model=$${model}</span>
<span class="s">#PBS -l place=$${place}</span>
<span class="s">#PBS -W group_list=$${group_list}</span>
<span class="s">#PBS -M $${mail_user}</span>
<span class="s">#PBS -m $${mail_type}</span>
<span class="s">#PBS -o $${_qout_path}</span>
<span class="s">#PBS -e $${_qerr_path}</span>
<span class="s">$${qverbatim}</span>
<span class="s">&quot;&quot;&quot;</span>

<div class="viewcode-block" id="PbsProAdapter.set_qname"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.qadapters.PbsProAdapter.set_qname">[docs]</a>    <span class="k">def</span> <span class="nf">set_qname</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qname</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">PbsProAdapter</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">set_qname</span><span class="p">(</span><span class="n">qname</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qparams</span><span class="p">[</span><span class="s">&quot;queue&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">qname</span>
</div>
<div class="viewcode-block" id="PbsProAdapter.set_timelimit"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.qadapters.PbsProAdapter.set_timelimit">[docs]</a>    <span class="k">def</span> <span class="nf">set_timelimit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timelimit</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">PbsProAdapter</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">set_timelimit</span><span class="p">(</span><span class="n">timelimit</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qparams</span><span class="p">[</span><span class="s">&quot;walltime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time2pbspro</span><span class="p">(</span><span class="n">timelimit</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="PbsProAdapter.set_mem_per_proc"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.qadapters.PbsProAdapter.set_mem_per_proc">[docs]</a>    <span class="k">def</span> <span class="nf">set_mem_per_proc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mem_mb</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the memory per process in megabytes&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">PbsProAdapter</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">set_mem_per_proc</span><span class="p">(</span><span class="n">mem_mb</span><span class="p">)</span>
        <span class="c">#self.qparams[&quot;pvmem&quot;] = int(mem_mb)</span>
        <span class="c">#self.qparams[&quot;vmem&quot;] = int(mem_mb)</span>
</div>
<div class="viewcode-block" id="PbsProAdapter.cancel"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.qadapters.PbsProAdapter.cancel">[docs]</a>    <span class="k">def</span> <span class="nf">cancel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_id</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&quot;qdel </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">job_id</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="PbsProAdapter.optimize_params"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.qadapters.PbsProAdapter.optimize_params">[docs]</a>    <span class="k">def</span> <span class="nf">optimize_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s">&quot;select&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_select</span><span class="p">()}</span>
</div>
<div class="viewcode-block" id="PbsProAdapter.get_select"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.qadapters.PbsProAdapter.get_select">[docs]</a>    <span class="k">def</span> <span class="nf">get_select</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ret_dict</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Select is not the most intuitive command. For more info see:</span>

<span class="sd">            * http://www.cardiff.ac.uk/arcca/services/equipment/User-Guide/pbs.html</span>
<span class="sd">            * https://portal.ivec.org/docs/Supercomputers/PBS_Pro</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">hw</span><span class="p">,</span> <span class="n">mem_per_proc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hw</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mem_per_proc</span><span class="p">)</span>
        <span class="c">#dist = self.distribute(self.mpi_procs, self.omp_threads, mem_per_proc)</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        if self.pure_mpi:</span>
<span class="sd">            num_nodes, rest_cores = hw.divmod_node(self.mpi_procs, self.omp_threads)</span>

<span class="sd">            if num_nodes == 0:</span>
<span class="sd">                logger.info(&quot;IN_CORE PURE MPI: %s&quot; % self.run_info)</span>
<span class="sd">                chunks = 1</span>
<span class="sd">                ncpus = rest_cores</span>
<span class="sd">                mpiprocs = rest_cores</span>
<span class="sd">                vmem = mem_per_proc * ncpus</span>
<span class="sd">                ompthreads = 1</span>

<span class="sd">            elif rest_cores == 0:</span>
<span class="sd">                # Can allocate entire nodes because self.mpi_procs is divisible by cores_per_node.</span>
<span class="sd">                logger.info(&quot;PURE MPI run commensurate with cores_per_node %s&quot; % self.run_info)</span>
<span class="sd">                chunks = num_nodes</span>
<span class="sd">                ncpus = hw.cores_per_node</span>
<span class="sd">                mpiprocs = hw.cores_per_node</span>
<span class="sd">                vmem = ncpus * mem_per_proc</span>
<span class="sd">                ompthreads = 1</span>

<span class="sd">            else:</span>
<span class="sd">                logger.info(&quot;OUT-OF-CORE PURE MPI (not commensurate with cores_per_node): %s&quot; % self.run_info)</span>
<span class="sd">                chunks = self.mpi_procs</span>
<span class="sd">                ncpus = 1</span>
<span class="sd">                mpiprocs = 1</span>
<span class="sd">                vmem = mem_per_proc</span>
<span class="sd">                ompthreads = 1</span>

<span class="sd">        elif self.pure_omp:</span>
<span class="sd">            # Pure OMP run.</span>
<span class="sd">            logger.info(&quot;PURE OPENMP run: %s&quot; % self.run_info)</span>
<span class="sd">            assert hw.can_use_omp_threads(self.omp_threads)</span>
<span class="sd">            chunks = 1</span>
<span class="sd">            ncpus = self.omp_threads</span>
<span class="sd">            mpiprocs = 1</span>
<span class="sd">            vmem = mem_per_proc</span>
<span class="sd">            ompthreads = self.omp_threads</span>

<span class="sd">        elif self.hybrid_mpi_omp:</span>
<span class="sd">            assert hw.can_use_omp_threads(self.omp_threads)</span>
<span class="sd">            num_nodes, rest_cores = hw.divmod_node(self.mpi_procs, self.omp_threads)</span>
<span class="sd">            #print(num_nodes, rest_cores)</span>
<span class="sd">            # TODO: test this</span>

<span class="sd">            if rest_cores == 0 or num_nodes == 0:  </span>
<span class="sd">                logger.info(&quot;HYBRID MPI-OPENMP run, perfectly divisible among nodes: %s&quot; % self.run_info)</span>
<span class="sd">                chunks = max(num_nodes, 1)</span>
<span class="sd">                mpiprocs = self.mpi_procs // chunks</span>

<span class="sd">                chunks = chunks</span>
<span class="sd">                ncpus = mpiprocs * self.omp_threads</span>
<span class="sd">                mpiprocs = mpiprocs</span>
<span class="sd">                vmem = mpiprocs * mem_per_proc </span>
<span class="sd">                ompthreads = self.omp_threads</span>

<span class="sd">            else:</span>
<span class="sd">                logger.info(&quot;HYBRID MPI-OPENMP, NOT commensurate with nodes: %s&quot; % self.run_info)</span>
<span class="sd">                chunks=self.mpi_procs</span>
<span class="sd">                ncpus=self.omp_threads</span>
<span class="sd">                mpiprocs=1</span>
<span class="sd">                vmem= mem_per_proc</span>
<span class="sd">                ompthreads=self.omp_threads</span>

<span class="sd">        else:</span>
<span class="sd">            raise RuntimeError(&quot;You should not be here&quot;)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_omp</span><span class="p">:</span>
            <span class="n">chunks</span><span class="p">,</span> <span class="n">ncpus</span><span class="p">,</span> <span class="n">vmem</span><span class="p">,</span> <span class="n">mpiprocs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mpi_procs</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mem_per_proc</span><span class="p">,</span> <span class="mi">1</span>
            <span class="n">select_params</span> <span class="o">=</span> <span class="n">AttrDict</span><span class="p">(</span><span class="n">chunks</span><span class="o">=</span><span class="n">chunks</span><span class="p">,</span> <span class="n">ncpus</span><span class="o">=</span><span class="n">ncpus</span><span class="p">,</span> <span class="n">mpiprocs</span><span class="o">=</span><span class="n">mpiprocs</span><span class="p">,</span> <span class="n">vmem</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">vmem</span><span class="p">))</span>
            <span class="n">s</span> <span class="o">=</span> <span class="s">&quot;{chunks}:ncpus={ncpus}:vmem={vmem}mb:mpiprocs={mpiprocs}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">select_params</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">chunks</span><span class="p">,</span> <span class="n">ncpus</span><span class="p">,</span> <span class="n">vmem</span><span class="p">,</span> <span class="n">mpiprocs</span><span class="p">,</span> <span class="n">ompthreads</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mpi_procs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">omp_threads</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mem_per_proc</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">omp_threads</span>
            <span class="n">select_params</span> <span class="o">=</span> <span class="n">AttrDict</span><span class="p">(</span><span class="n">chunks</span><span class="o">=</span><span class="n">chunks</span><span class="p">,</span> <span class="n">ncpus</span><span class="o">=</span><span class="n">ncpus</span><span class="p">,</span> <span class="n">mpiprocs</span><span class="o">=</span><span class="n">mpiprocs</span><span class="p">,</span> <span class="n">vmem</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">vmem</span><span class="p">),</span> <span class="n">ompthreads</span><span class="o">=</span><span class="n">ompthreads</span><span class="p">)</span>
            <span class="n">s</span> <span class="o">=</span> <span class="s">&quot;{chunks}:ncpus={ncpus}:vmem={vmem}mb:mpiprocs={mpiprocs}:ompthreads={ompthreads}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">select_params</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ret_dict</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">s</span><span class="p">,</span> <span class="n">select_params</span>
        <span class="k">return</span> <span class="n">s</span>
</div>
    <span class="k">def</span> <span class="nf">_submit_to_queue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">script_file</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Submit a job script to the queue.&quot;&quot;&quot;</span>
        <span class="n">process</span> <span class="o">=</span> <span class="n">Popen</span><span class="p">([</span><span class="s">&#39;qsub&#39;</span><span class="p">,</span> <span class="n">script_file</span><span class="p">],</span> <span class="n">stdout</span><span class="o">=</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">PIPE</span><span class="p">)</span>
        <span class="n">process</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>

        <span class="c"># grab the return code. PBS returns 0 if the job was successful</span>
        <span class="n">queue_id</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">process</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c"># output should of the form &#39;2561553.sdb&#39; or &#39;352353.jessup&#39; - just grab the first part for job id</span>
                <span class="n">queue_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="c"># probably error parsing job code</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s">&quot;Could not parse job id following qsub...&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">queue_id</span><span class="p">,</span> <span class="n">process</span> 

    <span class="k">def</span> <span class="nf">_get_njobs_in_queue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">):</span>
        <span class="n">process</span> <span class="o">=</span> <span class="n">Popen</span><span class="p">([</span><span class="s">&#39;qstat&#39;</span><span class="p">,</span> <span class="s">&#39;-a&#39;</span><span class="p">,</span> <span class="s">&#39;-u&#39;</span><span class="p">,</span> <span class="n">username</span><span class="p">],</span> <span class="n">stdout</span><span class="o">=</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">PIPE</span><span class="p">)</span>
        <span class="n">process</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>

        <span class="n">njobs</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">process</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c"># parse the result</span>
            <span class="c"># lines should have this form</span>
            <span class="c"># &#39;1339044.sdb          username  queuename    2012-02-29-16-43  20460   --   --    --  00:20 C 00:09&#39;</span>
            <span class="c"># count lines that include the username in it</span>

            <span class="c"># TODO: only count running or queued jobs. or rather, *don&#39;t* count jobs that are &#39;C&#39;.</span>
            <span class="n">outs</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
            <span class="n">njobs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">outs</span> <span class="k">if</span> <span class="n">username</span> <span class="ow">in</span> <span class="n">line</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">njobs</span><span class="p">,</span> <span class="n">process</span>

<div class="viewcode-block" id="PbsProAdapter.exclude_nodes"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.qadapters.PbsProAdapter.exclude_nodes">[docs]</a>    <span class="k">def</span> <span class="nf">exclude_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nodes</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;exluding nodes, not implemented yet in pbs&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">False</span>

</div></div>
<div class="viewcode-block" id="TorqueAdapter"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.qadapters.TorqueAdapter">[docs]</a><span class="k">class</span> <span class="nc">TorqueAdapter</span><span class="p">(</span><span class="n">PbsProAdapter</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Adapter for Torque.&quot;&quot;&quot;</span>
    <span class="n">QTYPE</span> <span class="o">=</span> <span class="s">&quot;torque&quot;</span>

    <span class="n">QTEMPLATE</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s">#!/bin/bash</span>

<span class="s">#PBS -q $${queue}</span>
<span class="s">#PBS -N $${job_name}</span>
<span class="s">#PBS -A $${account}</span>
<span class="s">#PBS -l pmem=$${pmem}mb</span>
<span class="s">####PBS -l mppwidth=$${mppwidth}</span>
<span class="s">#PBS -l nodes=$${nodes}:ppn=$${ppn} </span>
<span class="s">#PBS -l walltime=$${walltime}</span>
<span class="s">#PBS -l model=$${model}</span>
<span class="s">#PBS -l place=$${place}</span>
<span class="s">#PBS -W group_list=$${group_list}</span>
<span class="s">#PBS -M $${mail_user}</span>
<span class="s">#PBS -m $${mail_type}</span>
<span class="s"># Submission environment</span>
<span class="s">#PBS -V</span>
<span class="s">#PBS -o $${_qout_path}</span>
<span class="s">#PBS -e $${_qerr_path}</span>
<span class="s">$${qverbatim}</span>
<span class="s">&quot;&quot;&quot;</span>

<div class="viewcode-block" id="TorqueAdapter.set_mem_per_proc"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.qadapters.TorqueAdapter.set_mem_per_proc">[docs]</a>    <span class="k">def</span> <span class="nf">set_mem_per_proc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mem_mb</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the memory per process in megabytes&quot;&quot;&quot;</span>
        <span class="n">QueueAdapter</span><span class="o">.</span><span class="n">set_mem_per_proc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mem_mb</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qparams</span><span class="p">[</span><span class="s">&quot;pmem&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mem_mb</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qparams</span><span class="p">[</span><span class="s">&quot;mem&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mem_mb</span>
</div>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">mpi_procs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Number of MPI processes.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">qparams</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;nodes&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">qparams</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;ppn&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<div class="viewcode-block" id="TorqueAdapter.set_mpi_procs"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.qadapters.TorqueAdapter.set_mpi_procs">[docs]</a>    <span class="k">def</span> <span class="nf">set_mpi_procs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mpi_procs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the number of CPUs used for MPI.&quot;&quot;&quot;</span>
        <span class="n">QueueAdapter</span><span class="o">.</span><span class="n">set_mpi_procs</span><span class="p">(</span><span class="n">mpi_procs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qparams</span><span class="p">[</span><span class="s">&quot;nodes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qparams</span><span class="p">[</span><span class="s">&quot;ppn&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mpi_procs</span>

</div></div>
<div class="viewcode-block" id="SGEAdapter"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.qadapters.SGEAdapter">[docs]</a><span class="k">class</span> <span class="nc">SGEAdapter</span><span class="p">(</span><span class="n">QueueAdapter</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Adapter for Sun Grid Engine (SGE) task submission software.</span>

<span class="sd">    See also:</span>

<span class="sd">        * https://www.wiki.ed.ac.uk/display/EaStCHEMresearchwiki/How+to+write+a+SGE+job+submission+script</span>
<span class="sd">        * http://www.uibk.ac.at/zid/systeme/hpc-systeme/common/tutorials/sge-howto.html</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">QTYPE</span> <span class="o">=</span> <span class="s">&quot;sge&quot;</span>

    <span class="n">Job</span> <span class="o">=</span> <span class="n">SgeJob</span>

    <span class="n">QTEMPLATE</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s">#!/bin/bash</span>

<span class="s">#$ -account_name $${account_name}</span>
<span class="s">#$ -N $${job_name}</span>
<span class="s">#$ -q $${queue_name}</span>
<span class="s">#$ -pe $${parallel_environment} $${ncpus}</span>
<span class="s">#$ -l h_rt=$${walltime}</span>
<span class="s"># request a per slot memory limit of size bytes. </span>
<span class="s">##$ -l h_vmem=$${mem_per_slot}  </span>
<span class="s">##$ -l mf=$${mem_per_slot}  </span>
<span class="s">###$ -j no</span>
<span class="s">#$ -M $${mail_user}</span>
<span class="s">#$ -m $${mail_type}</span>
<span class="s"># Submission environment</span>
<span class="s">##$ -S /bin/bash</span>
<span class="s">###$ -cwd                       # Change to current working directory</span>
<span class="s">###$ -V                         # Export environment variables into script</span>
<span class="s">#$ -e $${_qerr_path}</span>
<span class="s">#$ -o $${_qout_path}</span>
<span class="s">$${qverbatim}</span>
<span class="s">&quot;&quot;&quot;</span>
<div class="viewcode-block" id="SGEAdapter.set_qname"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.qadapters.SGEAdapter.set_qname">[docs]</a>    <span class="k">def</span> <span class="nf">set_qname</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qname</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SGEAdapter</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">set_qname</span><span class="p">(</span><span class="n">qname</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qparams</span><span class="p">[</span><span class="s">&quot;queue_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">qname</span>
</div>
<div class="viewcode-block" id="SGEAdapter.set_mpi_procs"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.qadapters.SGEAdapter.set_mpi_procs">[docs]</a>    <span class="k">def</span> <span class="nf">set_mpi_procs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mpi_procs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the number of CPUs used for MPI.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SGEAdapter</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">set_mpi_procs</span><span class="p">(</span><span class="n">mpi_procs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qparams</span><span class="p">[</span><span class="s">&quot;ncpus&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mpi_procs</span>
</div>
<div class="viewcode-block" id="SGEAdapter.set_omp_threads"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.qadapters.SGEAdapter.set_omp_threads">[docs]</a>    <span class="k">def</span> <span class="nf">set_omp_threads</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">omp_threads</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SGEAdapter</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">set_omp_threads</span><span class="p">(</span><span class="n">omp_threads</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&quot;Cannot use omp_threads with SGE&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="SGEAdapter.set_mem_per_proc"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.qadapters.SGEAdapter.set_mem_per_proc">[docs]</a>    <span class="k">def</span> <span class="nf">set_mem_per_proc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mem_mb</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the memory per process in megabytes&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SGEAdapter</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">set_mem_per_proc</span><span class="p">(</span><span class="n">mem_mb</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qparams</span><span class="p">[</span><span class="s">&quot;mem_per_slot&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">mem_mb</span><span class="p">))</span> <span class="o">+</span> <span class="s">&quot;M&quot;</span>
</div>
<div class="viewcode-block" id="SGEAdapter.set_timelimit"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.qadapters.SGEAdapter.set_timelimit">[docs]</a>    <span class="k">def</span> <span class="nf">set_timelimit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timelimit</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SGEAdapter</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">set_timelimit</span><span class="p">(</span><span class="n">timelimit</span><span class="p">)</span>
        <span class="c"># Same convention as pbspro e.g. [hours:minutes:]seconds</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qparams</span><span class="p">[</span><span class="s">&quot;walltime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time2pbspro</span><span class="p">(</span><span class="n">timelimit</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="SGEAdapter.cancel"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.qadapters.SGEAdapter.cancel">[docs]</a>    <span class="k">def</span> <span class="nf">cancel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_id</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&quot;qdel </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">job_id</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_submit_to_queue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">script_file</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Submit a job script to the queue.&quot;&quot;&quot;</span>
        <span class="n">process</span> <span class="o">=</span> <span class="n">Popen</span><span class="p">([</span><span class="s">&#39;qsub&#39;</span><span class="p">,</span> <span class="n">script_file</span><span class="p">],</span> <span class="n">stdout</span><span class="o">=</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">PIPE</span><span class="p">)</span>
        <span class="n">process</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>

        <span class="c"># grab the returncode. SGE returns 0 if the job was successful</span>
        <span class="n">queue_id</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">process</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c"># output should of the form </span>
                <span class="c"># Your job 1659048 (&quot;NAME_OF_JOB&quot;) has been submitted </span>
                <span class="n">queue_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="c"># probably error parsing job code</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s">&quot;Could not parse job id following qsub...&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">queue_id</span><span class="p">,</span> <span class="n">process</span>

<div class="viewcode-block" id="SGEAdapter.exclude_nodes"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.qadapters.SGEAdapter.exclude_nodes">[docs]</a>    <span class="k">def</span> <span class="nf">exclude_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nodes</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Method to exclude nodes in the calculation&quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;exluding nodes, not implemented yet in SGE&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">False</span>
</div>
    <span class="k">def</span> <span class="nf">_get_njobs_in_queue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">):</span>
        <span class="n">process</span> <span class="o">=</span> <span class="n">Popen</span><span class="p">([</span><span class="s">&#39;qstat&#39;</span><span class="p">,</span> <span class="s">&#39;-u&#39;</span><span class="p">,</span> <span class="n">username</span><span class="p">],</span> <span class="n">stdout</span><span class="o">=</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">PIPE</span><span class="p">)</span>
        <span class="n">process</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>

        <span class="n">njobs</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">process</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c"># parse the result</span>
            <span class="c"># lines should contain username</span>
            <span class="c"># count lines that include the username in it</span>

            <span class="c"># TODO: only count running or queued jobs. or rather, *don&#39;t* count jobs that are &#39;C&#39;.</span>
            <span class="n">outs</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
            <span class="n">njobs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">outs</span> <span class="k">if</span> <span class="n">username</span> <span class="ow">in</span> <span class="n">line</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">njobs</span><span class="p">,</span> <span class="n">process</span>

</div>
<div class="viewcode-block" id="MOABAdapter"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.qadapters.MOABAdapter">[docs]</a><span class="k">class</span> <span class="nc">MOABAdapter</span><span class="p">(</span><span class="n">QueueAdapter</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Adapter for MOAB. See https://computing.llnl.gov/tutorials/moab/&quot;&quot;&quot;</span>
    <span class="n">QTYPE</span> <span class="o">=</span> <span class="s">&quot;moab&quot;</span>

    <span class="n">QTEMPLATE</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s">#!/bin/bash</span>

<span class="s">#MSUB -a $${eligible_date}</span>
<span class="s">#MSUB -A $${account}</span>
<span class="s">#MSUB -c $${checkpoint_interval}</span>
<span class="s">#MSUB -l feature=$${feature}</span>
<span class="s">#MSUB -l gres=$${gres}</span>
<span class="s">#MSUB -l nodes=$${nodes}</span>
<span class="s">#MSUB -l partition=$${partition}</span>
<span class="s">#MSUB -l procs=$${procs}</span>
<span class="s">#MSUB -l ttc=$${ttc}</span>
<span class="s">#MSUB -l walltime=$${walltime}</span>
<span class="s">#MSUB -l $${resources}</span>
<span class="s">#MSUB -p $${priority}</span>
<span class="s">#MSUB -q $${queue}</span>
<span class="s">#MSUB -S $${shell}</span>
<span class="s">#MSUB -N $${job_name}</span>
<span class="s">#MSUB -v $${variable_list}</span>

<span class="s">#MSUB -o $${_qout_path}</span>
<span class="s">#MSUB -e $${_qerr_path}</span>
<span class="s">$${qverbatim}</span>
<span class="s">&quot;&quot;&quot;</span>

<div class="viewcode-block" id="MOABAdapter.set_mpi_procs"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.qadapters.MOABAdapter.set_mpi_procs">[docs]</a>    <span class="k">def</span> <span class="nf">set_mpi_procs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mpi_procs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the number of CPUs used for MPI.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MOABAdapter</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">set_mpi_procs</span><span class="p">(</span><span class="n">mpi_procs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qparams</span><span class="p">[</span><span class="s">&quot;procs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mpi_procs</span>
</div>
<div class="viewcode-block" id="MOABAdapter.set_timelimit"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.qadapters.MOABAdapter.set_timelimit">[docs]</a>    <span class="k">def</span> <span class="nf">set_timelimit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timelimit</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MOABAdapter</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">set_timelimit</span><span class="p">(</span><span class="n">timelimit</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qparams</span><span class="p">[</span><span class="s">&quot;walltime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time2slurm</span><span class="p">(</span><span class="n">timelimit</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="MOABAdapter.set_mem_per_proc"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.qadapters.MOABAdapter.set_mem_per_proc">[docs]</a>    <span class="k">def</span> <span class="nf">set_mem_per_proc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mem_mb</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MOABAdapter</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">set_mem_per_proc</span><span class="p">(</span><span class="n">mem_mb</span><span class="p">)</span>
        <span class="c">#TODO</span>
        <span class="c">#raise NotImplementedError(&quot;set_mem_per_cpu&quot;)</span>
</div>
<div class="viewcode-block" id="MOABAdapter.exclude_nodes"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.qadapters.MOABAdapter.exclude_nodes">[docs]</a>    <span class="k">def</span> <span class="nf">exclude_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nodes</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;exluding nodes, not implemented yet in MOAB&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">False</span>
</div>
<div class="viewcode-block" id="MOABAdapter.cancel"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.qadapters.MOABAdapter.cancel">[docs]</a>    <span class="k">def</span> <span class="nf">cancel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_id</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&quot;canceljob </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">job_id</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_submit_to_queue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">script_file</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Submit a job script to the queue.&quot;&quot;&quot;</span>
        <span class="n">process</span> <span class="o">=</span> <span class="n">Popen</span><span class="p">([</span><span class="s">&#39;msub&#39;</span><span class="p">,</span> <span class="n">script_file</span><span class="p">],</span> <span class="n">stdout</span><span class="o">=</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">PIPE</span><span class="p">)</span>
        <span class="n">process</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>

        <span class="n">queue_id</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">process</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c"># grab the returncode. MOAB returns 0 if the job was successful</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c"># output should be the queue_id</span>
                <span class="n">queue_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="c"># probably error parsing job code</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s">&#39;Could not parse job id following msub...&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">queue_id</span><span class="p">,</span> <span class="n">process</span>

    <span class="k">def</span> <span class="nf">_get_njobs_in_queue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">):</span>
        <span class="n">process</span> <span class="o">=</span> <span class="n">Popen</span><span class="p">([</span><span class="s">&#39;showq&#39;</span><span class="p">,</span> <span class="s">&#39;-s -u&#39;</span><span class="p">,</span> <span class="n">username</span><span class="p">],</span> <span class="n">stdout</span><span class="o">=</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">PIPE</span><span class="p">)</span>
        <span class="n">process</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>

        <span class="n">njobs</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">process</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c"># parse the result</span>
            <span class="c"># lines should have this form:</span>
            <span class="c">## </span>
            <span class="c">## active jobs: N  eligible jobs: M  blocked jobs: P</span>
            <span class="c">##</span>
            <span class="c">## Total job:  1</span>
            <span class="c">##</span>
            <span class="c"># Split the output string and return the last element.</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">readlines</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">njobs</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">njobs</span><span class="p">,</span> <span class="n">process</span>

</div>
<div class="viewcode-block" id="QScriptTemplate"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.qadapters.QScriptTemplate">[docs]</a><span class="k">class</span> <span class="nc">QScriptTemplate</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">Template</span><span class="p">):</span>
    <span class="n">delimiter</span> <span class="o">=</span> <span class="s">&#39;$$&#39;</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../index.html">pymatgen 3.1.3 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>

    <div class="footer" role="contentinfo">
        &copy; Copyright 2011, Shyue Ping Ong, Anubhav Jain, Geoffroy Hautier, William Davidson Richard, Stephen Dacek, Sai Jayaraman, Michael Kocher, Dan Gunter, Shreyas Cholia, Vincent L Chevrier, Rickard Armiento.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.1.
    </div>
<div class="footer">This page uses <a href="http://analytics.google.com/">
Google Analytics</a> to collect statistics. You can disable it by blocking
the JavaScript coming from www.google-analytics.com.
<script type="text/javascript">
  (function() {
    var ga = document.createElement('script');
    ga.src = ('https:' == document.location.protocol ?
              'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    ga.setAttribute('async', 'true');
    document.documentElement.firstChild.appendChild(ga);
  })();
</script>
</div>

  </body>
</html>